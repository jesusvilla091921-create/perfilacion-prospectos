<!DOCTYPE html>
<html lang="es" class="h-full bg-white">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MADA ¬∑ Promotor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#dc2626">
  <style>
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .glass{backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
    .btn-disabled{opacity:.6;pointer-events:none}
  </style>
</head>
<body class="h-full text-red-900 bg-white">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-red-800 to-red-600 text-white">
      <div class="max-w-7xl mx-auto px-4 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-white flex items-center justify-center font-bold text-red-700 border border-red-200" aria-label="Logo MADA">M</div>
          <div>
            <h1 class="text-xl font-semibold tracking-wide">MADA ¬∑ Portabilidad</h1>
            <p class="text-white/80 text-sm">Flujo de perfilaci√≥n y captura</p>
          </div>
        </div>
        <div id="netStatus" class="text-xs">‚Ä¢</div>
      </div>
    </header>

    <main class="flex-1">
      <div class="max-w-7xl mx-auto px-4 py-6 lg:py-10 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Col principal -->
        <section class="lg:col-span-2 space-y-6">
          <!-- Portada -->
          <div id="portada" class="rounded-2xl bg-white shadow-sm p-6 border border-red-100">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <h2 class="text-2xl font-semibold text-red-900">Bienvenido</h2>
                <p class="text-red-700/80 mt-1">Elige c√≥mo quieres empezar.</p>
              </div>
            </div>
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
              <button id="btnStartSurvey" class="w-full rounded-xl bg-red-700 text-white py-4 px-5 font-medium hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-400">Comenzar encuesta</button>
              <button id="btnGoCapture" class="w-full rounded-xl bg-white border border-red-200 py-4 px-5 font-medium hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-300">Ir a ficha</button>
              <button id="btnGoActivar" class="w-full rounded-xl bg-white border border-red-200 py-4 px-5 font-medium hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-300">Activar chip</button>
            </div>
          </div>

          <!-- Encuesta -->
          <div id="encuestaCard" class="hidden rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white">
              <h3 class="text-lg font-semibold">Diagn√≥stico r√°pido</h3>
              <p class="text-white/80 text-sm">Selecciona la compa√±√≠a y responde 3‚Äì4 preguntas.</p>
            </div>
            <div class="p-6 space-y-6">
              <div id="notaTelcel" class="hidden border border-rose-200 rounded-xl p-4 bg-rose-50 text-rose-900">Cliente Telcel actual: derivar a upsell/recargas. No aplica diagn√≥stico.</div>
              <div class="space-y-2">
                <label class="block text-sm font-medium text-red-900">Compa√±√≠a objetivo (opcional)</label>
                <div class="flex flex-wrap gap-2" id="companyButtons"></div>
              </div>
              <div id="surveyQuestions" class="hidden space-y-4"></div>
              <div id="surveyResult" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="rounded-xl border border-red-200 p-4">
                  <div class="text-sm text-red-700">Score de severidad</div>
                  <div id="scoreValue" class="text-3xl font-semibold mt-1">0.00</div>
                </div>
                <div class="rounded-xl border border-red-200 p-4 md:col-span-2">
                  <div class="text-sm text-red-700">Pitch sugerido</div>
                  <div id="pitchValue" class="mt-1 font-medium">‚Äî</div>
                </div>
                <div class="rounded-xl border border-red-200 p-4 md:col-span-3">
                  <div class="text-sm text-red-700">Recomendaci√≥n de plan</div>
                  <div id="planValue" class="mt-1 font-semibold text-red-900">‚Äî</div>
                </div>
              </div>
              <div class="flex flex-wrap gap-3">
                <button id="btnAceptaCambio" class="hidden rounded-xl bg-red-700 text-white py-2.5 px-4 hover:bg-red-800">Acept√≥ cambio</button>
                <button id="btnNoAcepta" class="hidden rounded-xl bg-white border border-red-200 py-2.5 px-4 hover:bg-red-50">No acept√≥</button>
                <button id="btnIrFicha" class="hidden rounded-xl bg-white border border-red-200 py-2.5 px-4 hover:bg-red-50">Ir a ficha</button>
              </div>
            </div>
          </div>

          <!-- Ficha de captura -->
          <div id="fichaCard" class="hidden rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold">Ficha de captura</h3>
                <p class="text-white/80 text-sm">Valida los campos antes de crear la ficha.</p>
              </div>
              <div id="netStatus2" class="text-xs">‚Ä¢</div>
            </div>
            <form id="captureForm" class="p-6 space-y-6" autocomplete="off">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label for="plaza" class="block text-sm font-medium text-red-900">Plaza <span class="text-red-600">*</span></label>
                  <select id="plaza" required class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" aria-required="true">
                    <option value="">Selecciona</option>
                    <option>MONTERREY</option><option>MANTE</option><option>REYNOSA</option><option>MATAMOROS</option><option>SALTILLO</option><option>CHIHUAHUA</option><option>DELICIAS</option><option>CUAHUTEMOC</option><option>TAMPICO</option>
                  </select>
                </div>
                <div>
                  <label for="carrier" class="block text-sm font-medium text-red-900">Compa√±√≠a actual (opcional)</label>
                  <select id="carrier" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400">
                    <option value="">Selecciona</option>
                    <option>Telcel</option><option>Movistar</option><option>AT&T</option><option>Unefon</option><option>Bait</option><option>OXXO Cel</option><option>Virgin</option><option>Rincel</option>
                  </select>
                </div>
                <div>
                  <label for="promotor" class="block text-sm font-medium text-red-900">Promotor <span class="text-red-600">*</span></label>
                  <input id="promotor" type="text" required class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" placeholder="Nombre del promotor">
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="nombreCompleto" class="block text-sm font-medium text-red-900">Nombre completo (opcional)</label>
                  <input id="nombreCompleto" type="text" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" placeholder="Nombre y apellidos">
                </div>
                <div>
                  <label for="telefono" class="block text-sm font-medium text-red-900">Tel√©fono (10 d√≠gitos) <span class="text-red-600">*</span></label>
                  <input id="telefono" inputmode="numeric" pattern="[0-9]*" maxlength="10" required class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" placeholder="Ej. 8112345678">
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label for="fechaNacimiento" class="block text-sm font-medium text-red-900">Fecha de nacimiento (opcional)</label>
                  <input id="fechaNacimiento" type="date" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400">
                </div>
                <div class="md:col-span-2">
                  <label for="estadoNacimiento" class="block text-sm font-medium text-red-900">Estado de nacimiento (opcional)</label>
                  <select id="estadoNacimiento" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400">
                    <option value="">Selecciona</option>
                    <option>Aguascalientes</option><option>Baja California</option><option>Baja California Sur</option><option>Campeche</option><option>Coahuila</option><option>Colima</option><option>Chiapas</option><option>Chihuahua</option><option>Ciudad de M√©xico</option><option>Durango</option><option>Guanajuato</option><option>Guerrero</option><option>Hidalgo</option><option>Jalisco</option><option>M√©xico</option><option>Michoac√°n</option><option>Morelos</option><option>Nayarit</option><option>Nuevo Le√≥n</option><option>Oaxaca</option><option>Puebla</option><option>Quer√©taro</option><option>Quintana Roo</option><option>San Luis Potos√≠</option><option>Sinaloa</option><option>Sonora</option><option>Tabasco</option><option>Tamaulipas</option><option>Tlaxcala</option><option>Veracruz</option><option>Yucat√°n</option><option>Zacatecas</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label for="curp" class="block text-sm font-medium text-red-900">CURP (opcional)</label>
                  <input id="curp" type="text" maxlength="18" pattern="[A-Z0-9]{18}" title="CURP de 18 caracteres alfanum√©ricos en may√∫sculas" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" placeholder="En may√∫sculas">
                </div>
                <div>
                  <label for="icc" class="block text-sm font-medium text-red-900">ICC (19 d√≠gitos) <span class="text-red-600">*</span></label>
                  <div class="flex gap-2">
                    <input id="icc" inputmode="numeric" pattern="[0-9]*" maxlength="19" required class="mt-1 flex-1 rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" placeholder="Escan√©alo o escr√≠belo">
                    <button type="button" id="btnScanICC" class="mt-1 rounded-xl border border-red-200 px-3 text-sm hover:bg-red-50" aria-label="Escanear ICC">Escanear</button>
                  </div>
                  <p id="iccHint" class="text-xs text-red-600 mt-1 hidden">ICC inv√°lido (Luhn). Rev√≠salo o intenta de nuevo.</p>
                </div>
                <div>
                  <label for="nip" class="block text-sm font-medium text-red-900">NIP (4 d√≠gitos) <span class="text-red-600">*</span></label>
                  <input id="nip" inputmode="numeric" pattern="[0-9]*" maxlength="4" required class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" placeholder="Ej. 1234">
                </div>
              </div>
              <input id="estatus" type="hidden" value="Portabilidad iniciada" />
              <div class="pt-2 flex items-center gap-3">
                <button id="btnCrearFicha" type="submit" class="rounded-xl bg-red-700 text-white py-3 px-6 font-medium hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-400 flex items-center gap-2">
                  <svg id="btnSpinner" class="hidden animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
                  <span>Crear ficha</span>
                </button>
                <button type="button" id="btnBackHome" class="rounded-xl bg-white border border-red-200 py-3 px-6 font-medium hover:bg-red-50">Volver</button>
              </div>
              <p id="dupWarn" class="hidden text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-xl p-3 mt-3">Este tel√©fono o ICC ya existe en los √∫ltimos registros locales. Verifica antes de continuar.</p>
            </form>
          </div>

          <!-- Activar Chip (Azul/Blanco) -->
          <div id="activarCard" class="hidden rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold">Activar chip</h3>
                <p class="text-white/80 text-sm">El ICC es opcional. Selecciona tipo.</p>
              </div>
            </div>
            <form id="activarForm" class="p-6 space-y-6" autocomplete="off">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-red-900">Tipo de chip</label>
                  <div class="mt-1 flex gap-3">
                    <label class="flex items-center gap-2"><input type="radio" name="tipoChip" value="Azul" checked> <span>Azul</span></label>
                    <label class="flex items-center gap-2"><input type="radio" name="tipoChip" value="Blanco"> <span>Blanco</span></label>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-red-900">Promotor <span class="text-red-600">*</span></label>
                  <input id="aPromotor" type="text" required class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" placeholder="Nombre del promotor">
                </div>
                <div>
                  <label class="block text-sm font-medium text-red-900">ICC (opcional)</label>
                  <div class="flex gap-2">
                    <input id="aICC" inputmode="numeric" pattern="[0-9]*" maxlength="19" class="mt-1 flex-1 rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" placeholder="Escan√©alo o escr√≠belo">
                    <button type="button" id="btnScanICC2" class="mt-1 rounded-xl border border-red-200 px-3 text-sm hover:bg-red-50">Escanear</button>
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-red-900">N√∫mero telef√≥nico <span class="text-red-600">*</span></label>
                  <input id="aNumero" inputmode="numeric" maxlength="10" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" placeholder="10 d√≠gitos">
                </div>
                <div>
                  <label class="block text-sm font-medium text-red-900">Monto de recarga ($) <span class="text-red-600">*</span></label>
                  <input id="aMonto" inputmode="numeric" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" placeholder="Ej. 50">
                </div>
                <div class="flex items-end">
                  <button id="btnRegistrarAct" type="submit" class="w-full rounded-xl bg-red-700 text-white py-3 px-6 font-medium hover:bg-red-800">Registrar</button>
                </div>
              </div>
            </form>
            <div class="px-6 pb-6">
              <div class="rounded-xl border border-red-200 overflow-hidden">
                <table class="min-w-full text-sm">
                  <thead class="bg-red-50">
                    <tr><th class="px-3 py-2 text-left">Fecha</th><th class="px-3 py-2 text-left">Promotor</th><th class="px-3 py-2 text-left">Tipo</th><th class="px-3 py-2 text-left">N√∫mero</th><th class="px-3 py-2 text-left">ICC</th><th class="px-3 py-2 text-right">Monto</th></tr>
                  </thead>
                  <tbody id="actsBody"></tbody>
                </table>
              </div>
              <div class="mt-3 flex gap-2">
                <button id="btnExportActs" class="rounded-xl bg-white border border-red-200 px-4 py-2">Exportar CSV</button>
                <button id="btnClearActs" class="rounded-xl bg-white border border-red-200 px-4 py-2">Limpiar lista local</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Panel lateral -->
        <aside class="lg:col-span-1">
          <div class="rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white">
              <h3 class="text-lg font-semibold">Leads capturados (local)</h3>
              <p class="text-white/80 text-sm">√öltimos 12 registros</p>
            </div>
            <div id="leadsList" class="p-4 divide-y divide-red-100" aria-live="polite">
              <div class="text-red-700/80 text-sm">Sin registros todav√≠a.</div>
            </div>
            <div class="p-4 flex gap-2">
              <button id="btnClearLeads" class="w-full rounded-xl bg-white border border-red-200 py-2.5 px-4 text-sm hover:bg-red-50">Limpiar lista local</button>
              <button id="btnExportLeads" class="w-full rounded-xl bg-white border border-red-200 py-2.5 px-4 text-sm hover:bg-red-50">Exportar CSV</button>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Modal Ticket -->
  <div id="ticketOverlay" class="hidden fixed inset-0 bg-red-900/40 glass flex items-center justify-center p-4 z-50">
    <div class="w-full max-w-lg rounded-2xl overflow-hidden shadow-xl" role="dialog" aria-modal="true" aria-labelledby="ticketTitle">
      <div class="p-5 bg-gradient-to-r from-red-800 to-red-600 text-white">
        <h3 id="ticketTitle" class="text-lg font-semibold">Ficha creada</h3>
        <p class="text-white/80 text-sm">Toca para copiar cualquier dato.</p>
      </div>
      <div class="bg-white p-6 space-y-3">
        <button type="button" class="w-full text-left" data-copy="tkn_tel_nip">
          <div class="flex items-center justify-between">
            <div class="text-sm text-red-700">N√∫mero ‚Ä¢ NIP</div>
            <div id="tkn_tel_nip" class="mono font-semibold text-red-900"></div>
          </div>
        </button>
        <button type="button" class="w-full text-left" data-copy="tkn_icc">
          <div class="flex items-center justify-between">
            <div class="text-sm text-red-700">ICC</div>
            <div id="tkn_icc" class="mono font-semibold text-red-900"></div>
          </div>
        </button>
        <button type="button" class="w-full text-left" data-copy="tkn_curp">
          <div class="flex items-center justify-between">
            <div class="text-sm text-red-700">CURP</div>
            <div id="tkn_curp" class="mono font-semibold text-red-900">‚Äî</div>
          </div>
        </button>
        <button type="button" class="w-full text-left" data-copy="tkn_promotor">
          <div class="flex items-center justify-between">
            <div class="text-sm text-red-700">Promotor</div>
            <div id="tkn_promotor" class="font-semibold text-red-900">‚Äî</div>
          </div>
        </button>
      </div>
      <div class="bg-red-50 p-4 flex justify-end gap-2">
        <button id="btnCloseTicket" class="rounded-xl bg-red-700 text-white py-2.5 px-4 hover:bg-red-800">Listo</button>
      </div>
    </div>
  </div>

  <!-- Modal Scanner -->
  <div id="scanOverlay" class="hidden fixed inset-0 bg-red-900/50 glass flex items-center justify-center p-4 z-50">
    <div class="w-full max-w-md rounded-2xl overflow-hidden shadow-xl bg-white">
      <div class="p-4 bg-gradient-to-r from-red-800 to-red-600 text-white flex items-center justify-between">
        <h3 class="font-semibold">Escanear ICC</h3>
        <button id="btnCloseScan" class="text-sm underline">Cerrar</button>
      </div>
      <div class="p-4 space-y-3">
        <div id="scanSupport" class="text-sm text-red-700"></div>
        <video id="scanVideo" class="w-full rounded-xl bg-black aspect-[3/4]" autoplay muted playsinline></video>
        <div class="text-sm text-red-700/80">Apunta al c√≥digo de barras (Code128/EAN). Si no aparece, escribe el ICC manualmente.</div>
      </div>
      <div class="p-4 bg-red-50 flex justify-end">
        <button id="btnStopScan" class="rounded-xl bg-white border border-red-200 py-2 px-4 text-sm hover:bg-red-100">Detener</button>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // ‚öôÔ∏è CONFIGURACI√ìN EDITABLE (tomada del index base)
    // ==============================
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyBqdxN9On-PqkuJ86eQDu22EMCfg2qgwtr8LgYh53yyvz1xMPTCj1zT84q02Yn4eM/exec';
    const VALID_PLAZAS = ['MONTERREY','MANTE','REYNOSA','MATAMOROS','SALTILLO','CHIHUAHUA','DELICIAS','CUAHUTEMOC','TAMPICO'];

    // ==============================
    // üß† Encuesta
    // ==============================
    const COMPANIES=['Movistar','AT&T','Unefon','Bait','OXXO Cel','Virgin','Rincel','Telcel'];
    const COMPANY_QUESTIONS={
      'Movistar':[ {q:'¬øSe te corta la se√±al en interiores?',options:[{t:'S√≠',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]}, {q:'¬øTus datos rinden menos de lo esperado?',options:[{t:'S√≠',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]}, {q:'¬øLlamadas con eco o retraso?',options:[{t:'S√≠',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]} ],
      'AT&T':[ {q:'¬øTe quedas sin cobertura en traslados?',options:[{t:'S√≠',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]}, {q:'¬øTe limitan apps o redes sociales?',options:[{t:'S√≠',w:0.8},{t:'A veces',w:0.5},{t:'No',w:0.2}]}, {q:'¬øSientes lentitud en horas pico?',options:[{t:'S√≠',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]} ],
      'Unefon':[ {q:'¬øCambios de velocidad inesperados?',options:[{t:'S√≠',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]}, {q:'¬øCobertura irregular en tu colonia?',options:[{t:'S√≠',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]}, {q:'¬øProblemas para compartir internet?',options:[{t:'S√≠',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]} ],
      'Bait':[ {q:'¬øTe falla en interiores (centros comerciales)?',options:[{t:'S√≠',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]}, {q:'¬øVes baja velocidad por la tarde-noche?',options:[{t:'S√≠',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]}, {q:'¬øPierdes se√±al en carretera?',options:[{t:'S√≠',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]} ],
      'OXXO Cel':[ {q:'¬øRedes sociales cargan lento?',options:[{t:'S√≠',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]}, {q:'¬øSe cae la llamada seguido?',options:[{t:'S√≠',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]}, {q:'¬øDescargas tardan demasiado?',options:[{t:'S√≠',w:0.8},{t:'A veces',w:0.5},{t:'No',w:0.2}]} ],
      'Virgin':[ {q:'¬øApps bancarias fallan fuera de casa?',options:[{t:'S√≠',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]}, {q:'¬øMala se√±al en oficinas/escuela?',options:[{t:'S√≠',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]}, {q:'¬øSufres latencia en videollamadas?',options:[{t:'S√≠',w:0.8},{t:'A veces',w:0.5},{t:'No',w:0.2}]} ],
      'Rincel':[ {q:'¬øSe pierde se√±al al entrar a edificios?',options:[{t:'S√≠',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]}, {q:'¬øInternet intermitente?',options:[{t:'S√≠',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]}, {q:'¬øDificultad para hotspot?',options:[{t:'S√≠',w:0.8},{t:'A veces',w:0.5},{t:'No',w:0.2}]} ],
      'Telcel':[]
    };
    const planByScore=(score)=> score>=2.4?'Amigo Sin L√≠mite 150':(score>=1.6?'Amigo Sin L√≠mite 100':'Amigo Sin L√≠mite 80');
    function pitchByCompanyAndScore(company,score){ const alta='Veo varios puntos de dolor. Con Telcel mejoras cobertura en interiores y estabilidad en horas pico.'; const media='Hay √°reas de mejora. Con Telcel ganas estabilidad y mejor rendimiento en apps.'; const baja='Tu experiencia es decente, pero con Telcel puedes asegurar se√±al donde hoy te falla.'; if(score>=2.4) return `${alta} (${company})`; if(score>=1.6) return `${media} (${company})`; return `${baja} (${company})`; }

    // Utils
    const $=(id)=>document.getElementById(id);
    const onlyDigits=(s)=> (s||'').replace(/\D+/g,'');
    const last6=(s)=> String(s||'').slice(-6).padStart(6,'‚Ä¢');
    const sleep=(ms)=> new Promise(r=>setTimeout(r,ms));
    function luhnCheck(num){ const s=onlyDigits(num); if(s.length<19) return false; let sum=0,dbl=false; for(let i=s.length-1;i>=0;i--){ let d=parseInt(s[i],10); if(dbl){ d*=2; if(d>9) d-=9; } sum+=d; dbl=!dbl; } return sum%10===0; }

    // Nav
    const portada=$('portada'); const encuestaCard=$('encuestaCard'); const fichaCard=$('fichaCard'); const activarCard=$('activarCard');
    const btnStartSurvey=$('btnStartSurvey'); const btnGoCapture=$('btnGoCapture'); const btnGoActivar=$('btnGoActivar');
    btnStartSurvey.onclick=()=>{ show(encuestaCard); hide(fichaCard); hide(activarCard); hide(portada); renderCompanyButtons(); resetSurvey(); };
    btnGoCapture.onclick =()=>{ show(fichaCard); hide(encuestaCard); hide(activarCard); hide(portada); };
    btnGoActivar.onclick =()=>{ show(activarCard); hide(encuestaCard); hide(fichaCard); hide(portada); // prellenar promotor si existe
      const p=$('promotor').value.trim(); if(p) $('aPromotor').value=p; };
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    // Encuesta
    const companyButtons=$('companyButtons'); const surveyQuestions=$('surveyQuestions'); const surveyResult=$('surveyResult'); const notaTelcel=$('notaTelcel'); const scoreValue=$('scoreValue'); const pitchValue=$('pitchValue'); const planValue=$('planValue');
    let currentCompany=null; let currentAnswers=[];
    function renderCompanyButtons(){ companyButtons.innerHTML=''; COMPANIES.forEach(c=>{ const b=document.createElement('button'); b.type='button'; b.className='rounded-xl border border-red-200 px-3 py-1.5 text-sm hover:bg-red-50'; b.textContent=c; b.onclick=()=> selectCompany(c); companyButtons.appendChild(b); }); }
    function resetSurvey(){ surveyQuestions.innerHTML=''; surveyQuestions.classList.add('hidden'); surveyResult.classList.add('hidden'); notaTelcel.classList.add('hidden'); currentCompany=null; currentAnswers=[]; scoreValue.textContent='0.00'; pitchValue.textContent='‚Äî'; planValue.textContent='‚Äî'; }
    function selectCompany(company){ currentCompany=company; currentAnswers=[]; surveyQuestions.innerHTML=''; scoreValue.textContent='0.00'; pitchValue.textContent='‚Äî'; planValue.textContent='‚Äî'; surveyResult.classList.add('hidden'); if(company==='Telcel'){ notaTelcel.classList.remove('hidden'); surveyQuestions.classList.add('hidden'); return; } notaTelcel.classList.add('hidden'); const qs=COMPANY_QUESTIONS[company]||[]; if(!qs.length){ surveyQuestions.classList.add('hidden'); return; } surveyQuestions.classList.remove('hidden'); qs.forEach((item,idx)=>{ const wrap=document.createElement('div'); wrap.className='rounded-xl border border-red-200 p-4'; const title=document.createElement('div'); title.className='font-medium'; title.textContent=`${idx+1}. ${item.q}`; const opts=document.createElement('div'); opts.className='mt-3 flex flex-wrap gap-2'; item.options.forEach(opt=>{ const ob=document.createElement('button'); ob.type='button'; ob.className='rounded-lg bg-white border border-red-200 px-3 py-1.5 text-sm hover:bg-red-50'; ob.textContent=opt.t; ob.onclick=()=>{ currentAnswers[idx]=opt.w; [...opts.children].forEach(ch=>ch.classList.remove('ring-2','ring-red-400')); ob.classList.add('ring-2','ring-red-400'); const sum=currentAnswers.filter(x=>typeof x==='number').reduce((a,b)=>a+b,0); const count=currentAnswers.filter(x=>typeof x==='number').length; const score=count?sum:0; scoreValue.textContent=score.toFixed(2); pitchValue.textContent=pitchByCompanyAndScore(company,score); planValue.textContent=planByScore(score); surveyResult.classList.remove('hidden'); }; opts.appendChild(ob); }); wrap.appendChild(title); wrap.appendChild(opts); surveyQuestions.appendChild(wrap); }); }

    // Net status
    function updateNet(){ const el=$('netStatus'); const el2=$('netStatus2'); const on=navigator.onLine; const txt= on? 'En l√≠nea' : 'Sin conexi√≥n'; const cls='text-xs '+(on?'text-green-100':'text-yellow-200'); if(el){ el.textContent=txt; el.className=cls; } if(el2){ el2.textContent=txt; el2.className=cls; } }
    window.addEventListener('online',updateNet); window.addEventListener('offline',updateNet); updateNet();

    // GAS helpers (misma webapp)
    async function sendToSheets(record,{retries=2,timeoutMs=8000}={}){ const body='payload='+encodeURIComponent(JSON.stringify(record)); for(let attempt=0; attempt<=retries; attempt++){ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs); try{ const res=await fetch(SHEETS_WEBAPP_URL,{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body, signal: ctrl.signal}); clearTimeout(t); if(!res.ok) throw new Error('HTTP '+res.status); const data=await res.json().catch(()=>({})); return data; } catch(err){ clearTimeout(t); if(attempt===retries) throw err; await sleep(600*(attempt+1)); } } }

    // ===== Ficha de captura =====
    const captureForm=$('captureForm'); const iccHint=$('iccHint');
    captureForm.addEventListener('input',()=> hideDupWarn());
    captureForm.addEventListener('submit', async (e)=>{ e.preventDefault(); normalizeInputs(); if(!validateForm()) return; const record={ type:'capture', timestamp:new Date().toISOString(), plaza:$('plaza').value, carrier:$('carrier').value, nombreCompleto:$('nombreCompleto').value.trim(), telefono:onlyDigits($('telefono').value), fechaNacimiento:$('fechaNacimiento').value, estadoNacimiento:$('estadoNacimiento').value, curp:($('curp').value||'').toUpperCase().trim(), icc:onlyDigits($('icc').value).slice(0,19), nip:onlyDigits($('nip').value).slice(0,4), promotor:$('promotor').value.trim(), estatus:$('estatus').value||'Portabilidad iniciada' }; if (isDuplicateLocal(record.telefono, record.icc)){ showDupWarn(); if(!confirm('Parece duplicado. ¬øDeseas continuar de todos modos?')) return; } try{ disableSubmit(); await sendToSheets(record); addLeadLocal(record); openTicket(record); } catch(err){ console.error(err); alert('No se pudo enviar a Sheets. Int√©ntalo de nuevo.'); } finally{ enableSubmit(); } });
    function normalizeInputs(){ const telEl=$('telefono'), iccEl=$('icc'), nipEl=$('nip'), curpEl=$('curp'); telEl.value=onlyDigits(telEl.value).slice(0,10); iccEl.value=onlyDigits(iccEl.value).slice(0,19); nipEl.value=onlyDigits(nipEl.value).slice(0,4); if(curpEl.value) curpEl.value=curpEl.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,18).trim(); }
    function validateForm(){ const plaza=$('plaza'), promotor=$('promotor'), telefono=$('telefono'), icc=$('icc'), nip=$('nip'); if(!plaza.value) return focusAndAlert(plaza,'Selecciona una plaza.'); if(!VALID_PLAZAS.includes(plaza.value)) return focusAndAlert(plaza,'Plaza inv√°lida.'); if(!promotor.value.trim()) return focusAndAlert(promotor,'Escribe el nombre del promotor.'); if(onlyDigits(telefono.value).length!==10) return focusAndAlert(telefono,'El tel√©fono debe tener 10 d√≠gitos.'); if(onlyDigits(icc.value).length!==19) return focusAndAlert(icc,'El ICC debe tener 19 d√≠gitos.'); if(!luhnCheck(icc.value)){ iccHint.classList.remove('hidden'); return false; } iccHint.classList.add('hidden'); if(onlyDigits(nip.value).length!==4) return focusAndAlert(nip,'El NIP debe tener 4 d√≠gitos.'); return true; }
    function focusAndAlert(el,msg){ alert(msg); el.focus(); }
    function resetForm(){ captureForm.reset(); $('estatus').value='Portabilidad iniciada'; iccHint.classList.add('hidden'); hideDupWarn(); enableSubmit(); }
    const btnCrearFicha=$('btnCrearFicha'); const btnSpinner=$('btnSpinner'); function disableSubmit(){ btnCrearFicha.classList.add('btn-disabled'); btnSpinner.classList.remove('hidden'); } function enableSubmit(){ btnCrearFicha.classList.remove('btn-disabled'); btnSpinner.classList.add('hidden'); }

    // Ticket
    const ticketOverlay=$('ticketOverlay'); $('btnCloseTicket').onclick=()=>{ ticketOverlay.classList.add('hidden'); resetForm(); show(portada); hide(encuestaCard); hide(fichaCard); hide(activarCard); };
    function openTicket(rec){ $('tkn_tel_nip').textContent=`${rec.telefono} ‚Ä¢ ${rec.nip}`; $('tkn_icc').textContent=rec.icc; $('tkn_curp').textContent=rec.curp||'‚Äî'; $('tkn_promotor').textContent=rec.promotor||'‚Äî'; ticketOverlay.classList.remove('hidden'); }
    ticketOverlay.addEventListener('click',(e)=>{ const btn=e.target.closest('[data-copy]'); if(!btn) return; const id=btn.getAttribute('data-copy'); const txt=$(id).textContent; navigator.clipboard?.writeText(txt).then(()=>{ btn.classList.add('ring-2','ring-green-400'); setTimeout(()=>btn.classList.remove('ring-2','ring-green-400'),700); }); });

    // ===== Activar Chip =====
    const activarForm=$('activarForm'); const actsBody=$('actsBody'); const ACTS_KEY='mada_activaciones';
    activarForm.addEventListener('submit', async (e)=>{ e.preventDefault(); const tipo=[...document.querySelectorAll('input[name="tipoChip"]')].find(x=>x.checked)?.value||'Azul'; const prom=$('aPromotor').value.trim(); const numero=onlyDigits($('aNumero').value).slice(0,10); const monto=Number(onlyDigits($('aMonto').value)); const icc=onlyDigits($('aICC').value).slice(0,19); if(!prom) return alert('Promotor requerido'); if(numero.length!==10) return alert('N√∫mero de 10 d√≠gitos'); if(!monto || monto<=0) return alert('Monto inv√°lido'); const record={ type:'activation', timestamp:new Date().toISOString(), promotor:prom, tipo, numero, monto, icc: icc||null }; try{ await sendToSheets(record); addActLocal(record); if(!icc) alert('Activaci√≥n registrada (sin ICC).'); else alert('Activaci√≥n registrada.'); activarForm.reset(); $('aPromotor').value=prom; } catch(err){ console.error(err); alert('No se pudo enviar a Sheets.'); } });
    function getActs(){ try{ return JSON.parse(localStorage.getItem(ACTS_KEY))||[]; } catch{ return []; } }
    function setActs(list){ localStorage.setItem(ACTS_KEY, JSON.stringify(list)); renderActs(); }
    function addActLocal(rec){ const row={ ts:new Date().toLocaleString(), promotor:rec.promotor, tipo:rec.tipo, numero:rec.numero, icc: rec.icc? last6(rec.icc): '‚Äî', monto: rec.monto }; const list=getActs(); list.unshift(row); setActs(list.slice(0,20)); }
    function renderActs(){ const list=getActs(); actsBody.innerHTML=''; if(!list.length){ actsBody.innerHTML='<tr><td class="px-3 py-2 text-sm text-red-700" colspan="6">Sin registros</td></tr>'; return; } list.forEach(r=>{ const tr=document.createElement('tr'); tr.className='border-t border-red-100'; tr.appendChild(cell(r.ts)); tr.appendChild(cell(r.promotor)); tr.appendChild(cell(r.tipo)); tr.appendChild(cell(r.numero)); tr.appendChild(cell(r.icc)); tr.appendChild(cell(currency(r.monto), true)); actsBody.appendChild(tr); }); }
    function cell(txt, right){ const td=document.createElement('td'); td.className='px-3 py-2'+(right?' text-right':''); td.textContent=txt; return td; }
    function currency(n){ return (Number(n||0)).toLocaleString('es-MX',{style:'currency',currency:'MXN'}); }
    $('btnExportActs').onclick=()=>{ const list=getActs(); if(!list.length) return alert('Nada que exportar.'); const header=['fecha','promotor','tipo','numero','icc6','monto']; const rows=[header.join(',')].concat(list.map(o=> header.map(k=>`"${String(o[k]??'').replace(/"/g,'""')}"`).join(','))); downloadCSV(rows.join('\n'),'activaciones.csv'); };
    $('btnClearActs').onclick=()=>{ if(confirm('¬øLimpiar lista local de activaciones?')) setActs([]); };

    // Leads (local)
    const LEADS_KEY='mada_porta_leads'; const leadsList=$('leadsList');
    function getLeads(){ try{ return JSON.parse(localStorage.getItem(LEADS_KEY))||[]; } catch{ return []; } }
    function setLeads(arr){ localStorage.setItem(LEADS_KEY, JSON.stringify(arr)); renderLeads(); }
    function addLeadLocal(rec){ const resumen={ ts:new Date().toLocaleString(), nombre: rec.nombreCompleto||'‚Äî', telefono: rec.telefono, carrier: rec.carrier||'‚Äî', plaza: rec.plaza, icc6: last6(rec.icc), estatus: rec.estatus||'Portabilidad iniciada' }; const list=getLeads(); list.unshift(resumen); setLeads(list.slice(0,12)); }
    function badgeClass(estatus){ if(!estatus) return 'bg-red-100 text-red-800'; const e=(estatus||'').toLowerCase(); if(e.includes('confirmado')) return 'bg-green-100 text-green-800'; if(e.includes('rechaz')) return 'bg-rose-100 text-rose-800'; return 'bg-red-100 text-red-800'; }
    function renderLeads(){ const list=getLeads(); leadsList.innerHTML=''; if(!list.length){ leadsList.innerHTML='<div class="text-red-700/80 text-sm">Sin registros todav√≠a.</div>'; return; } list.forEach(item=>{ const row=document.createElement('div'); row.className='py-3'; const top=document.createElement('div'); top.className='flex items-center justify-between'; const name=document.createElement('div'); name.className='font-medium'; name.textContent=item.nombre; const badge=document.createElement('span'); badge.className='text-xs px-2 py-0.5 rounded-full '+badgeClass(item.estatus); badge.textContent=item.estatus; top.appendChild(name); top.appendChild(badge); const line1=document.createElement('div'); line1.className='text-sm text-red-700'; line1.textContent=`${item.plaza} ‚Ä¢ ${item.carrier}`; const line2=document.createElement('div'); line2.className='text-sm text-red-700'; line2.textContent=`Tel: ${item.telefono} ¬∑ ICC: ${item.icc6}`; const line3=document.createElement('div'); line3.className='text-xs text-red-500 mt-1'; line3.textContent=item.ts; row.appendChild(top); row.appendChild(line1); row.appendChild(line2); row.appendChild(line3); leadsList.appendChild(row); }); }
    $('btnClearLeads').onclick=()=>{ if(confirm('¬øLimpiar lista local de leads?')) setLeads([]); };
    $('btnExportLeads').onclick=()=>{ const list=getLeads(); if(!list.length) return alert('No hay registros para exportar.'); const header=['ts','nombre','telefono','carrier','plaza','icc6','estatus']; const rows=[header.join(',')].concat(list.map(o=> header.map(k=>`"${String(o[k]??'').replace(/"/g,'""')}"`).join(','))); downloadCSV(rows.join('\n'),'leads_mada.csv'); };

    // Duplicidad local
    function showDupWarn(){ $('dupWarn').classList.remove('hidden'); }
    function hideDupWarn(){ $('dupWarn').classList.add('hidden'); }
    function isDuplicateLocal(tel, icc){ const list=getLeads(); return list.some(x=> x.telefono===tel || (x.icc6 && last6(icc)===x.icc6)); }

    // CSV helper
    function downloadCSV(str,name){ const blob=new Blob([str],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }

    // Scanner ICC (reutilizable)
    const scanOverlay=$('scanOverlay'); const scanVideo=$('scanVideo'); const scanSupport=$('scanSupport'); const btnScanICC=$('btnScanICC'); const btnCloseScan=$('btnCloseScan'); const btnStopScan=$('btnStopScan'); const btnScanICC2=$('btnScanICC2'); let mediaStream=null, barcodeDetector=null, scanLoopActive=false, currentScanTarget=null;
    function openScannerFor(id){ currentScanTarget=$(id); scanOverlay.classList.remove('hidden'); if('BarcodeDetector' in window){ try{ barcodeDetector=new BarcodeDetector({formats:['code_128','ean_13','ean_8','upc_a','upc_e','code_39']}); scanSupport.textContent='Soporte nativo disponible. Escaneando...'; } catch{ barcodeDetector=null; scanSupport.textContent='Error iniciando BarcodeDetector. Ingrese ICC manualmente.'; } } else { scanSupport.textContent='Sin soporte nativo. Ingrese ICC manualmente.'; } startCamera().then(()=>{ if(barcodeDetector) startScanLoop(); }); }
    btnScanICC.onclick = ()=> openScannerFor('icc');
    btnScanICC2.onclick= ()=> openScannerFor('aICC');
    btnCloseScan.onclick= closeScanModal; btnStopScan.onclick= closeScanModal;
    async function startCamera(){ try{ mediaStream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } }); scanVideo.srcObject=mediaStream; await scanVideo.play(); } catch{ scanSupport.textContent='No se pudo acceder a la c√°mara. Ingresa ICC manualmente.'; } }
    function closeScanModal(){ scanOverlay.classList.add('hidden'); stopCamera(); scanLoopActive=false; currentScanTarget=null; }
    function stopCamera(){ if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; } scanVideo.pause(); scanVideo.srcObject=null; }
    async function startScanLoop(){ scanLoopActive=true; while(scanLoopActive && barcodeDetector && scanVideo.readyState>=2){ try{ const barcodes=await barcodeDetector.detect(scanVideo); if(barcodes && barcodes.length){ const raw=barcodes[0].rawValue||''; const digits=onlyDigits(raw); if(digits.length>=19){ if(currentScanTarget) currentScanTarget.value=digits.slice(0,19); closeScanModal(); break; } } } catch{} await sleep(200); } }

    // Atajos
    document.addEventListener('keydown',(e)=>{ if(e.key==='F2'){ e.preventDefault(); $('telefono').focus(); } });

    // Render inicial
    renderLeads(); renderActs(); portada.classList.remove('hidden');
  </script>
</body>
</html>
