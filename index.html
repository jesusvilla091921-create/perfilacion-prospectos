<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OCR Portabilidades</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;background:#fafafa;color:#222}
h1{font-size:22px;margin-bottom:8px}
input[type=file]{margin-top:10px}
#preview{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.preview-item{border:1px solid #ccc;border-radius:6px;padding:6px;background:#fff;width:140px;text-align:center;font-size:13px}
.progress{height:8px;background:#ddd;border-radius:5px;overflow:hidden;margin-top:8px}
.progress-bar{height:100%;background:#0ea5a4;width:0%}
button{margin-top:12px;background:#0ea5a4;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer}
table{margin-top:20px;border-collapse:collapse;width:100%;background:#fff}
th,td{border:1px solid #ddd;padding:8px;font-size:14px}
th{background:#0ea5a4;color:white}
small{color:#666}
</style>
</head>
<body>
<h1>OCR Portabilidades - Procesamiento en lote</h1>
<p>Sube hasta <strong>10 fotos</strong> del resumen de trámite. Se extraerán los datos y se enviarán automáticamente a tu hoja de Google Sheets.</p>

<label>Nombre del promotor:</label><br>
<input type="text" id="promotor" placeholder="Ej: Ángel / Alex" style="padding:6px;width:260px;border-radius:6px;border:1px solid #ccc"><br><br>

<input id="files" type="file" accept="image/*" multiple>
<div id="preview"></div>
<div class="progress"><div id="bar" class="progress-bar"></div></div>

<button id="procesar">Procesar y enviar</button>

<table id="tabla" style="display:none">
<thead>
<tr><th>#</th><th>Teléfono</th><th>ICCID</th><th>Fecha</th><th>Estado</th></tr>
</thead><tbody></tbody></table>

<p><small>Todo se procesa localmente en tu navegador y se envía únicamente a tu hoja de Google Sheets.</small></p>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.0/dist/tesseract.min.js"></script>
<script>
const urlScript = "https://script.google.com/macros/s/AKfycbx43pXC8sZLUCX0J9VEDlGPl6cYW9D7pKxtdrprxuBz-1PaECjaz4PAy_WMHQHfatYc/exec";
const input = document.getElementById('files');
const preview = document.getElementById('preview');
const bar = document.getElementById('bar');
const tabla = document.getElementById('tabla');
const tbody = tabla.querySelector('tbody');

let imagenes = [];

input.addEventListener('change', e=>{
  imagenes = Array.from(e.target.files).slice(0,10);
  preview.innerHTML = '';
  imagenes.forEach(f=>{
    const div = document.createElement('div');
    div.className='preview-item';
    const img = document.createElement('img');
    img.src = URL.createObjectURL(f);
    img.style.maxWidth='100%';
    img.onload = ()=>URL.revokeObjectURL(img.src);
    div.appendChild(img);
    div.appendChild(document.createTextNode(f.name));
    preview.appendChild(div);
  });
});

document.getElementById('procesar').addEventListener('click', async ()=>{
  const promotor = document.getElementById('promotor').value.trim();
  if(!promotor) return alert('Escribe el nombre del promotor.');
  if(imagenes.length===0) return alert('Sube al menos una imagen.');

  tabla.style.display='table';
  tbody.innerHTML='';
  bar.style.width='0%';

  let index = 0;
  for(const file of imagenes){
    index++;
    const row = document.createElement('tr');
    row.innerHTML=`<td>${index}</td><td colspan="3">${file.name}</td><td>Pendiente</td>`;
    tbody.appendChild(row);

    const text = await extraerTexto(file);
    const {telefono, icc, fecha} = parsear(text);

    row.cells[1].textContent = telefono || '-';
    row.cells[2].textContent = icc || '-';
    row.cells[3].textContent = fecha || '-';

    const datos = {promotor, telefono, icc, fecha, ocr_text:text};
    try{
      const res = await fetch(urlScript,{
        method:'POST',
        body:JSON.stringify(datos),
        headers:{'Content-Type':'application/json'}
      });
      const txt = await res.text();
      if(txt.includes("OK")) row.cells[4].textContent='✅ Enviado';
      else row.cells[4].textContent='⚠️ Respuesta inesperada';
    }catch(e){
      row.cells[4].textContent='❌ Error';
    }

    bar.style.width = Math.round((index/imagenes.length)*100)+'%';
  }

  alert('Procesamiento terminado.');
});

async function extraerTexto(file){
  const {data:{text}} = await Tesseract.recognize(file,'spa+eng');
  return text.replace(/\s+/g,' ');
}

function parsear(t){
  const tel = (t.match(/\b(8[0-9]{9}|[0-9]{10})\b/)||[])[1] || '';
  const icc = (t.match(/\b(89[0-9]{17,19})\b/)||[])[1] || '';
  const fecha = (t.match(/\b([0-3]?\d[\/\-][0-1]?\d[\/\-](?:\d{2,4})|\d{4}[\/\-][0-1]?\d[\/\-][0-3]?\d)\b/)||[])[1] || '';
  return {telefono:tel, icc, fecha};
}
</script>
</body>
</html>
