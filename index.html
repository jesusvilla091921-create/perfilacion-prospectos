<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MADA — Encuesta y Ficha de captura</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --brand-blue:#003b8f;
      --brand-blue-700:#0a2f6b;
      --brand-cyan:#00aeef;
      --brand-soft:#e9f3ff;
    }
    body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .card{background:#fff;border:1px solid rgb(15 23 42/.08);box-shadow:0 1px 2px rgb(15 23 42/.06)}
    .fade-in{animation:fade .25s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .btn-option.selected{ background:var(--brand-blue); color:#fff; border-color:transparent }
    .backdrop{ position:fixed; inset:0; background:rgb(0 0 0 /.6); display:none; align-items:center; justify-content:center; z-index:50 }
    .glass{ background:rgb(255 255 255 /.78); backdrop-filter:blur(12px) }

    /* ===== Modal estilo BES ===== */
    .resume-title{ letter-spacing:.02em; }
    .field-label{ font-size:14px; color:rgb(30 58 138); font-weight:600; }   /* azul */
    .value{ font-weight:600; color:#0f172a; }                                /* slate-900 */
    .badge-red{ width:22px; height:22px; background:#b91c1c; border-radius:4px; display:inline-block; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Topbar -->
  <header class="bg-gradient-to-r from-[var(--brand-blue)] to-[var(--brand-blue-700)] text-white">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="btnHome" class="h-9 w-9 rounded-full bg-white/10 grid place-items-center font-black hover:bg-white/20">M</button>
        <div>
          <h1 class="text-lg font-semibold tracking-tight">MADA</h1>
          <p class="text-xs text-white/70 -mt-0.5">Desarrollando el talento humano</p>
        </div>
      </div>
      <span class="text-xs opacity-0 select-none">.</span>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Portada -->
    <section id="startBlock" class="card rounded-2xl p-6 sm:p-8 fade-in">
      <div class="flex flex-col items-center text-center gap-4">
        <h2 class="text-2xl font-bold text-[var(--brand-blue)]">¿Cómo quieres continuar?</h2>
        <p class="text-sm text-slate-600 max-w-prose">
          Puedes hacer un diagnóstico rápido o ir directo a la ficha de captura.
        </p>
        <div class="flex flex-col sm:flex-row gap-3">
          <button id="btnStartSurvey" class="px-5 py-2.5 rounded-xl bg-[var(--brand-blue)] text-white hover:bg-[var(--brand-blue-700)] shadow-sm">Comenzar encuesta</button>
          <button id="btnSkipToCapture" class="px-5 py-2.5 rounded-xl border hover:bg-slate-50">Ir directo a ficha</button>
        </div>
      </div>
    </section>

    <!-- App -->
    <section id="mainBlock" class="hidden grid lg:grid-cols-3 gap-5 mt-4">
      <!-- Columna principal -->
      <div class="lg:col-span-2 space-y-5">
        <!-- Compañía -->
        <div class="card rounded-2xl p-5">
          <label class="block text-sm font-semibold mb-2">Compañía del cliente</label>
          <select id="carrier" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none">
            <option value="">Selecciona...</option>
            <option>Telcel</option><option>Movistar</option><option>AT&T</option>
            <option>Unefon</option><option>Bait</option><option>OXXO Cel</option>
            <option>Virgin</option><option>Rincel</option>
          </select>
          <p id="telcelNote" class="hidden mt-3 p-3 rounded-xl bg-[var(--brand-soft)] border text-sm text-[var(--brand-blue)]">
            Ya es Telcel. Deriva a upsell/recargas.
          </p>
        </div>

        <!-- Encuesta -->
        <div id="questionsBlock" class="hidden card rounded-2xl p-5 space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Diagnóstico rápido</h3>
            <div class="text-xs text-slate-500">3–5 clics</div>
          </div>
          <div id="questionsContainer" class="space-y-3"></div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="p-4 rounded-xl bg-slate-50 border text-sm">
              <div class="flex items-center justify-between mb-2">
                <span class="font-semibold">Severidad</span>
                <span id="scoreBox" class="text-base font-bold">0.00</span>
              </div>
              <div id="pitchBox" class="opacity-80"></div>
            </div>
            <div id="planBox" class="p-4 rounded-xl bg-[var(--brand-soft)] border text-sm hidden">
              <div class="flex items-center justify-between mb-2">
                <span class="font-semibold text-[var(--brand-blue)]">Recomendación</span>
                <span class="inline-flex items-center gap-1 text-[var(--brand-blue)] text-xs">
                  <span class="size-2 rounded-full bg-[var(--brand-cyan)]"></span> Portabilidad Plus 12 meses
                </span>
              </div>
              <div id="planCard"></div>
            </div>
          </div>
          <div class="flex flex-wrap gap-2 items-center">
            <span class="font-semibold">Acciones:</span>
            <button id="btnAccept" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm hover:bg-emerald-700">Aceptó cambio</button>
            <button id="btnReject" class="px-3 py-2 rounded-xl bg-rose-600 text-white text-sm hover:bg-rose-700">No aceptó</button>
            <button id="btnGoCapture" class="ml-auto px-3 py-2 rounded-xl border text-sm hover:bg-slate-50">Ir a ficha</button>
          </div>
        </div>

        <!-- Ficha de captura -->
        <div id="captureBlock" class="hidden card rounded-2xl p-5 space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Ficha de captura</h3>
            <span class="text-xs text-slate-500">Solo se guardan los datos solicitados</span>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Nombre(s)</label>
              <input id="capNombre" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none"/>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Apellido paterno</label>
              <input id="capApPaterno" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none"/>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Apellido materno</label>
              <input id="capApMaterno" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none"/>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Teléfono (10 dígitos)</label>
              <input id="capTelefono" inputmode="numeric" maxlength="10" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none"/>
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium mb-1">CURP (opcional)</label>
              <input id="capCurp" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none"/>
            </div>

            <div class="sm:col-span-2 flex gap-2 items-end">
              <div class="flex-1">
                <label class="block text-sm font-medium mb-1">ICC (SIM, 20 dígitos)</label>
                <input id="capICC" maxlength="20" inputmode="numeric" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none"/>
              </div>
              <button id="btnScanICC" type="button" class="h-[42px] px-3 rounded-xl border hover:bg-slate-50">Escanear</button>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">NIP (4 dígitos)</label>
              <input id="capNip" maxlength="4" inputmode="numeric" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none"/>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Nombre del promotor</label>
              <input id="capPromotor" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none"/>
            </div>
          </div>

          <div class="flex justify-end gap-2">
            <button id="btnCancelCapture" class="px-3 py-2 rounded-xl border text-sm hover:bg-slate-50">Cancelar</button>
            <button id="btnSaveCapture" class="px-3 py-2 rounded-xl bg-[var(--brand-blue)] text-white text-sm hover:bg-[var(--brand-blue-700)]">Crear ficha</button>
          </div>

          <div class="text-xs opacity-70">
            Se guardan en Sheets: Fecha de captura, Número, Nombre, Ap. paterno, Ap. materno, CURP (si aplica), ICC, NIP y Carrier.
          </div>
        </div>
      </div>

      <!-- Lateral -->
      <aside class="space-y-5">
        <div class="rounded-2xl border shadow-sm overflow-hidden">
          <div class="bg-[var(--brand-blue)] text-white px-4 py-2 text-sm font-semibold">Debilidades típicas</div>
          <div class="bg-white p-4">
            <ul id="weakList" class="list-disc list-inside text-sm space-y-1">
              <li class="opacity-70">Selecciona una compañía para ver enfoque.</li>
            </ul>
          </div>
        </div>

        <div class="rounded-2xl border shadow-sm overflow-hidden">
          <div class="bg-[var(--brand-blue)] text-white px-4 py-2 text-sm font-semibold">Leads capturados (local)</div>
          <div id="leadsLog" class="bg-white p-4 space-y-3 max-h-[28rem] overflow-auto">
            <div class="text-sm opacity-60">Aún no hay registros.</div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Modal estilo BES -->
  <div id="okModal" class="backdrop">
    <div class="glass rounded-2xl shadow-2xl w-[94%] max-w-xl p-5 border">
      <div class="flex items-center gap-2 text-[var(--brand-blue)] mb-2">
        <div class="h-8 w-8 rounded-lg bg-[var(--brand-blue)]/10 grid place-items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="size-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.09 15.09 0 006.59 6.59l2.2-2.2a1 1 0 011.02-.24 11.36 11.36 0 003.56.57 1 1 0 011 1V20a1 1 0 01-1 1A17 17 0 013 4a1 1 0 011-1h3.5a1 1 0 011 1 11.36 11.36 0 00.57 3.56 1 1 0 01-.25 1.02l-2.2 2.21z"/></svg>
        </div>
        <div class="font-semibold">Confirma Solicitud Prepago BES</div>
      </div>

      <h2 class="text-center text-xl font-bold resume-title text-slate-800 mb-2">RESUMEN DEL TRÁMITE</h2>

      <!-- se llena por JS -->
      <div id="okDetails" class="text-[15px] leading-7"></div>

      <div class="grid grid-cols-2 gap-3 mt-5">
        <button id="okBack" class="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 border">REGRESAR</button>
        <button id="okConfirm" class="px-4 py-2 rounded-xl bg-[var(--brand-blue)] text-white hover:bg-[var(--brand-blue-700)]">CONFIRMAR</button>
      </div>
    </div>
  </div>

  <!-- Scanner modal -->
  <div id="scanModal" class="backdrop">
    <div class="glass rounded-2xl shadow-xl w-full max-w-md p-4 border">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Escanear código de barras (ICC)</h3>
        <button id="btnCloseScan" class="text-sm px-2 py-1 rounded-lg border bg-white/70">Cerrar</button>
      </div>
      <div id="scanSupport" class="text-sm opacity-70 mb-2"></div>
      <video id="scanVideo" class="w-full rounded-xl bg-black aspect-video" playsinline></video>
      <div class="text-xs opacity-60 mt-2">Enfoca el código del SIM. Al detectar, se llenará el campo ICC automáticamente.</div>
    </div>
  </div>

  <script>
    /* =================== ENDPOINT (Apps Script) =================== */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbznCd5Fs1amwdyHolpwze5yOzsw7OrTI_06DtZXkK0wqBEAdpJFijr_bgtiAjVTK6fwjA/exec';

    /* =================== Encuesta simple =================== */
    const carriers = {
      Telcel:{disabled:true, note:"Cliente Telcel actual", weaknesses:["Cliente actual - upsell/recargas"]},
      Movistar:{
        weaknesses:["Descuentos 2 meses, luego sube","Cobertura fuera de ciudad limitada","Lentitud en horas pico"],
        questions:[
          {id:"descuento", text:"¿Los descuentos solo te duran 2 meses?", options:["Sí","A veces","No"], weight:1.5},
          {id:"cobertura", text:"¿Pierdes señal al viajar o en zonas rurales?", options:["Sí, seguido","A veces","No"], weight:2},
          {id:"velocidad", text:"¿Se pone lento en horas pico?", options:["Sí, siempre","A veces","No"], weight:1.5}
        ],
        pitch:s=> s>=4?"Con Movistar terminas pagando más y con menos cobertura. Telcel te da precio estable, 5G y cobertura real.":"Si te falla la señal o sube el precio, Telcel mantiene estabilidad y mejor red."
      },
      "AT&T":{
        weaknesses:["Acumulación confusa","Cobertura irregular","Precio alto"],
        questions:[
          {id:"acumulacion", text:"¿Te confunden condiciones para acumular megas?", options:["Sí","Algo","No"], weight:1.5},
          {id:"viajes", text:"¿Se te cae la señal al viajar?", options:["Sí, seguido","A veces","No"], weight:2},
          {id:"costo", text:"¿Pagas más de $200 al mes?", options:["Sí","No sé","No"], weight:1.5}
        ],
        pitch:s=> s>=3.5?"AT&T complica y la cobertura se cae. Telcel es claro y con red más amplia.":"Si batallas en carretera o interiores, Telcel te cubre mejor."
      }
    };

    const el = id => document.getElementById(id);

    // Elements
    const startBlock = el('startBlock');
    const mainBlock = el('mainBlock');
    const btnStartSurvey = el('btnStartSurvey');
    const btnSkipToCapture = el('btnSkipToCapture');
    const btnHome = el('btnHome');

    const carrier = el('carrier');
    const telcelNote = el('telcelNote');

    const questionsBlock = el('questionsBlock');
    const questionsContainer = el('questionsContainer');
    const scoreBox = el('scoreBox');
    const pitchBox = el('pitchBox');
    const weakList = el('weakList');
    const btnAccept = el('btnAccept');
    const btnReject = el('btnReject');
    const btnGoCapture = el('btnGoCapture');

    const leadsLog = el('leadsLog');

    const captureBlock = el('captureBlock');
    const capNombre = el('capNombre');
    const capApPaterno = el('capApPaterno');
    const capApMaterno = el('capApMaterno');
    const capTelefono = el('capTelefono');
    const capCurp = el('capCurp');
    const capICC = el('capICC');
    const capNip = el('capNip');
    const capPromotor = el('capPromotor');
    const btnCancelCapture = el('btnCancelCapture');
    const btnSaveCapture = el('btnSaveCapture');

    // Modal estilo BES
    const okModal = el('okModal');
    const okDetails = el('okDetails');

    // Scanner elements
    const scanModal = el('scanModal');
    const scanVideo = el('scanVideo');
    const btnScanICC = el('btnScanICC');
    const btnCloseScan = el('btnCloseScan');
    const scanSupport = el('scanSupport');

    // State
    let showSurvey = false;
    let currentScore = 0;
    let currentCarrier = null;
    let answers = {};
    let leads = [];
    let scanStream = null, scanning=false, detector=null;

    document.addEventListener('DOMContentLoaded', () => {
      btnHome.addEventListener('click', goHome);
      btnStartSurvey.addEventListener('click', () => startApp(true));
      btnSkipToCapture.addEventListener('click', () => startApp(false));
      btnGoCapture.addEventListener('click', () => { questionsBlock.classList.add('hidden'); captureBlock.classList.remove('hidden'); window.scrollTo({top:captureBlock.offsetTop-12, behavior:'smooth'}); });

      carrier.addEventListener('change', handleCarrierChange);
      btnAccept.addEventListener('click', () => { captureBlock.classList.remove('hidden'); window.scrollTo({top:captureBlock.offsetTop-12, behavior:'smooth'}); });
      btnReject.addEventListener('click', () => alert('¡Gracias! Si cambias de opinión, aquí seguimos.'));

      btnCancelCapture.addEventListener('click', () => captureBlock.classList.add('hidden'));
      btnSaveCapture.addEventListener('click', saveCapture);

      capTelefono.addEventListener('input', () => { capTelefono.value = capTelefono.value.replace(/\D/g, '').slice(0,10); });
      capICC.addEventListener('input', () => { capICC.value = capICC.value.replace(/\D/g, '').slice(0,20); });
      capNip.addEventListener('input', () => { capNip.value = capNip.value.replace(/\D/g, '').slice(0,4); });

      // Scanner
      btnScanICC.addEventListener('click', openScanModal);
      btnCloseScan.addEventListener('click', closeScanModal);
      scanSupport.textContent = ('BarcodeDetector' in window) ?
        'Soportado: intentaremos Code128/EAN.' :
        'Sin soporte nativo. Si no detecta, ingresa el ICC manualmente.';

      loadSavedLeads();
    });

    function startApp(wantSurvey){
      showSurvey = wantSurvey;
      startBlock.classList.add('hidden');
      mainBlock.classList.remove('hidden');
      mainBlock.classList.add('fade-in');
      questionsBlock.classList.toggle('hidden', !showSurvey);
      if(!showSurvey) { captureBlock.classList.remove('hidden'); }
      carrier.focus();
    }

    function goHome(){ resetForm(); window.scrollTo({top:0, behavior:'smooth'}); }

    function handleCarrierChange(){
      currentCarrier = carrier.value; answers = {};
      if(currentCarrier==='Telcel'){ telcelNote.classList.remove('hidden'); } else { telcelNote.classList.add('hidden'); }
      updateWeaknesses(currentCarrier);
      if(showSurvey && carriers[currentCarrier]) { renderQuestions(); updateScore(); }
    }

    function updateWeaknesses(name){
      weakList.innerHTML='';
      const list = carriers[name]?.weaknesses || [];
      if(list.length===0){ const li=document.createElement('li'); li.className='text-sm opacity-70'; li.textContent='Selecciona una compañía para ver enfoque.'; weakList.appendChild(li); return; }
      list.forEach(w=>{ const li=document.createElement('li'); li.className='text-sm'; li.textContent=w; weakList.appendChild(li); });
    }

    function renderQuestions(){
      questionsContainer.innerHTML=''; currentScore=0;
      const qs = carriers[currentCarrier]?.questions || [];
      qs.forEach(q=>{
        const div = document.createElement('div');
        div.className='p-3 rounded-xl border';
        div.innerHTML = `
          <div class="font-medium mb-2">${q.text}</div>
          <div class="flex flex-wrap gap-2">
            ${q.options.map((opt)=>`<button class="btn-option px-3 py-1.5 rounded-lg border text-sm" data-id="${q.id}" data-value="${opt}">${opt}</button>`).join('')}
          </div>`;
        const buttons = div.querySelectorAll('.btn-option');
        buttons.forEach(btn=> btn.addEventListener('click', ()=>{
          buttons.forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected');
          answers[q.id] = btn.dataset.value; updateScore();
        }));
        questionsContainer.appendChild(div);
      });
    }
    function updateScore(){
      currentScore=0; const qs = carriers[currentCarrier]?.questions || [];
      qs.forEach(q=>{ if(answers[q.id]){ const idx=q.options.indexOf(answers[q.id]); currentScore += (q.options.length-1-idx)*q.weight; }});
      scoreBox.textContent = currentScore.toFixed(2);
      const planBox = document.getElementById('planBox');
      const planCard = document.getElementById('planCard');
      pitchBox.textContent = carriers[currentCarrier]?.pitch ? carriers[currentCarrier].pitch(currentScore) : '';
      const plan = currentScore>=3 ? 'ASL150':'ASL100';
      if(currentCarrier){ planBox.classList.remove('hidden'); planCard.innerHTML = renderPlanCard(plan); } else { planBox.classList.add('hidden'); planCard.innerHTML=''; }
    }
    function renderPlanCard(code){
      const is150 = code==='ASL150';
      const title = is150? 'Amigo Sin Límite 150' : 'Amigo Sin Límite 100';
      const price = is150? '$150 / 30 días' : '$100 / 30 días';
      const pts = ['Minutos y SMS ilimitados','Redes incluidas','Mismo número (~24h)','Beneficios 12 meses al portar'];
      return `<div class="rounded-xl border bg-white p-3">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-slate-500">Plan sugerido</div>
            <div class="text-base font-semibold text-[var(--brand-blue)]">${title}</div>
          </div>
          <div class="text-sm font-bold text-[var(--brand-blue)]">${price}</div>
        </div>
        <ul class="mt-2 text-xs space-y-1">${pts.map(p=>`<li class="flex items-start gap-2"><span class="mt-1 size-1.5 rounded-full bg-[var(--brand-cyan)]"></span><span>${p}</span></li>`).join('')}</ul>
      </div>`;
    }

    function loadSavedLeads(){ const saved = localStorage.getItem('leads'); if(saved){ leads = JSON.parse(saved); renderLeads(); } }
    function renderLeads(){
      const box = leadsLog; box.innerHTML=''; if(leads.length===0){ box.innerHTML='<div class="text-sm opacity-60">Aún no hay registros.</div>'; return; }
      [...leads].reverse().slice(0,12).forEach(lead=>{
        const div=document.createElement('div'); div.className='p-3 rounded-xl border text-sm bg-white';
        div.innerHTML=`<div class='flex justify-between items-start'>
            <div class='font-medium'>${lead.nombre||'—'}</div><div class='text-xs opacity-70'>${lead.timestamp}</div></div>
            <div class='mt-1'>${lead.telefono||'—'} · ${lead.carrier||'—'}</div>
            <div class='flex justify-between items-center mt-2'>
              <span class='px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800'>${lead.status||'Lead'}</span>
              <span class='text-xs'>${lead.score!=null?('Score: '+lead.score):''}</span>
            </div>`;
        box.appendChild(div);
      });
    }

    async function saveCapture(){
      if(!carrier.value){ alert('Selecciona la compañía'); carrier.focus(); return; }
      if(!capNombre.value.trim()){ alert('Ingresa el/los nombre(s)'); capNombre.focus(); return; }
      if(!capApPaterno.value.trim()){ alert('Ingresa apellido paterno'); capApPaterno.focus(); return; }
      if(!capApMaterno.value.trim()){ alert('Ingresa apellido materno'); capApMaterno.focus(); return; }
      if(!/^\d{10}$/.test(capTelefono.value)){ alert('Teléfono de 10 dígitos'); capTelefono.focus(); return; }
      if(!/^\d{20}$/.test(capICC.value)){ alert('ICC debe tener 20 dígitos'); capICC.focus(); return; }
      if(!/^\d{4}$/.test(capNip.value)){ alert('NIP de 4 dígitos'); capNip.focus(); return; }
      if(!capPromotor.value.trim()){ alert('Ingresa el nombre del promotor'); capPromotor.focus(); return; }

      const record = {
        type:'capture',
        timestamp:new Date().toLocaleString(),
        carrier:carrier.value,
        nombre:capNombre.value.trim(),
        apPaterno:capApPaterno.value.trim(),
        apMaterno:capApMaterno.value.trim(),
        telefono:capTelefono.value.trim(),
        curp:capCurp.value.trim(),
        icc:capICC.value.trim(),
        nip:capNip.value.trim(),
        promotor:capPromotor.value.trim()
      };

      // Guardado local (lista lateral)
      const captures = JSON.parse(localStorage.getItem('portabilityCaptures')||'[]'); captures.push(record);
      localStorage.setItem('portabilityCaptures', JSON.stringify(captures));
      leads.push({ id:Date.now(), timestamp:record.timestamp, nombre:`${record.nombre} ${record.apPaterno}`, telefono:record.telefono, carrier:record.carrier, status:'Portabilidad iniciada' });
      localStorage.setItem('leads', JSON.stringify(leads)); renderLeads();

      // Envío a Sheets (no-cors por Apps Script)
      pushToSheets(record);

      // ===== Modal estilo BES =====
      const oferta = 'Amigo Chip Portabilidad Sin Límite (Recarga)';
      const promo  = 'Portabilidad +';
      okDetails.innerHTML = `
        <div class="grid grid-cols-3 gap-y-3">
          <div>
            <div class="field-label">Teléfono</div>
            <div class="value">${record.telefono}</div>
          </div>
          <div>
            <div class="field-label">Id Port</div>
            <div class="value">${record.nip}</div>
          </div>
          <div class="flex items-end justify-end">
            <div class="field-label mr-2">Valor Cliente</div>
            <span class="badge-red"></span>
          </div>
        </div>

        <div class="mt-4">
          <div class="field-label">Oferta</div>
          <div class="value">${oferta}</div>
        </div>

        <div class="mt-3">
          <div class="field-label">Promoción</div>
          <div class="value">${promo}</div>
        </div>

        <div class="mt-4 grid sm:grid-cols-2 gap-4">
          <div>
            <div class="field-label">Nombre</div>
            <div class="value">${record.nombre || '—'}</div>
          </div>
          <div>
            <div class="field-label">Apellido Paterno</div>
            <div class="value">${record.apPaterno || '—'}</div>
          </div>
          <div>
            <div class="field-label">Apellido Materno</div>
            <div class="value">${record.apMaterno || '—'}</div>
          </div>
        </div>

        <div class="mt-3 grid sm:grid-cols-2 gap-4">
          <div>
            <div class="field-label">CURP</div>
            <div class="value break-all">${record.curp || '—'}</div>
          </div>
          <div>
            <div class="field-label">ICCID</div>
            <div class="value break-all">${record.icc}</div>
          </div>
        </div>
      `;
      okModal.style.display='flex';

      // Acciones del modal
      document.getElementById('okBack').onclick = () => {
        okModal.style.display = 'none';        // vuelve a la ficha por si quieres editar
      };
      document.getElementById('okConfirm').onclick = () => {
        okModal.style.display = 'none';
        resetForm();                            // listo para el siguiente cliente
      };
    }

    async function pushToSheets(payload){
      try{
        await fetch(SHEETS_WEBAPP_URL, {
          method:'POST',
          mode:'no-cors',
          headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
          body:'payload='+encodeURIComponent(JSON.stringify(payload))
        });
      }catch(e){ console.error('Falló envío a Sheets', e); }
    }

    function resetForm(){
      startBlock.classList.remove('hidden');
      mainBlock.classList.add('hidden');
      carrier.value=''; currentCarrier=null; telcelNote.classList.add('hidden');
      questionsBlock.classList.add('hidden'); questionsContainer.innerHTML=''; answers={}; currentScore=0; pitchBox.textContent='';
      capNombre.value=''; capApPaterno.value=''; capApMaterno.value=''; capTelefono.value=''; capCurp.value=''; capICC.value=''; capNip.value=''; capPromotor.value='';
      captureBlock.classList.add('hidden');
    }

    /* ======== Scanner ICC ======== */
    async function openScanModal(){
      scanModal.style.display='flex';
      try{
        if('BarcodeDetector' in window){ detector = new BarcodeDetector({formats:['code_128','ean_13','ean_8','upc_a','upc_e','code_39']}); } else { detector=null; }
        scanStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        scanVideo.srcObject = scanStream; await scanVideo.play(); scanning=true; requestAnimationFrame(scanLoop);
      }catch(e){ alert('No se pudo acceder a la cámara. Otorga permisos o ingresa el ICC manualmente.'); closeScanModal(); }
    }
    async function scanLoop(){
      if(!scanning) return;
      try{
        if(detector && scanVideo.readyState === HTMLMediaElement.HAVE_ENOUGH_DATA){
          const codes = await detector.detect(scanVideo);
          if(codes && codes.length){
            const value = (codes[0].rawValue || '').replace(/\D/g,'');
            if(value){ capICC.value = value.slice(0,20); closeScanModal(); return; }
          }
        }
      }catch(_){}
      requestAnimationFrame(scanLoop);
    }
    function closeScanModal(){
      scanning=false; if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
      scanVideo.pause(); scanVideo.srcObject=null; scanModal.style.display='none';
    }
  </script>
</body>
</html>
