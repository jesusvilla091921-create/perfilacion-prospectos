<!DOCTYPE html>
<html lang="es" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MADA · Portabilidad</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#003b8f">
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
  </style>
</head>
<body class="h-full text-slate-800">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-[#0a2f6b] to-[#003b8f] text-white">
      <div class="max-w-7xl mx-auto px-4 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-[#00aeef] flex items-center justify-center font-bold text-[#0a2f6b]">M</div>
          <div>
            <h1 class="text-xl font-semibold tracking-wide">MADA · Portabilidad</h1>
            <p class="text-white/80 text-sm">Flujo de perfilación y captura</p>
          </div>
        </div>
        <div class="hidden sm:block text-white/80 text-sm">Corporativo · Operación en campo</div>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1">
      <div class="max-w-7xl mx-auto px-4 py-6 lg:py-10 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Columna principal -->
        <section class="lg:col-span-2 space-y-6">

          <!-- Portada -->
          <div id="portada" class="rounded-2xl bg-white shadow-sm p-6 border border-slate-100 text-center space-y-4">
            <h2 class="text-lg font-semibold text-slate-700">Bienvenido</h2>
            <p class="text-slate-500">Selecciona cómo quieres comenzar</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-4">
              <button id="btnEncuesta" class="px-6 py-3 rounded-xl bg-[#0a2f6b] text-white font-medium hover:bg-[#003b8f]">Comenzar encuesta</button>
              <button id="btnFicha" class="px-6 py-3 rounded-xl bg-[#00aeef] text-white font-medium hover:bg-[#0098d1]">Ir directo a captura</button>
            </div>
          </div>

          <!-- Encuesta -->
          <div id="encuesta" class="hidden rounded-2xl bg-white shadow-sm p-6 border border-slate-100">
            <h2 class="text-lg font-semibold text-slate-700">Diagnóstico rápido</h2>

            <!-- Selección de compañía -->
            <div class="mt-4">
              <label class="block text-sm font-medium text-slate-600">Selecciona compañía actual</label>
              <select id="encuestaCarrier" class="mt-1 w-full rounded-lg border-slate-300">
                <option value="">Seleccione...</option>
                <option value="Telcel">Telcel</option>
                <option value="Movistar">Movistar</option>
                <option value="AT&T">AT&amp;T</option>
                <option value="Unefon">Unefon</option>
                <option value="Bait">Bait</option>
                <option value="OXXO Cel">OXXO Cel</option>
                <option value="Virgin">Virgin</option>
                <option value="Rincel">Rincel</option>
              </select>
              <p id="notaTelcel" class="hidden mt-2 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg p-3">
                Cliente <b>Telcel</b> actual: derivar a <b>upsell/recargas</b>.
              </p>
            </div>

            <!-- Preguntas -->
            <div id="encuestaContent" class="mt-5 space-y-4"></div>

            <!-- Resultado -->
            <div id="encuestaResultado" class="mt-5 hidden">
              <div class="rounded-xl border border-slate-200 p-4">
                <p class="text-sm text-slate-600">Score de severidad:</p>
                <p class="text-2xl font-semibold text-[#003b8f]"><span id="scoreVal">0.00</span></p>
                <p id="pitchVal" class="mt-2 text-slate-700"></p>
                <p id="planVal" class="mt-1 text-[#003b8f] font-semibold"></p>
              </div>
              <div class="flex flex-wrap gap-3 mt-4">
                <button id="aceptaCambio" class="px-4 py-2 bg-[#0a2f6b] text-white rounded-lg">Aceptar cambio</button>
                <button id="rechazaCambio" class="px-4 py-2 bg-slate-300 text-slate-800 rounded-lg">No aceptar</button>
                <button id="irAFichaDesdeEncuesta" class="px-4 py-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50">Ir a ficha</button>
              </div>
            </div>
          </div>

          <!-- Ficha de captura -->
          <div id="ficha" class="hidden rounded-2xl bg-white shadow-sm p-6 border border-slate-100">
            <h2 class="text-lg font-semibold text-slate-700">Ficha de captura</h2>
            <form id="formFicha" class="mt-4 space-y-4">

              <!-- Plaza -->
              <div>
                <label class="block text-sm font-medium text-slate-600">Plaza <span class="text-red-500">*</span></label>
                <select id="plaza" required class="w-full rounded-lg border-slate-300">
                  <option value="">Seleccione...</option>
                  <option>MONTERREY</option>
                  <option>MANTE</option>
                  <option>REYNOSA</option>
                  <option>MATAMOROS</option>
                  <option>SALTILLO</option>
                  <option>CHIHUAHUA</option>
                  <option>DELICIAS</option>
                  <option>CUAHUTEMOC</option>
                  <option>TAMPICO</option>
                </select>
              </div>

              <!-- Carrier -->
              <div>
                <label class="block text-sm font-medium text-slate-600">Compañía actual (Carrier) <span class="text-red-500">*</span></label>
                <select id="carrier" required class="w-full rounded-lg border-slate-300">
                  <option value="">Seleccione...</option>
                  <option>Telcel</option>
                  <option>Movistar</option>
                  <option>AT&T</option>
                  <option>Unefon</option>
                  <option>Bait</option>
                  <option>OXXO Cel</option>
                  <option>Virgin</option>
                  <option>Rincel</option>
                </select>
              </div>

              <!-- Nombre / Teléfono -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-600">Nombre completo <span class="text-red-500">*</span></label>
                  <input type="text" id="nombreCompleto" required class="w-full rounded-lg border-slate-300" placeholder="Nombre y apellidos" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-600">Teléfono (10 dígitos) <span class="text-red-500">*</span></label>
                  <input type="text" id="telefono" maxlength="10" inputmode="numeric" pattern="[0-9]*" required class="w-full rounded-lg border-slate-300" placeholder="Ej. 8112345678" />
                </div>
              </div>

              <!-- Nacimiento -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-600">Fecha de nacimiento <span class="text-red-500">*</span></label>
                  <input type="date" id="fechaNacimiento" required class="w-full rounded-lg border-slate-300" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-600">Estado de nacimiento <span class="text-red-500">*</span></label>
                  <select id="estadoNacimiento" required class="w-full rounded-lg border-slate-300">
                    <option value="">Seleccione...</option>
                    <option>Aguascalientes</option><option>Baja California</option><option>Baja California Sur</option>
                    <option>Campeche</option><option>Coahuila</option><option>Colima</option><option>Chiapas</option>
                    <option>Chihuahua</option><option>Ciudad de México</option><option>Durango</option><option>Guanajuato</option>
                    <option>Guerrero</option><option>Hidalgo</option><option>Jalisco</option><option>México</option>
                    <option>Michoacán</option><option>Morelos</option><option>Nayarit</option><option>Nuevo León</option>
                    <option>Oaxaca</option><option>Puebla</option><option>Querétaro</option><option>Quintana Roo</option>
                    <option>San Luis Potosí</option><option>Sinaloa</option><option>Sonora</option><option>Tabasco</option>
                    <option>Tamaulipas</option><option>Tlaxcala</option><option>Veracruz</option><option>Yucatán</option><option>Zacatecas</option>
                  </select>
                </div>
              </div>

              <!-- CURP / ICC / NIP -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-600">CURP (opcional)</label>
                  <input type="text" id="curp" class="w-full rounded-lg border-slate-300 uppercase" placeholder="En mayúsculas" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-600">ICC (20 dígitos) <span class="text-red-500">*</span></label>
                  <div class="flex gap-2">
                    <input type="text" id="icc" maxlength="20" inputmode="numeric" pattern="[0-9]*" required class="w-full rounded-lg border-slate-300" placeholder="Escríbelo o escanéalo" />
                    <button type="button" id="btnScanICC" class="px-3 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Escanear</button>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-600">NIP (4 dígitos) <span class="text-red-500">*</span></label>
                  <input type="text" id="nip" maxlength="4" inputmode="numeric" pattern="[0-9]*" required class="w-full rounded-lg border-slate-300" placeholder="Ej. 1234" />
                </div>
              </div>

              <!-- Promotor -->
              <div>
                <label class="block text-sm font-medium text-slate-600">Promotor (opcional)</label>
                <input type="text" id="promotor" class="w-full rounded-lg border-slate-300" placeholder="Nombre del promotor" />
              </div>

              <button type="submit" class="w-full py-3 bg-[#0a2f6b] text-white rounded-xl hover:bg-[#003b8f]">Crear ficha</button>
            </form>
          </div>

        </section>

        <!-- Lateral: Leads locales -->
        <aside class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
          <h3 class="font-semibold text-slate-700">Leads capturados (local)</h3>
          <ul id="listaLeads" class="mt-3 space-y-2 text-sm"></ul>
          <button id="limpiarLeads" class="mt-3 w-full rounded-xl bg-white border border-slate-200 py-2 text-sm hover:bg-slate-50">Limpiar lista local</button>
        </aside>
      </div>
    </main>
  </div>

  <!-- Modal ticket -->
  <div id="ticketModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="glass bg-white rounded-2xl shadow-lg max-w-lg w-full overflow-hidden">
      <div class="p-5 bg-gradient-to-r from-[#0a2f6b] to-[#003b8f] text-white">
        <h3 class="text-lg font-semibold">Ficha creada</h3>
        <p class="text-white/80 text-sm">Guarda un screenshot si lo requieres.</p>
      </div>
      <div class="p-6 space-y-2 text-slate-700 text-sm" id="ticketContent"></div>
      <div class="p-4 bg-slate-50 flex justify-end">
        <button id="cerrarModal" class="px-4 py-2 bg-[#0a2f6b] text-white rounded-lg hover:bg-[#003b8f]">Listo</button>
      </div>
    </div>
  </div>

  <!-- Modal Scanner ICC -->
  <div id="scanModal" class="hidden fixed inset-0 bg-black/50 z-50 items-center justify-center">
    <div class="glass bg-white rounded-2xl shadow-lg w-full max-w-md p-5">
      <h3 class="text-lg font-semibold text-[#0a2f6b]">Escanear ICC</h3>
      <p id="scanHint" class="text-sm text-slate-600 mt-1">Apunta la cámara al código (Code128/EAN).</p>
      <div class="mt-3 rounded-xl overflow-hidden bg-black aspect-video">
        <video id="scanVideo" autoplay playsinline class="w-full h-full object-cover"></video>
      </div>
      <div id="scanFallback" class="hidden mt-3 text-amber-700 bg-amber-50 border border-amber-200 p-3 rounded-lg">
        Sin soporte nativo de <code>BarcodeDetector</code>. Ingrese el ICC manualmente.
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="cerrarScan" class="px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- JS embebido -->
  <script>
    // ====== CONFIG ======
    const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxHJzcgu_8ZHJXieXeeo1gNk2r0TYmDr4u8TdyuQC9GTyOge5wv7q-fHeMeRLgGMfdyrg/exec";
    const VALID_PLAZAS = ['MONTERREY','MANTE','REYNOSA','MATAMOROS','SALTILLO','CHIHUAHUA','DELICIAS','CUAHUTEMOC','TAMPICO'];

    // ====== Navegación portada ======
    const portada  = document.getElementById("portada");
    const encuesta = document.getElementById("encuesta");
    const ficha    = document.getElementById("ficha");
    document.getElementById("btnEncuesta").onclick = () => { portada.classList.add("hidden"); encuesta.classList.remove("hidden"); };
    document.getElementById("btnFicha").onclick    = () => { portada.classList.add("hidden"); ficha.classList.remove("hidden"); };

    // ====== Encuesta ======
    const QUESTION_BANK = {
      "Movistar": [
        { q: "¿Se te corta la señal en tu zona?", weights: { "Sí":1.0, "A veces":0.6, "No":0.0 } },
        { q: "¿Tus datos se acaban antes de fin de mes?", weights: { "Sí":1.0, "A veces":0.5, "No":0.0 } },
        { q: "¿Has tenido problemas con la portabilidad o servicio al cliente?", weights: { "Sí":0.8, "A veces":0.4, "No":0.0 } },
        { q: "¿Pagas más de lo que usas realmente?", weights: { "Sí":0.7, "A veces":0.4, "No":0.0 } },
      ],
      "AT&T": [
        { q: "¿La cobertura dentro de edificios es deficiente?", weights: { "Sí":1.0, "A veces":0.5, "No":0.0 } },
        { q: "¿La velocidad de datos te resulta lenta?", weights: { "Sí":0.9, "A veces":0.5, "No":0.0 } },
        { q: "¿Tu factura sube por cargos extra?", weights: { "Sí":0.7, "A veces":0.4, "No":0.0 } },
      ],
      "Unefon": [
        { q: "¿Se te corta la señal frecuentemente?", weights: { "Sí":1.0, "A veces":0.6, "No":0.0 } },
        { q: "¿La red se satura en horas pico?", weights: { "Sí":0.8, "A veces":0.5, "No":0.0 } },
        { q: "¿Te limitan apps o velocidad?", weights: { "Sí":0.8, "A veces":0.4, "No":0.0 } },
      ],
      "Bait": [
        { q: "¿La cobertura fuera de ciudad es irregular?", weights: { "Sí":1.0, "A veces":0.5, "No":0.0 } },
        { q: "¿Notas caídas de red en tienda o interiores?", weights: { "Sí":0.9, "A veces":0.5, "No":0.0 } },
        { q: "¿El soporte tarda en responder?", weights: { "Sí":0.7, "A veces":0.4, "No":0.0 } },
      ],
      "OXXO Cel": [
        { q: "¿Sientes la red inestable en tu colonia?", weights: { "Sí":1.0, "A veces":0.6, "No":0.0 } },
        { q: "¿Se te terminan los megas rápido?", weights: { "Sí":0.9, "A veces":0.5, "No":0.0 } },
        { q: "¿Requieres WhatsApp/Redes ilimitadas y no las tienes?", weights: { "Sí":0.8, "A veces":0.5, "No":0.0 } },
      ],
      "Virgin": [
        { q: "¿Tienes zonas muertas en casa/trabajo?", weights: { "Sí":1.0, "A veces":0.6, "No":0.0 } },
        { q: "¿Te quedas sin datos antes de tiempo?", weights: { "Sí":0.9, "A veces":0.5, "No":0.0 } },
        { q: "¿No te alcanza la vigencia de tus paquetes?", weights: { "Sí":0.7, "A veces":0.4, "No":0.0 } },
      ],
      "Rincel": [
        { q: "¿Se cae la red en eventos o multitudes?", weights: { "Sí":1.0, "A veces":0.6, "No":0.0 } },
        { q: "¿La atención a clientes no resuelve?", weights: { "Sí":0.9, "A veces":0.5, "No":0.0 } },
        { q: "¿El costo/beneficio no te convence?", weights: { "Sí":0.8, "A veces":0.4, "No":0.0 } },
      ],
    };

    function planSugerido(score, carrier) {
      let plan = score >= 70 ? "Amigo Sin Límite 150" :
                 score >= 40 ? "Amigo Sin Límite 100" : "Amigo Sin Límite 80";
      const pitch = score >= 70
        ? `Tu experiencia con ${carrier} muestra varios dolores. Con Telcel obtienes mejor cobertura y más gigas por tu uso real.`
        : score >= 40
          ? `Hay señales de mejora posible. Cambiando a Telcel tienes red más estable y beneficios sociales ilimitados.`
          : `Vas relativamente bien, pero puedes mejorar cobertura y apps ilimitadas con un paquete adecuado en Telcel.`;
      return { plan, pitch };
    }

    const encuestaCarrier = document.getElementById("encuestaCarrier");
    const encuestaContent = document.getElementById("encuestaContent");
    const encuestaResultado = document.getElementById("encuestaResultado");
    const scoreVal = document.getElementById("scoreVal");
    const pitchVal = document.getElementById("pitchVal");
    const planVal = document.getElementById("planVal");
    const notaTelcel = document.getElementById("notaTelcel");

    encuestaCarrier.addEventListener("change", () => {
      const c = encuestaCarrier.value;
      encuestaContent.innerHTML = "";
      encuestaResultado.classList.add("hidden");
      notaTelcel.classList.add("hidden");
      if (!c) return;

      if (c === "Telcel") {
        notaTelcel.classList.remove("hidden");
        return;
      }

      const qs = QUESTION_BANK[c] || [];
      qs.forEach((item, idx) => {
        const block = document.createElement("div");
        block.className = "rounded-xl border border-slate-200 p-4";
        block.innerHTML = `
          <p class="font-medium text-slate-700">${item.q}</p>
          <div class="mt-2 flex gap-2 flex-wrap">
            ${["Sí","A veces","No"].map(lbl => `
              <button type="button" data-q="${idx}" data-a="${lbl}"
                class="ans px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">${lbl}</button>
            `).join("")}
          </div>
        `;
        encuestaContent.appendChild(block);
      });

      encuestaContent.querySelectorAll(".ans").forEach(btn => {
        btn.addEventListener("click", () => {
          const group = btn.closest(".rounded-xl");
          group.querySelectorAll(".ans").forEach(b => b.classList.remove("!bg-[#003b8f]","!text-white","!border-[#003b8f]"));
          btn.classList.add("!bg-[#003b8f]","!text-white","!border-[#003b8f]");

          // Calcular score en tiempo real
          const answers = [];
          encuestaContent.querySelectorAll(".ans").forEach(b => {
            if (b.classList.contains("!bg-[#003b8f]")) answers.push({ idx: Number(b.dataset.q), a: b.dataset.a });
          });

          if (!answers.length) return;
          let sum = 0, count = 0;
          const qsNow = QUESTION_BANK[c] || [];
          answers.forEach(ans => {
            const w = qsNow[ans.idx]?.weights?.[ans.a] ?? 0;
            sum += w * 100;
            count += 1;
          });
          const score = count ? (sum / count) : 0;
          scoreVal.textContent = score.toFixed(2);
          const { plan, pitch } = planSugerido(score, c);
          pitchVal.textContent = pitch;
          planVal.textContent = `Recomendación de plan: ${plan}`;
          encuestaResultado.classList.remove("hidden");
        });
      });
    });

    document.getElementById("aceptaCambio").onclick = () => {
      encuesta.classList.add("hidden");
      ficha.classList.remove("hidden");
      const c = encuestaCarrier.value;
      if (c) document.getElementById("carrier").value = c;
    };
    document.getElementById("rechazaCambio").onclick = () => alert("Gracias");
    document.getElementById("irAFichaDesdeEncuesta").onclick = () => {
      encuesta.classList.add("hidden");
      ficha.classList.remove("hidden");
      const c = encuestaCarrier.value;
      if (c) document.getElementById("carrier").value = c;
    };

    // ====== Helpers comunes ======
    const onlyDigits = (s) => String(s || "").replace(/\D+/g, "");
    const toUpper    = (s) => String(s || "").toUpperCase().trim();

    // ====== LocalStorage ======
    const LS_KEY = "mada_porta_leads";
    const renderLeads = () => {
      const ul = document.getElementById("listaLeads");
      ul.innerHTML = "";
      const leads = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      if (!leads.length) {
        ul.innerHTML = '<li class="text-slate-500">Sin registros todavía.</li>';
        return;
      }
      leads.forEach(l => {
        const li = document.createElement("li");
        let color = "text-blue-600";
        const e = (l.estatus || "").toLowerCase();
        if (e.includes("confirmado")) color = "text-green-600";
        if (e.includes("rechaz"))     color = "text-red-600";
        li.innerHTML = `<span class="${color}">●</span> ${l.ts} — ${l.nombre} (${l.tel}) [${l.carrier}/${l.plaza}] ICC:${l.icc}`;
        ul.appendChild(li);
      });
    };
    document.getElementById("limpiarLeads").onclick = () => { localStorage.removeItem(LS_KEY); renderLeads(); };

    // ====== Ticket ======
    function mostrarTicket(rec) {
      const modal   = document.getElementById("ticketModal");
      const content = document.getElementById("ticketContent");
      content.innerHTML = `
        <div class="flex items-center justify-between"><span class="text-slate-600">Teléfono • NIP</span><span class="mono font-semibold">${rec.telefono} • ${rec.nip}</span></div>
        <div class="flex items-center justify-between"><span class="text-slate-600">ICC</span><span class="mono font-semibold">${rec.icc}</span></div>
        <div class="flex items-center justify-between"><span class="text-slate-600">Nombre completo</span><span class="font-semibold">${rec.nombreCompleto}</span></div>
        <div class="flex items-center justify-between"><span class="text-slate-600">Plaza • Carrier</span><span class="font-semibold">${rec.plaza} • ${rec.carrier}</span></div>
        <div class="flex items-center justify-between"><span class="text-slate-600">Nacimiento</span><span class="font-semibold">${rec.fechaNacimiento} • ${rec.estadoNacimiento}</span></div>
        <div class="flex items-center justify-between"><span class="text-slate-600">Promotor</span><span class="font-semibold">${rec.promotor || "—"}</span></div>
      `;
      modal.classList.remove("hidden");
      document.getElementById("cerrarModal").onclick = () => {
        modal.classList.add("hidden");
        document.getElementById("formFicha").reset();
        ficha.classList.add("hidden");
        portada.classList.remove("hidden");
      };
    }

    // ====== Scanner ICC ======
    const scanModal = document.getElementById("scanModal");
    const scanVideo = document.getElementById("scanVideo");
    const scanFallback = document.getElementById("scanFallback");
    const scanHint = document.getElementById("scanHint");
    let scanStream = null, rafId = null, detector = null, scanning = false;

    async function startScan() {
      scanModal.classList.remove("hidden");
      scanModal.classList.add("flex");
      scanFallback.classList.add("hidden");
      scanHint.textContent = "Apunta la cámara al código (Code128/EAN).";

      if (!("BarcodeDetector" in window)) {
        scanFallback.classList.remove("hidden");
        scanHint.textContent = "Sin soporte nativo. Ingrese el ICC manualmente.";
        return;
      }

      try {
        detector = new BarcodeDetector({ formats: ['code_128','ean_13','ean_8','upc_a','upc_e','code_39'] });
      } catch {
        scanFallback.classList.remove("hidden");
        scanHint.textContent = "Sin soporte nativo. Ingrese el ICC manualmente.";
        return;
      }

      try {
        scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        scanVideo.srcObject = scanStream;
        scanning = true;
        const tick = async () => {
          if (!scanning) return;
          try {
            const barcodes = await detector.detect(scanVideo);
            if (barcodes && barcodes.length) {
              const raw = barcodes[0].rawValue || "";
              const digits = raw.replace(/\D+/g,"").slice(0,20);
              if (digits.length >= 18) {
                document.getElementById("icc").value = digits.slice(0,20);
                stopScan();
              }
            }
          } catch (e) {}
          rafId = requestAnimationFrame(tick);
        };
        rafId = requestAnimationFrame(tick);
      } catch (err) {
        console.error(err);
        scanFallback.classList.remove("hidden");
        scanHint.textContent = "No fue posible usar la cámara. Ingrese manualmente.";
      }
    }

    function stopScan() {
      scanning = false;
      if (rafId) cancelAnimationFrame(rafId);
      if (scanStream) {
        scanStream.getTracks().forEach(t => t.stop());
        scanStream = null;
      }
      scanModal.classList.add("hidden");
      scanModal.classList.remove("flex");
    }

    document.getElementById("btnScanICC").onclick = startScan;
    document.getElementById("cerrarScan").onclick = stopScan;

    // ====== Envío a GAS (con retry JSON si el urlencoded falla) ======
    document.getElementById("formFicha").addEventListener("submit", async (e) => {
      e.preventDefault();

      const plaza            = document.getElementById("plaza").value.trim();
      const carrier          = document.getElementById("carrier").value.trim();
      const nombreCompleto   = document.getElementById("nombreCompleto").value.trim();
      const telefono         = onlyDigits(document.getElementById("telefono").value).slice(0,10);
      const fechaNacimiento  = document.getElementById("fechaNacimiento").value;
      const estadoNacimiento = document.getElementById("estadoNacimiento").value.trim();
      const curp             = toUpper(document.getElementById("curp").value);
      const icc              = onlyDigits(document.getElementById("icc").value).slice(0,20);
      const nip              = onlyDigits(document.getElementById("nip").value).slice(0,4);
      const promotor         = document.getElementById("promotor").value.trim();

      if (!plaza) return alert("Selecciona una plaza.");
      if (!VALID_PLAZAS.includes(plaza)) return alert("Plaza inválida. Selecciona una válida.");
      if (!carrier) return alert("Selecciona la compañía actual.");
      if (!nombreCompleto) return alert("Escribe el nombre completo.");
      if (telefono.length !== 10) return alert("El teléfono debe tener 10 dígitos.");
      if (!fechaNacimiento) return alert("Selecciona la fecha de nacimiento.");
      if (!estadoNacimiento) return alert("Selecciona el estado de nacimiento.");
      if (icc.length !== 20) return alert("El ICC debe tener 20 dígitos.");
      if (nip.length !== 4) return alert("El NIP debe tener 4 dígitos.");

      const record = {
        type: "capture",
        plaza, carrier, nombreCompleto, telefono,
        fechaNacimiento, estadoNacimiento,
        curp, icc, nip, promotor,
        estatus: "Portabilidad iniciada"
      };

      async function tryPostFormUrlEncoded() {
        const body = "payload=" + encodeURIComponent(JSON.stringify(record));
        const res  = await fetch(SHEETS_WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });
        const raw = await res.text();
        let data; try { data = JSON.parse(raw); } catch { data = null; }
        console.log("[POST-urlencoded] status:", res.status, "raw:", raw, "data:", data);
        return {res, raw, data};
      }

      async function tryPostJson() {
        const res  = await fetch(SHEETS_WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(record)
        });
        const raw = await res.text();
        let data; try { data = JSON.parse(raw); } catch { data = null; }
        console.log("[POST-json] status:", res.status, "raw:", raw, "data:", data);
        return {res, raw, data};
      }

      try {
        // 1) Intento urlencoded (lo que espera GAS en getPayload_)
        let {res, raw, data} = await tryPostFormUrlEncoded();

        // 2) Si no trae ok:true, reintenta con JSON
        if (!data || data.ok !== true) { ({res, raw, data} = await tryPostJson()); }

        if (!data) {
          alert("No se pudo interpretar la respuesta del servidor.\nRevisa la consola (F12) para ver el detalle.");
          return;
        }
        if (data.ok !== true) {
          alert("Error al enviar: " + (data.error || "sin detalle"));
          return;
        }

        // Éxito → ticket + persistencia local
        mostrarTicket(record);

        const leads = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
        leads.unshift({
          ts: new Date().toLocaleString(),
          nombre: record.nombreCompleto,
          tel: record.telefono,
          carrier: record.carrier,
          plaza: record.plaza,
          icc: record.icc.slice(-6),
          estatus: record.estatus
        });
        localStorage.setItem(LS_KEY, JSON.stringify(leads.slice(0,12)));
        renderLeads();

      } catch (err) {
        console.error(err);
        alert("No se pudo enviar a Sheets. Inténtalo de nuevo.");
      }
    });

    // Init
    renderLeads();
  </script>
</body>
</html>
