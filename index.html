<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MADA OCR ‚Äì Recolector Inteligente</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <style>
    body{background:#0b1220;color:#e5e7eb;font-family:Poppins,system-ui;margin:0;padding:20px}
    .card{max-width:960px;margin:auto;background:#111827;border-radius:20px;padding:20px;border:1px solid #1e293b}
    h1{margin-top:0}
    input,button{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#fff}
    button{background:#3b82f6;border:none;cursor:pointer;font-weight:600}
    button.secondary{background:#0f172a;border:1px dashed #475569}
    #log{font-family:monospace;background:#0e1526;border-radius:10px;padding:10px;margin-top:10px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="card">
    <h1>üì∏ MADA OCR ‚Äì Recolector Inteligente (Versi√≥n Precisi√≥n Alta)</h1>
    <p>Sube tu captura de <b>Resumen del Tr√°mite BES</b>. El sistema limpiar√° la imagen y extraer√° Tel√©fono, ICCID y CURP con precisi√≥n.</p>

    <label>Promotor / Supervisor</label>
    <input id="promotor" placeholder="Ej. Fernanda" />

    <label style="margin-top:10px;">Seleccionar imagen</label>
    <input id="file" type="file" accept="image/*" />

    <button id="btn-ocr" style="margin-top:10px;">üîç Procesar OCR</button>
    <button id="btn-enviar" class="secondary" style="margin-top:10px;">üöÄ Enviar al backend</button>

    <div id="log"></div>
  </div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwqLB2XPdq3EH0MPR4Gw_b1upGU9FEfoYfAPqm5IKNs73cPuT7ruE8w3eHNuk07580/exec';
const fileInput = document.getElementById('file');
const logEl = document.getElementById('log');
const promotorEl = document.getElementById('promotor');
let telefono='', icc='', curp='';

function log(msg){ logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }

// üßΩ Mejora de imagen: binarizaci√≥n + realce de contraste
async function preprocessImage(file){
  const img = await createImageBitmap(file);
  const canvas = document.createElement('canvas');
  canvas.width = img.width; canvas.height = img.height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img,0,0);
  const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = imgData.data;

  // Filtro adaptativo tipo Otsu simple
  for(let i=0;i<data.length;i+=4){
    const avg = (data[i]+data[i+1]+data[i+2])/3;
    const val = avg>160 ? 255 : 0;
    data[i]=data[i+1]=data[i+2]=val;
  }
  ctx.putImageData(imgData,0,0);
  return canvas;
}

// üß† Detecci√≥n robusta de patrones
function extractData(text){
  telefono = (text.match(/\b\d{10}\b/)||[''])[0];
  icc = (text.match(/89\d{17,18}/)||[''])[0];
  curp = (text.match(/[A-Z]{4}\d{6}[A-Z0-9]{8}/i)||[''])[0];
}

document.getElementById('btn-ocr').addEventListener('click', async ()=>{
  const file = fileInput.files[0];
  if(!file){alert('Selecciona una imagen.');return;}
  logEl.textContent='‚è≥ Procesando... esto puede tardar unos segundos.\n';
  const cnv = await preprocessImage(file);
  const dataUrl = cnv.toDataURL('image/png');

  const result = await Tesseract.recognize(dataUrl,'spa+eng',{
    tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789',
  });

  const text = result.data.text.replace(/\s+/g,' ');
  console.log('Texto reconocido:', text);
  log(`‚úÖ OCR completado.\nTexto reconocido:\n${text}\n`);
  extractData(text);
  log(`üì± Tel√©fono: ${telefono||'‚Äî'}\nüí≥ ICCID: ${icc||'‚Äî'}\nüßæ CURP: ${curp||'‚Äî'}`);
});

document.getElementById('btn-enviar').addEventListener('click', async ()=>{
  const promotor = promotorEl.value.trim();
  if(!promotor || !telefono || !icc){ alert('Faltan datos v√°lidos. Aseg√∫rate de procesar la imagen correctamente.'); return; }

  const payload = {promotor, telefono, icc};
  log('üöÄ Enviando al backend...');
  try{
    await fetch(WEBAPP_URL,{
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json; charset=utf-8'},
      body: JSON.stringify(payload)
    });
    log('‚úÖ Registro enviado correctamente (UTF-8).');
  }catch(err){
    log('‚ùå Error al enviar: '+err.message);
  }
});
</script>
</body>
</html>
