<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MADA — Captura y Portabilidad</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --brand-blue:#003b8f;
      --brand-blue-700:#0a2f6b;
      --brand-cyan:#00aeef;
      --brand-soft:#e9f3ff;
      --ok:#10b981;
    }
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    .glass{ backdrop-filter: blur(8px); background: rgb(255 255 255 / 0.85); }
    .backdrop{ position:fixed; inset:0; background: rgb(0 0 0 / 0.6); display:none; align-items:center; justify-content:center; z-index:50; }
    .fade-in{ animation: fadeIn .2s ease-in; }
    @keyframes fadeIn{ from{opacity:.3; transform: translateY(2px);} to{opacity:1; transform: translateY(0);} }
    .checkmark{
      width:78px;height:78px;border-radius:9999px;border:6px solid var(--ok); position:relative; display:grid; place-items:center;
    }
    .checkmark:after{
      content:""; width:28px;height:14px; border-left:6px solid var(--ok); border-bottom:6px solid var(--ok);
      transform: rotate(-45deg); position:absolute; top:26px; left:22px;
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <!-- Topbar -->
  <header class="bg-gradient-to-r from-[var(--brand-blue)] to-[var(--brand-blue-700)] text-white">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div id="btnHome" class="h-8 w-8 rounded-full bg-white/10 grid place-items-center font-black cursor-pointer hover:bg-white/20 transition" title="Ir al inicio">M</div>
        <div class="leading-tight">
          <h1 class="text-lg font-semibold">MADA</h1>
          <p class="text-xs text-white/70">Desarrollando el talento humano</p>
        </div>
      </div>
      <div class="text-xs opacity-0 select-none">.</div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Portada -->
    <section id="startBlock" class="bg-white rounded-2xl shadow-sm border p-6 sm:p-8 fade-in">
      <div class="flex flex-col items-center text-center gap-4">
        <h2 class="text-2xl font-bold text-[var(--brand-blue)]">¿Cómo quieres continuar?</h2>
        <p class="text-sm text-slate-600 max-w-prose">
          Puedes omitir la encuesta y pasar directo a la ficha de captura.
        </p>
        <div class="flex flex-col sm:flex-row gap-3">
          <button id="btnSkipToCapture" class="px-5 py-2.5 rounded-xl bg-[var(--brand-blue)] text-white hover:bg-[var(--brand-blue-700)]">Ir a ficha de captura</button>
        </div>
      </div>
    </section>

    <!-- Captura -->
    <section id="captureBlock" class="hidden bg-white rounded-2xl border shadow-sm p-5 space-y-6">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Ficha de captura</h3>
        <span class="text-xs text-slate-500">Solo se guardan los datos solicitados</span>
      </div>

      <!-- Carrier -->
      <div>
        <label class="block text-sm font-semibold mb-2">Compañía del cliente</label>
        <select id="carrier" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none">
          <option value="">Selecciona...</option>
          <option>Telcel</option>
          <option>Movistar</option>
          <option>AT&T</option>
          <option>Unefon</option>
          <option>Bait</option>
          <option>OXXO Cel</option>
          <option>Virgin</option>
          <option>Rincel</option>
        </select>
      </div>

      <!-- Modo -->
      <div class="flex flex-wrap items-center gap-5 text-sm">
        <span class="font-medium">Modo:</span>
        <label class="flex items-center gap-2"><input type="radio" name="capMode" value="curp" class="capMode" checked> Solo CURP</label>
        <label class="flex items-center gap-2"><input type="radio" name="capMode" value="full" class="capMode"> Datos para CURP</label>
      </div>

      <!-- Datos del cliente -->
      <div class="grid sm:grid-cols-3 gap-3">
        <input id="capNombre"      class="border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none" placeholder="Nombre(s)" />
        <input id="capApPaterno"   class="border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none" placeholder="Apellido paterno" />
        <input id="capApMaterno"   class="border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none" placeholder="Apellido materno" />
      </div>

      <!-- Tel, CURP (solo en modo CURP) -->
      <div class="grid sm:grid-cols-2 gap-3">
        <input id="capTelefono"    class="border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none" placeholder="Teléfono (10 dígitos)" inputmode="numeric" maxlength="10" />
        <input id="capCurp"        class="border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none" placeholder="CURP (18 caracteres)" />
      </div>

      <!-- ICC + NIP + Promotor -->
      <div class="grid sm:grid-cols-3 gap-3">
        <div class="flex gap-2">
          <input id="capICC" class="flex-1 border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none" placeholder="ICC (SIM, 20 dígitos)" inputmode="numeric" maxlength="20" />
          <button id="btnScanICC" type="button" class="px-3 py-2 rounded-xl border hover:bg-slate-50">Esc.</button>
        </div>
        <input id="capNip"         class="border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none" placeholder="NIP (4 dígitos)" inputmode="numeric" maxlength="4" />
        <input id="capPromotor"    class="border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--brand-cyan)] focus:border-transparent outline-none" placeholder="Nombre del promotor" />
      </div>

      <div class="flex justify-end gap-2">
        <button id="btnCancelCapture" class="px-3 py-2 rounded-xl border text-sm hover:bg-slate-50">Cancelar</button>
        <button id="btnSaveCapture"   class="px-3 py-2 rounded-xl bg-[var(--brand-blue)] text-white text-sm hover:bg-[var(--brand-blue-700)]">Guardar captura</button>
      </div>

      <div class="text-xs opacity-70">
        Se guardan en Sheets: <strong>Fecha de captura, Número, Nombre, Ap. paterno, Ap. materno, CURP (si aplica), ICC, NIP y Carrier.</strong>
      </div>
    </section>
  </main>

  <!-- Modal Éxito -->
  <div id="okModal" class="backdrop">
    <div class="glass rounded-2xl shadow-xl w-full max-w-md p-6 border fade-in text-center">
      <div class="mx-auto checkmark mb-4"></div>
      <h3 class="text-xl font-semibold text-[var(--brand-blue)]">¡Éxito! Ficha enviada</h3>
      <p class="text-sm text-slate-600 mt-1">Toma una captura para tu evidencia.</p>
      <div class="mt-4 text-sm bg-slate-50 border rounded-xl p-3 text-left">
        <div><span class="font-semibold">Número: </span><span id="okNumero">—</span></div>
        <div><span class="font-semibold">ICC: </span><span id="okICC">—</span></div>
        <div><span class="font-semibold">Promotor: </span><span id="okPromotor">—</span></div>
      </div>
      <div class="mt-5">
        <button id="btnOkClose" class="px-4 py-2 rounded-xl bg-[var(--brand-blue)] text-white hover:bg-[var(--brand-blue-700)]">Listo</button>
      </div>
    </div>
  </div>

  <!-- Modal Scanner -->
  <div id="scanModal" class="backdrop">
    <div class="glass rounded-2xl shadow-xl w-full max-w-md p-4 border">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Escanear código de barras (ICC)</h3>
        <button id="btnCloseScan" class="text-sm px-2 py-1 rounded-lg border bg-white/70">Cerrar</button>
      </div>
      <div id="scanSupport" class="text-sm opacity-70 mb-2"></div>
      <video id="scanVideo" class="w-full rounded-xl bg-black aspect-video" playsinline></video>
      <div class="text-xs opacity-60 mt-2">Enfoca el código del SIM. Al detectar, se llenará el ICC automáticamente.</div>
    </div>
  </div>

  <script>
    /* ============ URL FIJA DEL WEBHOOK (Apps Script) ============ */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby1iL0kw-m2IUmlS1nnDPnQe4HVyLK6D7CfaxgXhDdCLCu2ssLnLAdhrhd__PO4q7sFfg/exec';

    /* ============ Helpers de DOM ============ */
    const el = id => document.getElementById(id);

    // Elementos
    const startBlock = el('startBlock');
    const captureBlock = el('captureBlock');
    const btnSkipToCapture = el('btnSkipToCapture');
    const btnHome = el('btnHome');

    const carrier = el('carrier');
    const modeRadios = document.querySelectorAll('.capMode');

    const capNombre = el('capNombre');
    const capApPaterno = el('capApPaterno');
    const capApMaterno = el('capApMaterno');
    const capTelefono = el('capTelefono');
    const capCurp = el('capCurp');
    const capICC = el('capICC');
    const capNip = el('capNip');
    const capPromotor = el('capPromotor');

    const btnCancelCapture = el('btnCancelCapture');
    const btnSaveCapture = el('btnSaveCapture');

    // Modal éxito
    const okModal = el('okModal');
    const okNumero = el('okNumero');
    const okICC = el('okICC');
    const okPromotor = el('okPromotor');
    const btnOkClose = el('btnOkClose');

    // Scanner
    const scanModal = el('scanModal');
    const scanVideo = el('scanVideo');
    const btnScanICC = el('btnScanICC');
    const btnCloseScan = el('btnCloseScan');
    const scanSupport = el('scanSupport');
    let scanStream = null, scanning = false, detector = null;

    /* ============ Init ============ */
    document.addEventListener('DOMContentLoaded', () => {
      btnSkipToCapture.addEventListener('click', () => {
        startBlock.classList.add('hidden');
        captureBlock.classList.remove('hidden');
        captureBlock.classList.add('fade-in');
        carrier.focus();
      });

      btnHome.addEventListener('click', () => {
        resetForm();
        window.scrollTo({top:0, behavior:'smooth'});
      });

      // Validaciones de entrada
      capTelefono.addEventListener('input', () => {
        capTelefono.value = capTelefono.value.replace(/\D/g,'').slice(0,10);
      });
      capICC.addEventListener('input', () => {
        capICC.value = capICC.value.replace(/\D/g,'').slice(0,20);
      });
      capNip.addEventListener('input', () => {
        capNip.value = capNip.value.replace(/\D/g,'').slice(0,4);
      });

      // Modo: mostrar/ocultar CURP
      modeRadios.forEach(r => r.addEventListener('change', updateCurpVisibility));
      updateCurpVisibility();

      // Botones guardar/cancelar
      btnCancelCapture.addEventListener('click', () => captureBlock.classList.add('hidden'));
      btnSaveCapture.addEventListener('click', onSaveCapture);

      // Modal OK
      btnOkClose.addEventListener('click', () => { okModal.style.display='none'; resetForm(); });

      // Scanner
      btnScanICC.addEventListener('click', openScanModal);
      btnCloseScan.addEventListener('click', closeScanModal);
      scanSupport.textContent = ('BarcodeDetector' in window)
        ? 'Soportado: Code128/EAN.'
        : 'Sin soporte nativo. Si no detecta, ingresa el ICC manualmente.';
    });

    function currentMode(){
      const r = Array.from(modeRadios).find(x => x.checked);
      return r ? r.value : 'curp';
    }

    function updateCurpVisibility(){
      const needCurp = currentMode()==='curp';
      capCurp.parentElement.style.display = needCurp ? '' : 'none';
      if (!needCurp) capCurp.value='';
    }

    async function onSaveCapture(){
      // Validaciones
      if(!carrier.value){ alert('Selecciona la compañía'); carrier.focus(); return; }
      if(!capNombre.value.trim()){ alert('Ingresa el nombre'); capNombre.focus(); return; }
      if(!capApPaterno.value.trim()){ alert('Ingresa el apellido paterno'); capApPaterno.focus(); return; }
      if(!capApMaterno.value.trim()){ alert('Ingresa el apellido materno'); capApMaterno.focus(); return; }
      if(!/^\d{10}$/.test(capTelefono.value)){ alert('Teléfono de 10 dígitos'); capTelefono.focus(); return; }

      const needCurp = currentMode()==='curp';
      if(needCurp){
        const v = capCurp.value.trim().toUpperCase();
        if(v.length!==18){ alert('CURP debe tener 18 caracteres'); capCurp.focus(); return; }
        capCurp.value = v;
      }

      if(capICC.value.length < 18){ alert('ICC debe tener al menos 18 dígitos (máx 20)'); capICC.focus(); return; }
      if(!/^\d{4}$/.test(capNip.value)){ alert('NIP debe ser de 4 dígitos'); capNip.focus(); return; }

      const record = {
        // SOLO los campos que tu Apps Script guarda
        telefono : capTelefono.value.trim(),
        nombre   : capNombre.value.trim(),
        apPaterno: capApPaterno.value.trim(),
        apMaterno: capApMaterno.value.trim(),
        curp     : (needCurp ? capCurp.value.trim().toUpperCase() : ''),
        icc      : capICC.value.trim(),
        nip      : capNip.value.trim(),
        carrier  : carrier.value.trim()
      };

      try{
        await fetch(SHEETS_WEBAPP_URL, {
          method:'POST',
          mode:'no-cors',
          headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
          body:'payload='+encodeURIComponent(JSON.stringify(record))
        });

        // Modal de éxito para evidencia
        okNumero.textContent  = record.telefono || '—';
        okICC.textContent     = record.icc      || '—';
        okPromotor.textContent= capPromotor.value.trim() || '—';
        okModal.style.display = 'flex';
      }catch(e){
        alert('No se pudo enviar la ficha. Revisa conexión e intenta de nuevo.');
        console.error(e);
      }
    }

    function resetForm(){
      startBlock.classList.remove('hidden');
      captureBlock.classList.add('hidden');

      carrier.value='';
      capNombre.value='';
      capApPaterno.value='';
      capApMaterno.value='';
      capTelefono.value='';
      capCurp.value='';
      capICC.value='';
      capNip.value='';
      capPromotor.value='';
      // default a "curp"
      modeRadios.forEach(r => r.checked = (r.value==='curp'));
      updateCurpVisibility();
    }

    /* ============ Scanner ICC ============ */
    async function openScanModal(){
      scanModal.style.display='flex';
      try{
        if('BarcodeDetector' in window){
          detector = new BarcodeDetector({formats:['code_128','ean_13','ean_8','upc_a','upc_e','code_39']});
        } else { detector = null; }
        scanStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        scanVideo.srcObject = scanStream;
        await scanVideo.play();
        scanning = true;
        requestAnimationFrame(scanLoop);
      }catch(e){
        alert('No se pudo acceder a la cámara. Otorga permisos o ingresa el ICC manualmente.');
        closeScanModal();
      }
    }

    async function scanLoop(){
      if(!scanning) return;
      try{
        if(detector && scanVideo.readyState === HTMLMediaElement.HAVE_ENOUGH_DATA){
          const codes = await detector.detect(scanVideo);
          if(codes && codes.length){
            const value = (codes[0].rawValue || '').replace(/\D/g,'').slice(0,20);
            if(value){
              capICC.value = value;
              closeScanModal();
              return;
            }
          }
        }
      }catch(_){}
      requestAnimationFrame(scanLoop);
    }

    function closeScanModal(){
      scanning=false;
      if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
      scanVideo.pause(); scanVideo.srcObject=null;
      scanModal.style.display='none';
    }
  </script>
</body>
</html>
