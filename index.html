<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MADA - Registro M√∫ltiple (40 Tr√°mites)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #6366f1;
            --secondary: #0ea5e9;
            --accent: #10b981;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --dark: #0f172a;
            --darker: #000000;
            --light: #f8fafc;
            --gray: #94a3b8;
            --text: #e2e8f0;
            --text-light: #94a3b8;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            padding: 0;
        }

        .app-container {
            max-width: 1400px;
            margin: 1rem auto;
            min-height: calc(100vh - 2rem);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            background: var(--dark);
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .logo-icon {
            font-size: 2rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .company-name { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem; }
        .app-title { font-size: 1.3rem; font-weight: 500; opacity: 0.9; margin-bottom: 0.5rem; }
        .app-subtitle { font-size: 1rem; opacity: 0.8; }
        .app-info { font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem; }

        .main-content { 
            flex: 1; 
            padding: 1.5rem; 
            display: flex; 
            flex-direction: column; 
            gap: 1.5rem; 
            overflow-y: auto;
        }

        .card {
            background: var(--darker);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text);
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary);
        }

        .card-title i { color: var(--primary-light); }

        /* Controles principales */
        .controls-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group { margin-bottom: 1.2rem; }
        .form-label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.95rem; color: var(--text-light); }
        .form-input {
            width: 100%;
            padding: 0.9rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }

        /* Upload Area mejorada */
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(79, 70, 229, 0.1);
            margin-bottom: 1rem;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-area:hover, .upload-area.dragover { 
            border-color: var(--primary-light); 
            background-color: rgba(79, 70, 229, 0.2); 
            transform: translateY(-2px);
        }

        .upload-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--secondary); }
        .upload-text { margin-bottom: 0.5rem; font-weight: 500; color: var(--text); font-size: 1.1rem; }
        .upload-hint { font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem; }
        .upload-count { 
            background: var(--primary); 
            color: white; 
            padding: 0.5rem 1rem; 
            border-radius: 20px; 
            font-weight: 600;
            margin-top: 1rem;
        }

        /* Tabla de registros */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            margin-top: 1rem;
        }

        .registros-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .registros-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .registros-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .registros-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .registros-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .registros-table input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-size: 0.9rem;
        }

        .registros-table input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        /* Contador de registros */
        .registros-counter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius);
            margin-top: 1rem;
        }

        .counter-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .counter-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #e2e8f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .counter-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* Botones */
        .btn { 
            padding: 0.9rem 1.5rem; 
            border-radius: var(--radius); 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem; 
            font-size: 1rem; 
        }

        .btn-primary { 
            background: linear-gradient(135deg, var(--accent) 0%, var(--success) 100%); 
            color: var(--darker); 
            box-shadow: var(--shadow); 
        }
        .btn-primary:hover { 
            background: linear-gradient(135deg, var(--accent) 0%, #047857 100%); 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-lg); 
        }
        
        .btn-secondary { 
            background: var(--primary); 
            color: white; 
        }
        .btn-secondary:hover { 
            background: var(--primary-dark); 
            color: white; 
            transform: translateY(-2px); 
            box-shadow: var(--shadow); 
        }
        
        .btn-warning { 
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); 
            color: white; 
        }
        .btn-warning:hover { 
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%); 
            transform: translateY(-2px); 
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%); 
            color: white; 
        }
        .btn-danger:hover { 
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); 
            transform: translateY(-2px); 
        }

        .btn:disabled { 
            background-color: var(--gray); 
            color: var(--text-light); 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
            opacity: 0.6;
        }

        .button-group { 
            display: flex; 
            gap: 1rem; 
            margin-top: 1.5rem; 
            flex-wrap: wrap;
        }
        
        .button-group .btn { flex: 1; min-width: 200px; }

        /* Progress */
        .progress-container { 
            margin-top: 1.5rem; 
            display: none; 
        }
        .progress-bar { 
            height: 10px; 
            background-color: rgba(255, 255, 255, 0.1); 
            border-radius: 5px; 
            overflow: hidden; 
            margin-bottom: 0.5rem; 
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); 
            width: 0%; 
            transition: width 0.3s ease; 
            border-radius: 5px; 
        }
        .progress-text { 
            font-size: 0.9rem; 
            color: var(--text-light); 
            text-align: center; 
        }

        /* Results Summary */
        .results-summary {
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: var(--radius);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: var(--darker);
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .summary-success { color: var(--success); }
        .summary-warning { color: var(--warning); }
        .summary-error { color: var(--error); }

        .summary-label {
            font-size: 0.9rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Log */
        .log { 
            background: rgba(255, 255, 255, 0.05); 
            border-radius: var(--radius); 
            padding: 1rem; 
            height: 300px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 0.85rem; 
            line-height: 1.5; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .log-entry { 
            margin-bottom: 0.5rem; 
            padding: 0.5rem; 
            border-radius: 6px; 
            border-left: 3px solid transparent;
        }
        .log-entry.success { 
            background-color: rgba(16, 185, 129, 0.1); 
            color: var(--success); 
            border-left-color: var(--success); 
        }
        .log-entry.error { 
            background-color: rgba(239, 68, 68, 0.1); 
            color: var(--error); 
            border-left-color: var(--error); 
        }
        .log-entry.warning { 
            background-color: rgba(245, 158, 11, 0.1); 
            color: var(--warning); 
            border-left-color: var(--warning); 
        }
        .log-entry.info { 
            background-color: rgba(79, 70, 229, 0.1); 
            color: var(--primary-light); 
            border-left-color: var(--primary-light); 
        }
        .log-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1rem; 
        }
        .log-title { 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }

        /* Footer */
        .footer { 
            text-align: center; 
            padding: 1.5rem; 
            color: var(--text-light); 
            font-size: 0.9rem; 
            background: var(--darker); 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Toast Notification */
        .toast { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 1rem 1.5rem; 
            border-radius: var(--radius); 
            background-color: white; 
            box-shadow: var(--shadow-lg); 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            z-index: 1000; 
            transform: translateX(150%); 
            transition: transform 0.3s ease; 
            max-width: 400px; 
            color: var(--darker); 
        }
        .toast.show { transform: translateX(0); }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--error); }
        .toast-warning { border-left: 4px solid var(--warning); }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                margin: 0;
                border-radius: 0;
            }
            
            .controls-container {
                grid-template-columns: 1fr;
            }
            
            .button-group .btn {
                min-width: 100%;
            }
            
            .registros-table {
                font-size: 0.8rem;
            }
            
            .registros-table th,
            .registros-table td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo-icon">üì±</div>
            <div class="company-name">SERVICIOS INTEGRALES MADA</div>
            <div class="app-title">REGISTRO MASIVO DE PORTABILIDADES</div>
            <div class="app-subtitle">OCR especializado en tel√©fono e ICC | Hasta 40 tr√°mites simult√°neos</div>
            <div class="app-info">Sistema auto-configurable | Promotor se ingresa manualmente</div>
        </header>

        <main class="main-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-sliders-h"></i> Configuraci√≥n del Lote</h2>
                
                <div class="controls-container">
                    <div class="form-group">
                        <label class="form-label" for="promotorGlobal">Promotor Global (opcional):</label>
                        <input type="text" id="promotorGlobal" class="form-input" placeholder="Nombre del promotor para todos los registros" />
                        <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
                            <strong>NOTA:</strong> El OCR solo extrae tel√©fono e ICC. El promotor debe ingresarse manualmente en cada fila.
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="loteNombre">Nombre del Lote:</label>
                        <input type="text" id="loteNombre" class="form-input" placeholder="Ej: Portabilidades Noviembre" />
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-file-upload"></i> Carga Masiva de Capturas</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <div class="upload-text">
                        <p id="uploadText">Arrastra y suelta hasta 40 capturas o haz clic para seleccionar</p>
                    </div>
                    <p class="upload-hint">
                        <strong>OCR ESPECIALIZADO:</strong> Solo extraer√° tel√©fono (10 d√≠gitos) e ICC (18-20 d√≠gitos)<br>
                        Formatos: JPG, PNG. Capturas n√≠tidas para mejor precisi√≥n.
                    </p>
                    <div class="upload-count" id="uploadCount">0 capturas seleccionadas</div>
                    <input type="file" id="fileInput" accept="image/*" multiple style="display: none;" />
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="btnProcesarOCR">
                        <i class="fas fa-search-plus"></i> Procesar TODAS las capturas (OCR)
                    </button>
                    <button class="btn btn-warning" id="btnLimpiarImagenes">
                        <i class="fas fa-trash-alt"></i> Limpiar capturas
                    </button>
                </div>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Preparando procesamiento...</div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-table"></i> Registros (M√°ximo: 40)</h2>
                
                <div class="registros-counter">
                    <div class="counter-item">
                        <div class="counter-value" id="counterTotal">0</div>
                        <div class="counter-label">Total Registros</div>
                    </div>
                    <div class="counter-item">
                        <div class="counter-value" id="counterValidados">0</div>
                        <div class="counter-label">Completos</div>
                    </div>
                    <div class="counter-item">
                        <div class="counter-value" id="counterPendientes">40</div>
                        <div class="counter-label">Faltan Promotor</div>
                    </div>
                    <div class="counter-item">
                        <div class="counter-value" id="counterVacios">40</div>
                        <div class="counter-label">Disponibles</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="registros-table" id="tablaRegistros">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th style="width: 200px;">PROMOTOR * (Manual)</th>
                                <th style="width: 150px;">TEL√âFONO (10 d√≠gitos)</th>
                                <th style="width: 220px;">ICC (18-20 d√≠gitos)</th>
                                <th style="width: 120px;">Estado</th>
                                <th style="width: 100px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTabla">
                            <!-- Las 40 filas se generan con JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="button-group" style="margin-top: 1.5rem;">
                    <button class="btn btn-warning" id="btnLimpiarTabla">
                        <i class="fas fa-broom"></i> Limpiar toda la tabla
                    </button>
                    <button class="btn btn-danger" id="btnEliminarInvalidos">
                        <i class="fas fa-filter"></i> Eliminar inv√°lidos
                    </button>
                    <button class="btn btn-secondary" id="btnValidarTodos">
                        <i class="fas fa-check-double"></i> Validar todos
                    </button>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-paper-plane"></i> Env√≠o Masivo</h2>
                
                <div class="results-summary" id="resultsSummary">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text);">Resumen del Env√≠o</h3>
                    
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-value summary-success" id="summaryExitosos">0</div>
                            <div class="summary-label">√âxitos</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value summary-warning" id="summaryDuplicados">0</div>
                            <div class="summary-label">Duplicados</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value summary-error" id="summaryErrores">0</div>
                            <div class="summary-label">Errores</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="summaryTotal">0</div>
                            <div class="summary-label">Total Procesados</div>
                        </div>
                    </div>
                    
                    <div id="detallesEnvio" style="font-size: 0.9rem; color: var(--text-light);">
                        <!-- Detalles del env√≠o -->
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="btnEnviarLote">
                        <i class="fas fa-share-square"></i> ENVIAR LOTE COMPLETO
                    </button>
                    <button class="btn btn-secondary" id="btnPrevisualizar">
                        <i class="fas fa-eye"></i> Previsualizar env√≠o
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="log-header">
                    <h2 class="log-title"><i class="fas fa-file-alt"></i> Registro de Actividad</h2>
                    <button class="btn btn-secondary" id="btnClearLog">
                        <i class="fas fa-trash-alt"></i> Limpiar
                    </button>
                </div>
                <div class="log-container">
                    <div class="log" id="log"></div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>SERVICIOS INTEGRALES MADA &copy; 2023 | Sistema Auto-configurable | Desarrollado por Jesus Chavez ‚ù§Ô∏è</p>
            <p style="font-size: 0.8rem; margin-top: 0.5rem;" id="systemStatus">Estado del sistema: No configurado</p>
        </footer>
    </div>

    <div class="toast" id="toast">
        <div class="toast-icon" id="toastIcon"></div>
        <div class="toast-message" id="toastMessage"></div>
    </div>

    <script>
        // üöÄ CONFIGURACI√ìN DIN√ÅMICA - EL SISTEMA SE CREA AUTOM√ÅTICAMENTE
        // La URL del backend se obtendr√° despu√©s de crear el sistema
        let WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxrQWkYEck8D0scq1Me5C-2z3WnAPSg882Qtrr-RECtoHA8-uwfF3UC7CxEfxNrz8mI/exec';
        const MAX_REGISTROS = 40;
        
        // Variables globales
        let imagenesSeleccionadas = [];
        let registrosData = Array(MAX_REGISTROS).fill().map(() => ({
            promotor: '',
            telefono: '',
            icc: '',
            validado: false,
            completo: false
        }));
        
        let loteActual = '';
        let sistemaCreado = false;

        // Elementos DOM
        const elementos = {
            // Configuraci√≥n
            promotorGlobal: document.getElementById("promotorGlobal"),
            loteNombre: document.getElementById("loteNombre"),
            
            // Upload
            uploadArea: document.getElementById("uploadArea"),
            uploadText: document.getElementById("uploadText"),
            uploadCount: document.getElementById("uploadCount"),
            fileInput: document.getElementById("fileInput"),
            
            // Procesamiento
            btnProcesarOCR: document.getElementById("btnProcesarOCR"),
            btnLimpiarImagenes: document.getElementById("btnLimpiarImagenes"),
            progressContainer: document.getElementById("progressContainer"),
            progressFill: document.getElementById("progressFill"),
            progressText: document.getElementById("progressText"),
            
            // Tabla
            cuerpoTabla: document.getElementById("cuerpoTabla"),
            counterTotal: document.getElementById("counterTotal"),
            counterValidados: document.getElementById("counterValidados"),
            counterPendientes: document.getElementById("counterPendientes"),
            counterVacios: document.getElementById("counterVacios"),
            btnLimpiarTabla: document.getElementById("btnLimpiarTabla"),
            btnEliminarInvalidos: document.getElementById("btnEliminarInvalidos"),
            btnValidarTodos: document.getElementById("btnValidarTodos"),
            
            // Env√≠o
            btnEnviarLote: document.getElementById("btnEnviarLote"),
            btnPrevisualizar: document.getElementById("btnPrevisualizar"),
            resultsSummary: document.getElementById("resultsSummary"),
            summaryExitosos: document.getElementById("summaryExitosos"),
            summaryDuplicados: document.getElementById("summaryDuplicados"),
            summaryErrores: document.getElementById("summaryErrores"),
            summaryTotal: document.getElementById("summaryTotal"),
            detallesEnvio: document.getElementById("detallesEnvio"),
            
            // Log
            log: document.getElementById("log"),
            btnClearLog: document.getElementById("btnClearLog"),
            
            // Toast
            toast: document.getElementById("toast"),
            toastIcon: document.getElementById("toastIcon"),
            toastMessage: document.getElementById("toastMessage"),
            
            // Sistema
            systemStatus: document.getElementById("systemStatus")
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            await inicializarSistema();
            inicializarTabla();
            configurarEventListeners();
            actualizarContadores();
            elementos.resultsSummary.style.display = 'none';
            
            agregarLog("‚úÖ Sistema MADA inicializado. Listo para procesar hasta 40 tr√°mites.", "info");
            agregarLog("üìã Tabla de 40 registros creada. El OCR solo extraer√° tel√©fono e ICC.", "info");
            agregarLog("üë§ El promotor debe ingresarse MANUALMENTE en cada fila.", "info");
        });

        // Inicializar sistema (crear o verificar backend)
        async function inicializarSistema() {
            mostrarToast("Inicializando sistema MADA...", "info");
            agregarLog("üîß Inicializando sistema...", "info");
            
            try {
                // Usamos un backend temporal para crear el sistema
                const backendTemp = 'https://script.google.com/macros/s/AKfycbw-78IRPNmKGaCfaqazQvBRSXN5SVhOn-hdlyUvpLfa3aPG3MhZ_NXgNkg2MkLI8T73/exec';
                
                // Intentar crear nuevo sistema
                const response = await fetch(`${backendTemp}?accion=crearSistema`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) throw new Error("Error en respuesta del servidor");
                
                const result = await response.json();
                
                if (result.success) {
                    // Guardar la nueva URL del sistema creado
                    WEBAPP_URL = `https://script.google.com/macros/s/${result.sheetId}/exec`;
                    sistemaCreado = true;
                    
                    elementos.systemStatus.textContent = `Estado del sistema: Configurado | Hoja: ${result.sheetName}`;
                    elementos.systemStatus.style.color = '#10b981';
                    
                    mostrarToast(`‚úÖ Sistema creado: ${result.sheetName}`, "success");
                    agregarLog(`‚úÖ Sistema MADA creado exitosamente. ID: ${result.sheetId}`, "success");
                    agregarLog(`üìä Hoja de c√°lculo: ${result.sheetUrl}`, "info");
                    
                    // Generar nombre de lote autom√°tico
                    const fecha = new Date();
                    const lote = `LOTE-${fecha.getFullYear()}${(fecha.getMonth()+1).toString().padStart(2,'0')}${fecha.getDate().toString().padStart(2,'0')}-${Math.floor(Math.random()*1000)}`;
                    elementos.loteNombre.value = lote;
                    loteActual = lote;
                    
                } else {
                    throw new Error(result.message || "Error al crear sistema");
                }
                
            } catch (error) {
                console.error("Error al inicializar sistema:", error);
                mostrarToast("Error al inicializar sistema", "error");
                agregarLog(`‚ùå Error: ${error.message}`, "error");
                
                // Usar backend por defecto como fallback
                WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw-78IRPNmKGaCfaqazQvBRSXN5SVhOn-hdlyUvpLfa3aPG3MhZ_NXgNkg2MkLI8T73/exec';
                elementos.systemStatus.textContent = "Estado del sistema: Modo compatibilidad";
                elementos.systemStatus.style.color = '#f59e0b';
                
                agregarLog("‚ö†Ô∏è Usando sistema en modo compatibilidad", "warning");
            }
        }

        // Inicializar tabla con 40 filas
        function inicializarTabla() {
            elementos.cuerpoTabla.innerHTML = '';
            
            for (let i = 0; i < MAX_REGISTROS; i++) {
                const tr = document.createElement('tr');
                tr.id = `fila-${i}`;
                tr.innerHTML = `
                    <td style="text-align: center; font-weight: 600; color: var(--text-light);">${i + 1}</td>
                    <td>
                        <input type="text" 
                               class="promotor-input" 
                               data-index="${i}" 
                               placeholder="INGRESA NOMBRE DEL PROMOTOR" 
                               value="${registrosData[i].promotor}"
                               oninput="actualizarRegistro(${i}, 'promotor', this.value)"
                               style="width: 100%; background: rgba(79, 70, 229, 0.1); border: 1px solid rgba(79, 70, 229, 0.3);">
                        <div style="font-size: 0.7rem; color: var(--text-light); margin-top: 2px;">
                            Campo MANUAL (requerido)
                        </div>
                    </td>
                    <td>
                        <input type="text" 
                               class="telefono-input" 
                               data-index="${i}" 
                               placeholder="10 d√≠gitos" 
                               maxlength="10"
                               value="${registrosData[i].telefono}"
                               oninput="actualizarRegistro(${i}, 'telefono', this.value); this.value = this.value.replace(/\\D/g, '').slice(0, 10);"
                               style="width: 100%;">
                        <div style="font-size: 0.7rem; color: var(--text-light); margin-top: 2px;">
                            Lo extrae el OCR
                        </div>
                    </td>
                    <td>
                        <input type="text" 
                               class="icc-input" 
                               data-index="${i}" 
                               placeholder="18-20 d√≠gitos" 
                               maxlength="20"
                               value="${registrosData[i].icc}"
                               oninput="actualizarRegistro(${i}, 'icc', this.value); this.value = this.value.replace(/\\D/g, '').slice(0, 20);"
                               style="width: 100%;">
                        <div style="font-size: 0.7rem; color: var(--text-light); margin-top: 2px;">
                            Lo extrae el OCR
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <span class="estado-badge" id="estado-${i}" style="
                            display: inline-block;
                            padding: 0.25rem 0.75rem;
                            border-radius: 20px;
                            font-size: 0.8rem;
                            font-weight: 600;
                            background-color: rgba(239, 68, 68, 0.2);
                            color: #ef4444;
                        ">INCOMPLETO</span>
                    </td>
                    <td style="text-align: center;">
                        <button type="button" 
                                class="btn-limpiar-fila" 
                                data-index="${i}"
                                onclick="limpiarFila(${i})"
                                style="
                                    background: rgba(239, 68, 68, 0.2);
                                    border: none;
                                    color: #ef4444;
                                    padding: 0.5rem 0.75rem;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 0.8rem;
                                ">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </td>
                `;
                elementos.cuerpoTabla.appendChild(tr);
                
                // Validar fila inicial
                validarFila(i);
            }
        }

        // Configurar event listeners
        function configurarEventListeners() {
            // Carga de archivos
            elementos.uploadArea.addEventListener('click', () => elementos.fileInput.click());
            elementos.uploadArea.addEventListener('drop', (e) => { 
                e.preventDefault(); 
                elementos.uploadArea.classList.remove('dragover');
                manejarArchivos(e.dataTransfer.files); 
            });
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                elementos.uploadArea.addEventListener(eventName, e => e.preventDefault());
            });
            elementos.uploadArea.addEventListener('dragover', () => elementos.uploadArea.classList.add('dragover'));
            elementos.uploadArea.addEventListener('dragleave', () => elementos.uploadArea.classList.remove('dragover'));
            elementos.fileInput.addEventListener('change', (e) => manejarArchivos(e.target.files));
            
            // Promotor global
            elementos.promotorGlobal.addEventListener('input', function() {
                if (this.value.trim()) {
                    aplicarPromotorGlobal(this.value.trim());
                }
            });
            
            // Botones de procesamiento
            elementos.btnProcesarOCR.addEventListener('click', procesarOCRMultiple);
            elementos.btnLimpiarImagenes.addEventListener('click', limpiarImagenes);
            
            // Botones de tabla
            elementos.btnLimpiarTabla.addEventListener('click', limpiarTablaCompleta);
            elementos.btnEliminarInvalidos.addEventListener('click', eliminarInvalidos);
            elementos.btnValidarTodos.addEventListener('click', validarTodasLasFilas);
            
            // Botones de env√≠o
            elementos.btnEnviarLote.addEventListener('click', enviarLoteCompleto);
            elementos.btnPrevisualizar.addEventListener('click', previsualizarEnvio);
            elementos.btnClearLog.addEventListener('click', limpiarLog);
        }

        // Manejar m√∫ltiples archivos
        function manejarArchivos(files) {
            if (!files || files.length === 0) return;
            
            // Limitar a 40 im√°genes
            const archivosArray = Array.from(files).slice(0, MAX_REGISTROS);
            imagenesSeleccionadas = [...imagenesSeleccionadas, ...archivosArray].slice(0, MAX_REGISTROS);
            
            elementos.uploadText.textContent = `${imagenesSeleccionadas.length} capturas listas para OCR`;
            elementos.uploadCount.textContent = `${imagenesSeleccionadas.length} capturas seleccionadas`;
            
            mostrarToast(`${archivosArray.length} capturas cargadas`, "success");
            agregarLog(`‚úÖ ${archivosArray.length} capturas cargadas para OCR`, "success");
            agregarLog(`üì± OCR especializado: Solo extraer√° tel√©fono (10 d√≠gitos) e ICC (18-20 d√≠gitos)`, "info");
            
            // Habilitar bot√≥n de procesamiento
            elementos.btnProcesarOCR.disabled = false;
        }

        // Actualizar registro individual
        function actualizarRegistro(index, campo, valor) {
            registrosData[index][campo] = valor.trim();
            validarFila(index);
            actualizarContadores();
        }

        // Validar una fila espec√≠fica
        function validarFila(index) {
            const registro = registrosData[index];
            const promotor = registro.promotor || elementos.promotorGlobal.value.trim();
            const telefono = registro.telefono;
            const icc = registro.icc;
            
            // Validar tel√©fono (10 d√≠gitos exactos)
            const telefonoValido = telefono.length === 10 && /^\d{10}$/.test(telefono);
            
            // Validar ICC (18-20 d√≠gitos)
            const iccValido = icc.length >= 18 && icc.length <= 20 && /^\d+$/.test(icc);
            
            // Validar promotor (m√≠nimo 3 caracteres)
            const promotorValido = promotor.length >= 3;
            
            registro.validado = telefonoValido && iccValido && promotorValido;
            registro.completo = promotorValido && telefono.length > 0 && icc.length > 0;
            
            // Actualizar badge de estado
            const estadoBadge = document.getElementById(`estado-${index}`);
            if (registro.validado) {
                estadoBadge.textContent = "COMPLETO ‚úì";
                estadoBadge.style.backgroundColor = "rgba(16, 185, 129, 0.2)";
                estadoBadge.style.color = "#10b981";
            } else if (registro.completo) {
                estadoBadge.textContent = "FALTAN DATOS";
                estadoBadge.style.backgroundColor = "rgba(245, 158, 11, 0.2)";
                estadoBadge.style.color = "#f59e0b";
            } else if (telefono.length > 0 || icc.length > 0) {
                estadoBadge.textContent = "FALTA PROMOTOR";
                estadoBadge.style.backgroundColor = "rgba(239, 68, 68, 0.2)";
                estadoBadge.style.color = "#ef4444";
            } else {
                estadoBadge.textContent = "VAC√çO";
                estadoBadge.style.backgroundColor = "rgba(239, 68, 68, 0.2)";
                estadoBadge.style.color = "#ef4444";
            }
        }

        // Actualizar contadores
        function actualizarContadores() {
            const total = registrosData.filter(r => r.completo).length;
            const validados = registrosData.filter(r => r.validado).length;
            const pendientes = registrosData.filter(r => (r.telefono.length > 0 || r.icc.length > 0) && !r.promotor).length;
            const vacios = MAX_REGISTROS - total;
            
            elementos.counterTotal.textContent = total;
            elementos.counterValidados.textContent = validados;
            elementos.counterPendientes.textContent = pendientes;
            elementos.counterVacios.textContent = vacios;
            
            // Habilitar/deshabilitar bot√≥n de env√≠o
            elementos.btnEnviarLote.disabled = validados === 0;
            
            // Actualizar color del bot√≥n de env√≠o
            if (validados > 0) {
                elementos.btnEnviarLote.style.opacity = "1";
                elementos.btnEnviarLote.innerHTML = `<i class="fas fa-share-square"></i> ENVIAR LOTE (${validados} v√°lidos)`;
            } else {
                elementos.btnEnviarLote.style.opacity = "0.6";
                elementos.btnEnviarLote.innerHTML = `<i class="fas fa-share-square"></i> ENVIAR LOTE COMPLETO`;
            }
        }

        // Limpiar una fila espec√≠fica
        function limpiarFila(index) {
            registrosData[index] = { promotor: '', telefono: '', icc: '', validado: false, completo: false };
            
            const inputs = document.querySelectorAll(`#fila-${index} input`);
            inputs.forEach(input => input.value = '');
            
            validarFila(index);
            actualizarContadores();
            
            agregarLog(`üßπ Fila ${index + 1} limpiada`, "info");
        }

        // Aplicar promotor global a todas las filas
        function aplicarPromotorGlobal(promotor) {
            let aplicados = 0;
            for (let i = 0; i < MAX_REGISTROS; i++) {
                if (!registrosData[i].promotor) {
                    registrosData[i].promotor = promotor;
                    document.querySelector(`#fila-${i} .promotor-input`).value = promotor;
                    validarFila(i);
                    aplicados++;
                }
            }
            actualizarContadores();
            agregarLog(`üë§ Promotor global aplicado a ${aplicados} filas: ${promotor}`, "info");
            mostrarToast(`Promotor global aplicado a ${aplicados} filas`, "success");
        }

        // Procesar OCR para m√∫ltiples im√°genes (SOLO TEL√âFONO E ICC)
        async function procesarOCRMultiple() {
            if (imagenesSeleccionadas.length === 0) {
                mostrarToast("No hay capturas para procesar", "error");
                return;
            }
            
            elementos.btnProcesarOCR.disabled = true;
            elementos.btnLimpiarImagenes.disabled = true;
            elementos.progressContainer.style.display = 'block';
            
            const totalImagenes = Math.min(imagenesSeleccionadas.length, MAX_REGISTROS);
            let procesadas = 0;
            let extraccionesExitosas = 0;
            
            agregarLog(`üîç Iniciando OCR especializado de ${totalImagenes} capturas...`, "info");
            agregarLog(`üéØ Objetivo: Extraer solo tel√©fono (10 d√≠gitos) e ICC (18-20 d√≠gitos)`, "info");
            
            // Encontrar filas vac√≠as o con datos incompletos
            const filasDisponibles = [];
            for (let i = 0; i < MAX_REGISTROS; i++) {
                if (!registrosData[i].telefono || !registrosData[i].icc) {
                    filasDisponibles.push(i);
                }
            }
            
            // Si no hay filas vac√≠as, usar las primeras
            const indicesFila = filasDisponibles.length > 0 ? filasDisponibles : Array.from({length: MAX_REGISTROS}, (_, i) => i);
            
            for (let i = 0; i < totalImagenes; i++) {
                if (i >= indicesFila.length) break;
                
                const imagen = imagenesSeleccionadas[i];
                const filaIndex = indicesFila[i];
                
                // Actualizar progreso
                const progreso = Math.round((i / totalImagenes) * 100);
                elementos.progressFill.style.width = `${progreso}%`;
                elementos.progressText.textContent = `Procesando captura ${i + 1} de ${totalImagenes}...`;
                
                try {
                    const resultado = await procesarUnaImagen(imagen);
                    
                    // Actualizar la fila con los datos extra√≠dos (SOLO TEL√âFONO E ICC)
                    let telefonoExtraido = resultado.telefono || '';
                    let iccExtraido = resultado.icc || '';
                    
                    if (telefonoExtraido) {
                        registrosData[filaIndex].telefono = telefonoExtraido;
                        document.querySelector(`#fila-${filaIndex} .telefono-input`).value = telefonoExtraido;
                        extraccionesExitosas++;
                    }
                    
                    if (iccExtraido) {
                        registrosData[filaIndex].icc = iccExtraido;
                        document.querySelector(`#fila-${filaIndex} .icc-input`).value = iccExtraido;
                        extraccionesExitosas++;
                    }
                    
                    validarFila(filaIndex);
                    procesadas++;
                    
                    agregarLog(`‚úÖ Captura ${i + 1} ‚Üí Fila ${filaIndex + 1}: Tel: ${telefonoExtraido || 'No'}, ICC: ${iccExtraido || 'No'}`, "success");
                    
                } catch (error) {
                    agregarLog(`‚ùå Error procesando captura ${i + 1}: ${error.message}`, "error");
                }
            }
            
            // Finalizar
            elementos.progressFill.style.width = '100%';
            elementos.progressText.textContent = `OCR completado: ${procesadas} capturas, ${extraccionesExitosas} datos extra√≠dos`;
            
            setTimeout(() => {
                elementos.progressContainer.style.display = 'none';
                elementos.progressFill.style.width = '0%';
                elementos.btnProcesarOCR.disabled = false;
                elementos.btnLimpiarImagenes.disabled = false;
            }, 1500);
            
            actualizarContadores();
            
            if (extraccionesExitosas > 0) {
                mostrarToast(`${procesadas} capturas procesadas, ${extraccionesExitosas} datos extra√≠dos`, "success");
                agregarLog(`üìä Resumen: ${procesadas} capturas procesadas, ${extraccionesExitosas} datos extra√≠dos`, "success");
                agregarLog(`üë§ Recuerda: Ingresa el NOMBRE DEL PROMOTOR manualmente en cada fila`, "info");
            } else {
                mostrarToast("OCR completado pero no se extrajeron datos", "warning");
                agregarLog(`‚ö†Ô∏è OCR completado pero no se extrajeron datos v√°lidos`, "warning");
            }
            
            // Limpiar im√°genes procesadas
            imagenesSeleccionadas = [];
            elementos.uploadText.textContent = "Arrastra y suelta hasta 40 capturas o haz clic para seleccionar";
            elementos.uploadCount.textContent = "0 capturas seleccionadas";
        }

        // Procesar una sola imagen con OCR (SOLO TEL√âFONO E ICC)
        async function procesarUnaImagen(file) {
            return new Promise(async (resolve, reject) => {
                try {
                    // Crear imagen desde archivo
                    const img = await crearImagen(file);
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Redimensionar para mejor OCR
                    const maxWidth = 1200;
                    const scale = maxWidth / img.width;
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Aplicar preprocesamiento para mejorar OCR
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Mejorar contraste para n√∫meros
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        const threshold = 160;
                        const val = avg > threshold ? 255 : 0;
                        data[i] = data[i + 1] = data[i + 2] = val;
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    
                    // Configurar Tesseract para n√∫meros
                    const result = await Tesseract.recognize(
                        canvas.toDataURL('image/png'),
                        'eng', // Solo ingl√©s para mejor detecci√≥n de n√∫meros
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    // Puedes mostrar progreso individual aqu√≠ si lo deseas
                                }
                            },
                            // Configurar para mejor detecci√≥n de n√∫meros
                            tessedit_char_whitelist: '0123456789',
                            preserve_interword_spaces: '1'
                        }
                    );
                    
                    const texto = result.data.text;
                    const datos = extraerDatosEspecializado(texto);
                    
                    resolve(datos);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Crear imagen desde archivo
        function crearImagen(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    img.src = e.target.result;
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error("Error al cargar imagen"));
                };
                
                reader.onerror = () => reject(new Error("Error al leer archivo"));
                reader.readAsDataURL(file);
            });
        }

        // Extraer datos del texto OCR (SOLO TEL√âFONO E ICC)
        function extraerDatosEspecializado(texto) {
            const resultado = { telefono: '', icc: '' };
            const textoLimpio = texto.replace(/\s+/g, '');
            
            // Buscar tel√©fono (10 d√≠gitos consecutivos)
            const matchTelefono = textoLimpio.match(/\d{10}/g);
            if (matchTelefono) {
                // Tomar el primer grupo de 10 d√≠gitos que encuentre
                resultado.telefono = matchTelefono[0];
            }
            
            // Buscar ICC (18-20 d√≠gitos, t√≠picamente empieza con 89 para SIMs)
            // Primero buscar secuencias largas de d√≠gitos
            const secuenciasNumeros = textoLimpio.match(/\d{15,}/g);
            if (secuenciasNumeros) {
                secuenciasNumeros.forEach(secuencia => {
                    // Si la secuencia tiene entre 18-20 d√≠gitos y empieza con 89, es probablemente un ICC
                    if (secuencia.length >= 18 && secuencia.length <= 20 && secuencia.startsWith('89')) {
                        resultado.icc = secuencia.substring(0, 20); // Tomar m√°ximo 20
                    }
                });
            }
            
            // Si no encontr√≥ ICC con el patr√≥n 89, buscar cualquier secuencia de 18-20 d√≠gitos
            if (!resultado.icc) {
                const matchICC = textoLimpio.match(/\d{18,20}/g);
                if (matchICC) {
                    resultado.icc = matchICC[0];
                }
            }
            
            return resultado;
        }

        // Limpiar todas las im√°genes
        function limpiarImagenes() {
            if (imagenesSeleccionadas.length === 0) {
                mostrarToast("No hay capturas para limpiar", "warning");
                return;
            }
            
            imagenesSeleccionadas = [];
            elementos.uploadText.textContent = "Arrastra y suelta hasta 40 capturas o haz clic para seleccionar";
            elementos.uploadCount.textContent = "0 capturas seleccionadas";
            elementos.btnProcesarOCR.disabled = true;
            
            mostrarToast("Capturas limpiadas", "success");
            agregarLog("üßπ Todas las capturas eliminadas", "info");
        }

        // Limpiar tabla completa
        function limpiarTablaCompleta() {
            if (!confirm("¬øEst√°s seguro de limpiar TODOS los registros? Esta acci√≥n no se puede deshacer.")) {
                return;
            }
            
            for (let i = 0; i < MAX_REGISTROS; i++) {
                registrosData[i] = { promotor: '', telefono: '', icc: '', validado: false, completo: false };
                const inputs = document.querySelectorAll(`#fila-${i} input`);
                inputs.forEach(input => input.value = '');
                validarFila(i);
            }
            
            actualizarContadores();
            mostrarToast("Tabla limpiada completamente", "success");
            agregarLog("üßπ Tabla completa limpiada", "info");
        }

        // Eliminar registros inv√°lidos
        function eliminarInvalidos() {
            let eliminados = 0;
            
            for (let i = 0; i < MAX_REGISTROS; i++) {
                if (registrosData[i].completo && !registrosData[i].validado) {
                    registrosData[i] = { promotor: '', telefono: '', icc: '', validado: false, completo: false };
                    const inputs = document.querySelectorAll(`#fila-${i} input`);
                    inputs.forEach(input => input.value = '');
                    validarFila(i);
                    eliminados++;
                }
            }
            
            if (eliminados > 0) {
                actualizarContadores();
                mostrarToast(`${eliminados} registros inv√°lidos eliminados`, "success");
                agregarLog(`üßπ ${eliminados} registros inv√°lidos eliminados`, "info");
            } else {
                mostrarToast("No hay registros inv√°lidos para eliminar", "info");
            }
        }

        // Validar todas las filas
        function validarTodasLasFilas() {
            for (let i = 0; i < MAX_REGISTROS; i++) {
                validarFila(i);
            }
            actualizarContadores();
            mostrarToast("Todas las filas validadas", "success");
            agregarLog("‚úÖ Todas las filas validadas", "info");
        }

        // Previsualizar env√≠o
        function previsualizarEnvio() {
            const registrosValidos = registrosData.filter(r => r.validado);
            
            if (registrosValidos.length === 0) {
                mostrarToast("No hay registros v√°lidos para previsualizar", "warning");
                return;
            }
            
            let previsualizacion = `üìã PREVISUALIZACI√ìN DEL ENV√çO\n`;
            previsualizacion += `================================\n`;
            previsualizacion += `Total de registros: ${registrosValidos.length}\n`;
            previsualizacion += `Lote: ${elementos.loteNombre.value || 'Sin nombre'}\n\n`;
            
            registrosValidos.forEach((registro, index) => {
                previsualizacion += `${index + 1}. ${registro.promotor} | Tel: ${registro.telefono} | ICC: ${registro.icc}\n`;
            });
            
            alert(previsualizacion);
            agregarLog("üëÅÔ∏è Previsualizaci√≥n del env√≠o generada", "info");
        }

        // Enviar lote completo
        async function enviarLoteCompleto() {
            const registrosValidos = registrosData.filter(r => r.validado);
            
            if (registrosValidos.length === 0) {
                mostrarToast("No hay registros v√°lidos para enviar", "error");
                return;
            }
            
            // Confirmaci√≥n final
            if (!confirm(`¬øEst√°s seguro de enviar ${registrosValidos.length} registros?\n\nüì± Tel√©fonos: ${registrosValidos.length}\nüìã ICCs: ${registrosValidos.length}\nüë§ Promotores: ${new Set(registrosValidos.map(r => r.promotor)).size} diferentes`)) {
                return;
            }
            
            elementos.btnEnviarLote.disabled = true;
            elementos.btnPrevisualizar.disabled = true;
            elementos.progressContainer.style.display = 'block';
            elementos.progressFill.style.width = '10%';
            elementos.progressText.textContent = "Preparando env√≠o...";
            
            // Preparar datos para enviar
            const datosEnvio = {
                action: "guardarMultiplesRegistros",
                registros: registrosValidos.map(r => ({
                    promotor: r.promotor,
                    telefono: r.telefono,
                    icc: r.icc
                }))
            };
            
            // Agregar nombre de lote si existe
            if (elementos.loteNombre.value.trim()) {
                datosEnvio.nombreLote = elementos.loteNombre.value.trim();
            }
            
            agregarLog(`üöÄ Iniciando env√≠o de ${registrosValidos.length} registros...`, "info");
            agregarLog(`üìä Detalles: ${registrosValidos.length} tel√©fonos, ${registrosValidos.length} ICCs`, "info");
            
            try {
                elementos.progressFill.style.width = '30%';
                elementos.progressText.textContent = "Conectando con el servidor...";
                
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(datosEnvio)
                });
                
                elementos.progressFill.style.width = '70%';
                elementos.progressText.textContent = "Procesando respuesta...";
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                
                elementos.progressFill.style.width = '100%';
                elementos.progressText.textContent = "Env√≠o completado";
                
                if (result.success) {
                    // Mostrar resumen
                    mostrarResumenEnvio(result);
                    
                    // Mostrar mensaje de √©xito
                    mostrarToast(`‚úÖ ${result.exitosos} registros guardados exitosamente`, "success");
                    
                    // Agregar al log
                    agregarLog(`‚úÖ Env√≠o completado: ${result.exitosos} √©xitos, ${result.duplicados} duplicados, ${result.errores} errores`, "success");
                    agregarLog(`üìä Lote: ${result.lote}`, "info");
                    agregarLog(`üìÅ Hoja de c√°lculo: ${result.sheetUrl}`, "info");
                    
                    // Mostrar detalles de errores si los hay
                    if (result.errores > 0 || result.duplicados > 0) {
                        agregarLog("üìã Detalles del procesamiento:", "info");
                        result.detalles.forEach(detalle => {
                            if (detalle.status === "error") {
                                agregarLog(`‚ùå Registro ${detalle.indice + 1}: ${detalle.message}`, "error");
                            } else if (detalle.status === "warning") {
                                agregarLog(`‚ö†Ô∏è Registro ${detalle.indice + 1}: ${detalle.message}`, "warning");
                            }
                        });
                    }
                    
                    // Preguntar si se desea limpiar la tabla
                    setTimeout(() => {
                        if (result.exitosos > 0 && confirm(`¬øDeseas limpiar la tabla para nuevos registros?\n\nSe guardaron ${result.exitosos} registros exitosamente en el lote "${result.lote}".`)) {
                            limpiarTablaCompleta();
                        }
                    }, 1000);
                    
                } else {
                    throw new Error(result.message || "Error en el servidor");
                }
                
            } catch (error) {
                console.error("Error en el env√≠o:", error);
                mostrarToast("Error al enviar los registros", "error");
                agregarLog(`‚ùå Error en el env√≠o: ${error.message}`, "error");
            } finally {
                setTimeout(() => {
                    elementos.progressContainer.style.display = 'none';
                    elementos.progressFill.style.width = '0%';
                    elementos.btnEnviarLote.disabled = false;
                    elementos.btnPrevisualizar.disabled = false;
                }, 2000);
            }
        }

        // Mostrar resumen del env√≠o
        function mostrarResumenEnvio(resultado) {
            elementos.resultsSummary.style.display = 'block';
            
            elementos.summaryExitosos.textContent = resultado.exitosos;
            elementos.summaryDuplicados.textContent = resultado.duplicados;
            elementos.summaryErrores.textContent = resultado.errores;
            elementos.summaryTotal.textContent = resultado.total;
            
            let detallesHTML = `
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <strong>üìã Detalles del env√≠o:</strong><br>
                    ‚Ä¢ <strong>Lote:</strong> ${resultado.lote}<br>
                    ‚Ä¢ <strong>Fecha:</strong> ${resultado.fecha}<br>
                    ‚Ä¢ <strong>Total procesados:</strong> ${resultado.total} registros<br>
                    ‚Ä¢ <strong>URL de la hoja:</strong> <a href="${resultado.sheetUrl}" target="_blank" style="color: #3b82f6;">Ver hoja de c√°lculo</a><br><br>
            `;
            
            if (resultado.exitosos > 0) {
                detallesHTML += `<span style="color: #10b981;">‚úÖ ${resultado.exitosos} registros guardados exitosamente</span><br>`;
            }
            if (resultado.duplicados > 0) {
                detallesHTML += `<span style="color: #f59e0b;">‚ö†Ô∏è ${resultado.duplicados} registros duplicados (no guardados)</span><br>`;
            }
            if (resultado.errores > 0) {
                detallesHTML += `<span style="color: #ef4444;">‚ùå ${resultado.errores} registros con errores</span>`;
            }
            
            detallesHTML += `</div>`;
            
            elementos.detallesEnvio.innerHTML = detallesHTML;
            
            // Desplazarse al resumen
            elementos.resultsSummary.scrollIntoView({ behavior: 'smooth' });
        }

        // Agregar entrada al log
        function agregarLog(mensaje, tipo = "info") {
            const timestamp = new Date().toLocaleTimeString('es-MX', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${tipo}`;
            logEntry.textContent = `[${timestamp}] ${mensaje}`;
            elementos.log.appendChild(logEntry);
            elementos.log.scrollTop = elementos.log.scrollHeight;
        }

        // Limpiar log
        function limpiarLog() {
            elementos.log.innerHTML = '';
            agregarLog("Registro de actividad limpiado.", "info");
        }

        // Mostrar notificaci√≥n toast
        function mostrarToast(mensaje, tipo = "success") {
            elementos.toast.className = `toast toast-${tipo}`;
            elementos.toastMessage.textContent = mensaje;
            
            const iconMap = {
                "success": '<i class="fas fa-check-circle"></i>',
                "error": '<i class="fas fa-times-circle"></i>',
                "warning": '<i class="fas fa-exclamation-triangle"></i>',
                "info": '<i class="fas fa-info-circle"></i>'
            };
            
            elementos.toastIcon.innerHTML = iconMap[tipo] || '<i class="fas fa-info-circle"></i>';
            
            elementos.toast.classList.add("show");
            
            setTimeout(() => { 
                elementos.toast.classList.remove("show"); 
            }, 5000);
        }
    </script>
</body>
</html>
