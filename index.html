<!DOCTYPE html>
<html lang="es" class="h-full bg-white">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MADA · Promotor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#dc2626" />
  <style>
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .glass{backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
    .btn-disabled{opacity:.6;pointer-events:none}
  </style>
</head>
<body class="h-full text-red-900 bg-white">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-red-800 to-red-600 text-white">
      <div class="max-w-7xl mx-auto px-4 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-white flex items-center justify-center font-bold text-red-700 border border-red-200">M</div>
          <div>
            <h1 class="text-xl font-semibold tracking-wide">MADA · Promotor</h1>
            <p class="text-white/80 text-sm">Ficha simplificada · Activar chip · Encuesta</p>
          </div>
        </div>
        <div id="netStatus" class="text-xs">•</div>
      </div>
    </header>

    <main class="flex-1">
      <div class="max-w-7xl mx-auto px-4 py-6 lg:py-10 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Col principal -->
        <section class="lg:col-span-2 space-y-6">
          <!-- Portada -->
          <div id="portada" class="rounded-2xl bg-white shadow-sm p-6 border border-red-100">
            <h2 class="text-2xl font-semibold">Bienvenido</h2>
            <p class="text-red-700/80 mt-1">Elige la acción.</p>
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
              <button id="btnGoFicha" class="w-full rounded-xl bg-red-700 text-white py-4 px-5 font-medium hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-400">Ficha</button>
              <button id="btnGoActivar" class="w-full rounded-xl bg-white border border-red-200 py-4 px-5 font-medium hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-300">Activar chip</button>
              <button id="btnGoEncuesta" class="w-full rounded-xl bg-white border border-red-200 py-4 px-5 font-medium hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-300">Encuesta</button>
            </div>
          </div>

          <!-- FICHA (Portabilidad) -->
          <div id="cardFicha" class="hidden rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white">
              <h3 class="text-lg font-semibold">Ficha de captura (simple)</h3>
              <p class="text-white/80 text-sm">Obligatorios: Número, NIP, ICC, Promotor, Plaza, Carrier. CURP opcional.</p>
            </div>
            <form id="formFicha" class="p-6 space-y-6" autocomplete="off">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium">Plaza *</label>
                  <select id="plaza" required class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400">
                    <option value="">Selecciona</option>
                    <option>MONTERREY</option><option>MANTE</option><option>REYNOSA</option><option>MATAMOROS</option><option>SALTILLO</option><option>CHIHUAHUA</option><option>DELICIAS</option><option>CUAHUTEMOC</option><option>TAMPICO</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium">Carrier *</label>
                  <select id="carrier" required class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400">
                    <option value="">Selecciona</option>
                    <option>Telcel</option><option>Movistar</option><option>AT&T</option><option>Unefon</option><option>Bait</option><option>OXXO Cel</option><option>Virgin</option><option>Rincel</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium">Promotor *</label>
                  <input id="promotor" required placeholder="Nombre" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium">Número (10) *</label>
                  <input id="telefono" inputmode="numeric" maxlength="10" required placeholder="8112345678" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" />
                </div>
                <div>
                  <label class="block text-sm font-medium">NIP (4) *</label>
                  <input id="nip" inputmode="numeric" maxlength="4" required placeholder="1234" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" />
                </div>
                <div>
                  <label class="block text-sm font-medium">ICC (19) *</label>
                  <div class="flex gap-2">
                    <input id="icc" inputmode="numeric" maxlength="19" required placeholder="Escanéalo o escríbelo" class="mt-1 flex-1 rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" />
                    <button type="button" id="btnScanICC1" class="mt-1 rounded-xl border border-red-200 px-3 text-sm hover:bg-red-50">Scan</button>
                  </div>
                  <p id="iccHint1" class="hidden text-xs text-red-600 mt-1">ICC inválido (Luhn).</p>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium">CURP (opcional)</label>
                <input id="curp" maxlength="18" placeholder="18 caracteres" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" />
              </div>

              <div class="pt-2 flex items-center gap-3">
                <button id="btnFichaSubmit" type="submit" class="rounded-xl bg-red-700 text-white py-3 px-6 font-medium hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-400 flex items-center gap-2">
                  <svg id="spinFicha" class="hidden animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
                  <span>Crear ficha</span>
                </button>
                <button type="button" class="rounded-xl bg-white border border-red-200 py-3 px-6 font-medium hover:bg-red-50" onclick="navHome()">Volver</button>
              </div>
              <p id="dupWarn" class="hidden text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-xl p-3 mt-3">Este teléfono o ICC parece duplicado localmente. Verifica.</p>
            </form>
          </div>

          <!-- ACTIVAR CHIP (Azul/Blanco) -->
          <div id="cardActivar" class="hidden rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white">
              <h3 class="text-lg font-semibold">Activar chip</h3>
              <p class="text-white/80 text-sm">Selecciona tipo y captura los datos (ICC opcional).</p>
            </div>
            <form id="formActivar" class="p-6 space-y-6" autocomplete="off">
              <div class="flex flex-wrap gap-2">
                <button type="button" data-tipo="Azul" class="btn-tipo rounded-xl border border-red-200 px-3 py-1.5 text-sm hover:bg-red-50">Chip Azul</button>
                <button type="button" data-tipo="Blanco" class="btn-tipo rounded-xl border border-red-200 px-3 py-1.5 text-sm hover:bg-red-50">Chip Blanco</button>
                <span id="tipoSel" class="text-sm text-red-700 ml-2"></span>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium">ICC (opcional)</label>
                  <div class="flex gap-2">
                    <input id="icc2" inputmode="numeric" maxlength="19" placeholder="Escanéalo o escríbelo" class="mt-1 flex-1 rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" />
                    <button type="button" id="btnScanICC2" class="mt-1 rounded-xl border border-red-200 px-3 text-sm hover:bg-red-50">Scan</button>
                  </div>
                  <p id="iccHint2" class="hidden text-xs text-red-600 mt-1">ICC inválido (Luhn).</p>
                </div>
                <div>
                  <label class="block text-sm font-medium">Número (10) *</label>
                  <input id="numero2" inputmode="numeric" maxlength="10" required placeholder="8112345678" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" />
                </div>
                <div>
                  <label class="block text-sm font-medium">Monto recarga *</label>
                  <input id="monto2" inputmode="numeric" maxlength="6" required placeholder="50" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" />
                </div>
                <div>
                  <label class="block text-sm font-medium">Promotor *</label>
                  <input id="promotor2" required placeholder="Nombre" class="mt-1 w-full rounded-xl border-red-300 focus:ring-red-400 focus:border-red-400" />
                </div>
              </div>

              <div class="pt-2 flex items-center gap-3">
                <button id="btnActivarSubmit" type="submit" class="rounded-xl bg-red-700 text-white py-3 px-6 font-medium hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-400 flex items-center gap-2">
                  <svg id="spinAct" class="hidden animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
                  <span>Registrar</span>
                </button>
                <button type="button" class="rounded-xl bg-white border border-red-200 py-3 px-6 font-medium hover:bg-red-50" onclick="navHome()">Volver</button>
              </div>
              <p id="actInfo" class="text-xs text-red-700/80"></p>
            </form>
          </div>

          <!-- ENCUESTA -->
          <div id="cardEncuesta" class="hidden rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white">
              <h3 class="text-lg font-semibold">Diagnóstico rápido</h3>
              <p class="text-white/80 text-sm">Selecciona la compañía y responde 3–4 preguntas.</p>
            </div>
            <div class="p-6 space-y-6">
              <div id="notaTelcel" class="hidden border border-rose-200 rounded-xl p-4 bg-rose-50 text-rose-900">
                Cliente Telcel actual: derivar a upsell/recargas. No aplica diagnóstico.
              </div>
              <div class="space-y-2">
                <label class="block text-sm font-medium">Compañía objetivo (opcional)</label>
                <div class="flex flex-wrap gap-2" id="companyButtons"></div>
              </div>
              <div id="surveyQuestions" class="hidden space-y-4"></div>
              <div id="surveyResult" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="rounded-xl border border-red-200 p-4">
                  <div class="text-sm text-red-700">Score de severidad</div>
                  <div id="scoreValue" class="text-3xl font-semibold mt-1">0.00</div>
                </div>
                <div class="rounded-xl border border-red-200 p-4 md:col-span-2">
                  <div class="text-sm text-red-700">Pitch sugerido</div>
                  <div id="pitchValue" class="mt-1 font-medium">—</div>
                </div>
                <div class="rounded-xl border border-red-200 p-4 md:col-span-3">
                  <div class="text-sm text-red-700">Recomendación de plan</div>
                  <div id="planValue" class="mt-1 font-semibold text-red-900">—</div>
                </div>
              </div>
              <div class="flex flex-wrap gap-3">
                <button id="btnAceptaCambio" class="hidden rounded-xl bg-red-700 text-white py-2.5 px-4 hover:bg-red-800">Aceptó cambio</button>
                <button id="btnNoAcepta" class="hidden rounded-xl bg-white border border-red-200 py-2.5 px-4 hover:bg-red-50">No aceptó</button>
                <button id="btnIrFicha" class="hidden rounded-xl bg-white border border-red-200 py-2.5 px-4 hover:bg-red-50">Ir a ficha</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Panel lateral (historial local) -->
        <aside class="lg:col-span-1">
          <div class="rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white">
              <h3 class="text-lg font-semibold">Historial local</h3>
              <p class="text-white/80 text-sm">Últimos 10 eventos (este equipo)</p>
            </div>
            <div id="localList" class="p-4 divide-y divide-red-100 text-sm"></div>
            <div class="p-4 flex gap-2">
              <button id="btnLocalClear" class="w-full rounded-xl bg-white border border-red-200 py-2.5 px-4 text-sm hover:bg-red-50">Limpiar</button>
              <button id="btnLocalExport" class="w-full rounded-xl bg-white border border-red-200 py-2.5 px-4 text-sm hover:bg-red-50">Exportar CSV</button>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Modal Scanner -->
  <div id="scanOverlay" class="hidden fixed inset-0 bg-red-900/50 glass flex items-center justify-center p-4 z-50">
    <div class="w-full max-w-md rounded-2xl overflow-hidden shadow-xl bg-white">
      <div class="p-4 bg-gradient-to-r from-red-800 to-red-600 text-white flex items-center justify-between">
        <h3 class="font-semibold">Escanear ICC</h3>
        <button id="btnCloseScan" class="text-sm underline">Cerrar</button>
      </div>
      <div class="p-4 space-y-3">
        <div id="scanSupport" class="text-sm text-red-700"></div>
        <video id="scanVideo" class="w-full rounded-xl bg-black aspect-[3/4]" autoplay muted playsinline></video>
        <div class="text-sm text-red-700/80">Apunta al código de barras (Code128/EAN). Si no aparece, escribe el ICC manualmente.</div>
      </div>
      <div class="p-4 bg-red-50 flex justify-end">
        <button id="btnStopScan" class="rounded-xl bg-white border border-red-200 py-2 px-4 text-sm hover:bg-red-100">Detener</button>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // ⚙️ CONFIG
    // ==============================
    const GAS_BASE_URL = 'https://script.google.com/macros/s/REEMPLAZA_CON_TU_WEBAPP/exec'; // TODO: sustituir
    const VALID_PLAZAS = ['MONTERREY','MANTE','REYNOSA','MATAMOROS','SALTILLO','CHIHUAHUA','DELICIAS','CUAHUTEMOC','TAMPICO'];

    // ==============================
    // 🧩 Utilidades
    // ==============================
    const $ = (id)=> document.getElementById(id);
    const onlyDigits = (s)=> (s||'').replace(/\D+/g,'');
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    function luhnCheck(num){ const s=onlyDigits(num); if(s.length<19) return false; let sum=0,dbl=false; for(let i=s.length-1;i>=0;i--){ let d=+s[i]; if(dbl){ d*=2; if(d>9) d-=9; } sum+=d; dbl=!dbl; } return sum%10===0; }
    function netUpdate(){ const el=$('netStatus'); const on=navigator.onLine; el.textContent= on? 'En línea' : 'Sin conexión'; el.className='text-xs '+(on?'text-green-100':'text-yellow-200'); }
    window.addEventListener('online',netUpdate); window.addEventListener('offline',netUpdate); netUpdate();

    function show(el){ el.classList.remove('hidden'); } function hide(el){ el.classList.add('hidden'); }
    function navHome(){ show(portada); hide(cardFicha); hide(cardActivar); hide(cardEncuesta); }

    // ==============================
    // 🧭 Navegación
    // ==============================
    const portada=$('portada'); const cardFicha=$('cardFicha'); const cardActivar=$('cardActivar'); const cardEncuesta=$('cardEncuesta');
    $('btnGoFicha').onclick=()=>{ show(cardFicha); hide(cardActivar); hide(cardEncuesta); hide(portada); };
    $('btnGoActivar').onclick=()=>{ show(cardActivar); hide(cardFicha); hide(cardEncuesta); hide(portada); };
    $('btnGoEncuesta').onclick=()=>{ show(cardEncuesta); hide(cardFicha); hide(cardActivar); hide(portada); renderCompanyButtons(); };

    // ==============================
    // 📄 FICHA
    // ==============================
    const formFicha=$('formFicha'); const iccHint1=$('iccHint1');
    formFicha.addEventListener('input',()=> iccHint1.classList.add('hidden'));
    formFicha.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data={
        action:'capture',
        timestamp:new Date().toISOString(),
        plaza: valSel('plaza', v=> VALID_PLAZAS.includes(v), 'Selecciona plaza válida'),
        carrier: valSel('carrier', v=> !!v, 'Selecciona carrier'),
        promotor: valSel('promotor', v=> v.trim().length>0, 'Escribe promotor'),
        telefono: valSel('telefono', v=> onlyDigits(v).length===10, 'Número 10 dígitos'),
        nip: valSel('nip', v=> onlyDigits(v).length===4, 'NIP 4 dígitos'),
        icc: valSel('icc', v=> onlyDigits(v).length===19 && luhnCheck(v), 'ICC 19 dígitos (Luhn)'),
        curp: ( $('curp').value||'' ).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,18)
      };
      await submitWithSpinner('btnFichaSubmit','spinFicha', async ()=>{
        await postGAS(data);
        pushLocal({t:'FICHA', tel:data.telefono, icc:data.icc, prom:data.promotor});
        alert('Ficha creada'); navHome(); formFicha.reset();
      });
    });
    function valSel(id, test, msg){ const el=$(id); const v=el.value; if(!test(v)){ alert(msg); el.focus(); throw null; } return v; }

    // ==============================
    // ⚡ ACTIVAR CHIP
    // ==============================
    let tipoSeleccionado='';
    for (const b of document.querySelectorAll('.btn-tipo')){
      b.addEventListener('click', ()=>{ tipoSeleccionado=b.dataset.tipo; $('tipoSel').textContent='Seleccionado: '+tipoSeleccionado; });
    }
    const formActivar=$('formActivar'); const iccHint2=$('iccHint2');
    formActivar.addEventListener('input',()=> iccHint2.classList.add('hidden'));
    formActivar.addEventListener('submit', async (e)=>{
      e.preventDefault(); if(!tipoSeleccionado) return alert('Selecciona tipo (Azul/Blanco)');
      const icc = onlyDigits($('icc2').value);
      if (icc && (!luhnCheck(icc) || icc.length!==19)){ iccHint2.classList.remove('hidden'); return; }
      const data={
        action:'activate', timestamp:new Date().toISOString(), tipo: tipoSeleccionado,
        icc: icc || '', numero: valSel('numero2', v=> onlyDigits(v).length===10, 'Número 10 dígitos'),
        monto: valSel('monto2', v=> Number(onlyDigits(v))>0, 'Monto inválido'), promotor: valSel('promotor2', v=> v.trim().length>0, 'Escribe promotor')
      };
      await submitWithSpinner('btnActivarSubmit','spinAct', async ()=>{
        await postGAS(data);
        pushLocal({t:'ACT', tipo:data.tipo, num:data.numero, icc:data.icc, monto:data.monto, prom:data.promotor});
        $('actInfo').textContent = `Registrado: ${data.tipo} • ${data.numero} ${data.icc?('• ICC '+data.icc):''}`;
        formActivar.reset(); tipoSeleccionado=''; $('tipoSel').textContent='';
      });
    });

    // ==============================
    // 🧪 Encuesta
    // ==============================
    const COMPANIES=['Movistar','AT&T','Unefon','Bait','OXXO Cel','Virgin','Rincel','Telcel'];
    const COMPANY_QUESTIONS={
      'Movistar':[{q:'¿Se te corta la señal en interiores?',options:[{t:'Sí',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]},{q:'¿Tus datos rinden menos de lo esperado?',options:[{t:'Sí',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]},{q:'¿Llamadas con eco o retraso?',options:[{t:'Sí',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]}],
      'AT&T':[ {q:'¿Te quedas sin cobertura en traslados?',options:[{t:'Sí',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]},{q:'¿Te limitan apps o redes sociales?',options:[{t:'Sí',w:0.8},{t:'A veces',w:0.5},{t:'No',w:0.2}]},{q:'¿Sientes lentitud en horas pico?',options:[{t:'Sí',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]}],
      'Unefon':[ {q:'¿Cambios de velocidad inesperados?',options:[{t:'Sí',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]},{q:'¿Cobertura irregular en tu colonia?',options:[{t:'Sí',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]},{q:'¿Problemas para compartir internet?',options:[{t:'Sí',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]}],
      'Bait':[ {q:'¿Te falla en interiores (centros comerciales)?',options:[{t:'Sí',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]},{q:'¿Ves baja velocidad por la tarde-noche?',options:[{t:'Sí',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]},{q:'¿Pierdes señal en carretera?',options:[{t:'Sí',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]}],
      'OXXO Cel':[ {q:'¿Redes sociales cargan lento?',options:[{t:'Sí',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]},{q:'¿Se cae la llamada seguido?',options:[{t:'Sí',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]},{q:'¿Descargas tardan demasiado?',options:[{t:'Sí',w:0.8},{t:'A veces',w:0.5},{t:'No',w:0.2}]}],
      'Virgin':[ {q:'¿Apps bancarias fallan fuera de casa?',options:[{t:'Sí',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]},{q:'¿Mala señal en oficinas/escuela?',options:[{t:'Sí',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]},{q:'¿Sufres latencia en videollamadas?',options:[{t:'Sí',w:0.8},{t:'A veces',w:0.5},{t:'No',w:0.2}]}],
      'Rincel':[ {q:'¿Se pierde señal al entrar a edificios?',options:[{t:'Sí',w:1.0},{t:'A veces',w:0.6},{t:'No',w:0.2}]},{q:'¿Internet intermitente?',options:[{t:'Sí',w:0.9},{t:'A veces',w:0.5},{t:'No',w:0.2}]},{q:'¿Dificultad para hotspot?',options:[{t:'Sí',w:0.8},{t:'A veces',w:0.5},{t:'No',w:0.2}]}],
      'Telcel':[] };
    function renderCompanyButtons(){ const wrap=$('companyButtons'); wrap.innerHTML=''; COMPANIES.forEach(c=>{ const b=document.createElement('button'); b.type='button'; b.className='rounded-xl border border-red-200 px-3 py-1.5 text-sm hover:bg-red-50'; b.textContent=c; b.addEventListener('click',()=>selectCompany(c)); wrap.appendChild(b); }); }
    const notaTelcel=$('notaTelcel'), surveyQuestions=$('surveyQuestions'), scoreValue=$('scoreValue'), pitchValue=$('pitchValue'), planValue=$('planValue'), surveyResult=$('surveyResult');
    let currentCompany=null; let currentAnswers=[];
    function selectCompany(company){ currentCompany=company; currentAnswers=[]; surveyQuestions.innerHTML=''; surveyResult.classList.add('hidden'); if(company==='Telcel'){ notaTelcel.classList.remove('hidden'); surveyQuestions.classList.add('hidden'); return; } notaTelcel.classList.add('hidden'); const qs=COMPANY_QUESTIONS[company]||[]; if(!qs.length){ surveyQuestions.classList.add('hidden'); return; } surveyQuestions.classList.remove('hidden'); qs.forEach((item,idx)=>{ const wrap=document.createElement('div'); wrap.className='rounded-xl border border-red-200 p-4'; const title=document.createElement('div'); title.className='font-medium'; title.textContent=`${idx+1}. ${item.q}`; const opts=document.createElement('div'); opts.className='mt-3 flex flex-wrap gap-2'; item.options.forEach(opt=>{ const ob=document.createElement('button'); ob.type='button'; ob.className='rounded-lg bg-white border border-red-200 px-3 py-1.5 text-sm hover:bg-red-50'; ob.textContent=opt.t; ob.addEventListener('click',()=>{ currentAnswers[idx]=opt.w; [...opts.children].forEach(ch=>ch.classList.remove('ring-2','ring-red-400')); ob.classList.add('ring-2','ring-red-400'); const sum=currentAnswers.filter(n=>typeof n==='number').reduce((a,b)=>a+b,0); const count=currentAnswers.filter(n=>typeof n==='number').length; const score=count?sum:0; scoreValue.textContent=score.toFixed(2); pitchValue.textContent=pitchByCompanyAndScore(company,score); planValue.textContent=planByScore(score); surveyResult.classList.remove('hidden'); }); opts.appendChild(ob); }); wrap.appendChild(title); wrap.appendChild(opts); surveyQuestions.appendChild(wrap); }); }
    function planByScore(score){ if(score>=2.4) return 'Amigo Sin Límite 150'; if(score>=1.6) return 'Amigo Sin Límite 100'; return 'Amigo Sin Límite 80'; }
    function pitchByCompanyAndScore(company,score){ const alta='Veo varios puntos de dolor. Con Telcel mejoras cobertura en interiores y estabilidad en horas pico.'; const media='Hay áreas de mejora. Con Telcel ganas estabilidad y mejor rendimiento en apps.'; const baja='Tu experiencia es decente, pero con Telcel puedes asegurar señal donde hoy te falla.'; if(score>=2.4) return `${alta} (${company})`; if(score>=1.6) return `${media} (${company})`; return `${baja} (${company})`; }

    // ==============================
    // 🌐 GAS helpers
    // ==============================
    async function postGAS(body){ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), 10000); const res = await fetch(GAS_BASE_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body), signal: ctrl.signal }); clearTimeout(t); if(!res.ok) throw new Error('HTTP '+res.status); return res.json().catch(()=>({ok:true})); }
    async function submitWithSpinner(btnId, spinId, fn){ const btn=$(btnId), spin=$(spinId); btn.classList.add('btn-disabled'); spin.classList.remove('hidden'); try{ await fn(); } finally { btn.classList.remove('btn-disabled'); spin.classList.add('hidden'); } }

    // ==============================
    // 🗂️ Historial local
    // ==============================
    const LKEY='mada_local_events';
    function getLocal(){ try{ return JSON.parse(localStorage.getItem(LKEY))||[]; } catch{ return []; } }
    function setLocal(arr){ localStorage.setItem(LKEY, JSON.stringify(arr.slice(0,10))); renderLocal(); }
    function pushLocal(ev){ const list=getLocal(); list.unshift({ts:new Date().toLocaleString(), ...ev}); setLocal(list); }
    function renderLocal(){ const list=getLocal(); const cont=$('localList'); cont.innerHTML=''; if(!list.length){ cont.innerHTML='<div class="text-red-700/80 text-sm">Vacío.</div>'; return; } list.forEach(x=>{ const d=document.createElement('div'); d.className='py-2'; d.textContent=`${x.ts} · ${x.t} ${x.tipo?('· '+x.tipo):''} ${x.tel||x.num||''} ${x.icc?('· ICC '+x.icc):''}`; cont.appendChild(d); }); }
    $('btnLocalClear').onclick=()=> setLocal([]);
    $('btnLocalExport').onclick=()=>{ const list=getLocal(); if(!list.length) return alert('Nada que exportar'); const header=Object.keys(list[0]); const rows=[header.join(',')].concat(list.map(o=> header.map(k=>`"${String(o[k]??'').replace(/"/g,'""')}"`).join(','))); const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='historial_local.csv'; a.click(); URL.revokeObjectURL(url); };
    renderLocal();

    // ==============================
    // 📷 Scanner ICC reutilizable
    // ==============================
    const scanOverlay=$('scanOverlay'), scanVideo=$('scanVideo'), scanSupport=$('scanSupport'); let mediaStream=null, barcodeDetector=null, scanLoopActive=false, currentScanTarget=null;
    $('btnScanICC1').onclick=()=> openScannerFor('icc');
    $('btnScanICC2').onclick=()=> openScannerFor('icc2');
    $('btnCloseScan').onclick=closeScan; $('btnStopScan').onclick=closeScan;
    async function openScannerFor(inputId){ currentScanTarget=$(inputId); scanOverlay.classList.remove('hidden'); if('BarcodeDetector' in window){ try{ barcodeDetector=new BarcodeDetector({formats:['code_128','ean_13','ean_8','upc_a','upc_e','code_39']}); scanSupport.textContent='Soporte nativo. Escanea el ICC.'; } catch{ barcodeDetector=null; scanSupport.textContent='Error en detector. Ingresa ICC manual.'; } } else { scanSupport.textContent='Sin soporte nativo. Ingresa ICC manual.'; } await startCam(); if(barcodeDetector) loopScan(); }
    async function startCam(){ try{ mediaStream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } }); scanVideo.srcObject=mediaStream; await scanVideo.play(); } catch{ scanSupport.textContent='No se pudo acceder a la cámara.'; } }
    function stopCam(){ if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; } scanVideo.pause(); scanVideo.srcObject=null; }
    function closeScan(){ scanOverlay.classList.add('hidden'); stopCam(); scanLoopActive=false; currentScanTarget=null; }
    async function loopScan(){ scanLoopActive=true; while(scanLoopActive && barcodeDetector && scanVideo.readyState>=2){ try{ const codes=await barcodeDetector.detect(scanVideo); if(codes && codes.length){ const digits=onlyDigits(codes[0].rawValue||''); if(digits.length>=19){ currentScanTarget.value=digits.slice(0,19); closeScan(); break; } } } catch{} await sleep(200); } }

    // Inicio
    const portadaEl=$('portada'); portadaEl && portadaEl.classList.remove('hidden');
  </script>
</body>
</html>
