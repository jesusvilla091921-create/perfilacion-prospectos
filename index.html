<!DOCTYPE html>
<html lang="es" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MADA · Portabilidad</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#003b8f">
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
  </style>
</head>
<body class="h-full text-slate-800">
  <div class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-[#0a2f6b] to-[#003b8f] text-white">
      <div class="max-w-7xl mx-auto px-4 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-[#00aeef] flex items-center justify-center font-bold text-[#0a2f6b]">M</div>
          <div>
            <h1 class="text-xl font-semibold tracking-wide">MADA · Portabilidad</h1>
            <p class="text-white/80 text-sm">Flujo de perfilación y captura</p>
          </div>
        </div>
        <div class="hidden sm:block text-white/80 text-sm">Corporativo · Operación en campo</div>
      </div>
    </header>

    <main class="flex-1">
      <div class="max-w-7xl mx-auto px-4 py-6 lg:py-10 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Panel principal -->
        <section class="lg:col-span-2 space-y-6">

          <!-- Portada -->
          <div id="portada" class="rounded-2xl bg-white shadow-sm p-6 border border-slate-100 text-center space-y-4">
            <h2 class="text-lg font-semibold text-slate-700">Bienvenido</h2>
            <p class="text-slate-500">Selecciona cómo quieres comenzar</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-4">
              <button id="btnEncuesta" class="px-6 py-3 rounded-xl bg-[#0a2f6b] text-white font-medium hover:bg-[#003b8f]">Comenzar encuesta</button>
              <button id="btnFicha" class="px-6 py-3 rounded-xl bg-[#00aeef] text-white font-medium hover:bg-[#0098d1]">Ir directo a captura</button>
            </div>
          </div>

          <!-- Encuesta -->
          <div id="encuesta" class="hidden rounded-2xl bg-white shadow-sm p-6 border border-slate-100">
            <h2 class="text-lg font-semibold text-slate-700">Diagnóstico rápido</h2>
            <div id="encuestaContent" class="mt-4 space-y-4"></div>
            <div id="encuestaResultado" class="mt-4 hidden">
              <p class="font-medium text-slate-600">Score: <span id="scoreVal" class="font-bold"></span></p>
              <p id="pitchVal" class="text-slate-600"></p>
              <p id="planVal" class="text-[#003b8f] font-semibold"></p>
              <div class="flex gap-3 mt-3">
                <button id="aceptaCambio" class="px-4 py-2 bg-[#0a2f6b] text-white rounded-lg">Aceptar cambio</button>
                <button id="rechazaCambio" class="px-4 py-2 bg-slate-300 text-slate-800 rounded-lg">No aceptar</button>
              </div>
            </div>
          </div>

          <!-- Ficha de captura -->
          <div id="ficha" class="hidden rounded-2xl bg-white shadow-sm p-6 border border-slate-100">
            <h2 class="text-lg font-semibold text-slate-700">Ficha de captura</h2>
            <form id="formFicha" class="mt-4 space-y-4">

              <div>
                <label class="block text-sm font-medium text-slate-600">Plaza</label>
                <select id="plaza" required class="w-full rounded-lg border-slate-300">
                  <option value="">Seleccione...</option>
                  <option>MONTERREY</option>
                  <option>MANTE</option>
                  <option>REYNOSA</option>
                  <option>MATAMOROS</option>
                  <option>SALTILLO</option>
                  <option>CHIHUAHUA</option>
                  <option>DELICIAS</option>
                  <option>CUAHUTEMOC</option>
                  <option>TAMPICO</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600">Compañía actual</label>
                <select id="carrier" required class="w-full rounded-lg border-slate-300">
                  <option value="">Seleccione...</option>
                  <option>Telcel</option>
                  <option>Movistar</option>
                  <option>AT&T</option>
                  <option>Unefon</option>
                  <option>Bait</option>
                  <option>OXXO Cel</option>
                  <option>Virgin</option>
                  <option>Rincel</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600">Nombre completo</label>
                <input type="text" id="nombreCompleto" required class="w-full rounded-lg border-slate-300" />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600">Teléfono</label>
                <input type="text" id="telefono" maxlength="10" required class="w-full rounded-lg border-slate-300" />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600">Fecha de nacimiento</label>
                <input type="date" id="fechaNacimiento" required class="w-full rounded-lg border-slate-300" />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600">Estado de nacimiento</label>
                <input type="text" id="estadoNacimiento" required class="w-full rounded-lg border-slate-300" />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600">CURP (opcional)</label>
                <input type="text" id="curp" class="w-full rounded-lg border-slate-300 uppercase" />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600">ICC</label>
                <input type="text" id="icc" maxlength="20" required class="w-full rounded-lg border-slate-300" />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600">NIP</label>
                <input type="text" id="nip" maxlength="4" required class="w-full rounded-lg border-slate-300" />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-600">Promotor (opcional)</label>
                <input type="text" id="promotor" class="w-full rounded-lg border-slate-300" />
              </div>

              <button type="submit" class="w-full py-3 bg-[#0a2f6b] text-white rounded-xl">Crear ficha</button>
            </form>
          </div>

        </section>

        <!-- Panel lateral -->
        <aside class="bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
          <h3 class="font-semibold text-slate-700">Leads capturados (local)</h3>
          <ul id="listaLeads" class="mt-3 space-y-2 text-sm"></ul>
        </aside>
      </div>
    </main>
  </div>

  <!-- Modal ticket -->
  <div id="ticketModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="glass bg-white rounded-2xl shadow-lg max-w-lg w-full p-6">
      <h3 class="text-lg font-semibold text-[#0a2f6b]">Ficha creada</h3>
      <div class="mt-4 space-y-2 text-slate-700 text-sm" id="ticketContent"></div>
      <button id="cerrarModal" class="mt-4 px-4 py-2 bg-[#0a2f6b] text-white rounded-lg">Listo</button>
    </div>
  </div>

  <!-- JS embebido -->
  <script>
  const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbybcdCYQtssors41pDr-XnUsVy0sOP0uMQlOMYRGiWok7jRu3Da4jW_bCSQ_hcx6W7c7g/exec";

  const portada = document.getElementById("portada");
  const encuesta = document.getElementById("encuesta");
  const ficha = document.getElementById("ficha");

  document.getElementById("btnEncuesta").onclick = () => {
    portada.classList.add("hidden");
    encuesta.classList.remove("hidden");
  };

  document.getElementById("btnFicha").onclick = () => {
    portada.classList.add("hidden");
    ficha.classList.remove("hidden");
  };

  document.getElementById("formFicha").addEventListener("submit", async (e) => {
    e.preventDefault();

    const record = {
      type: "capture",
      plaza: document.getElementById("plaza").value,
      carrier: document.getElementById("carrier").value,
      nombreCompleto: document.getElementById("nombreCompleto").value,
      telefono: document.getElementById("telefono").value,
      fechaNacimiento: document.getElementById("fechaNacimiento").value,
      estadoNacimiento: document.getElementById("estadoNacimiento").value,
      curp: document.getElementById("curp").value.toUpperCase(),
      icc: document.getElementById("icc").value,
      nip: document.getElementById("nip").value,
      promotor: document.getElementById("promotor").value,
      estatus: "Portabilidad iniciada"
    };

    try {
      const res = await fetch(SHEETS_WEBAPP_URL, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: "payload=" + JSON.stringify(record)
      });
      const data = await res.json();
      if (data.ok) {
        mostrarTicket(record);
        guardarLocal(record);
      } else {
        alert("Error al enviar: " + data.error);
      }
    } catch (err) {
      alert("No se pudo enviar a Sheets. Inténtalo de nuevo.");
      console.error(err);
    }
  });

  function mostrarTicket(rec) {
    const modal = document.getElementById("ticketModal");
    const content = document.getElementById("ticketContent");
    content.innerHTML = `
      <p><span class="mono">${rec.telefono} • ${rec.nip}</span></p>
      <p><span class="mono">${rec.icc}</span></p>
      <p>${rec.nombreCompleto}</p>
      <p>${rec.plaza} • ${rec.carrier}</p>
      <p>${rec.fechaNacimiento} • ${rec.estadoNacimiento}</p>
      <p>${rec.promotor || "—"}</p>
    `;
    modal.classList.remove("hidden");
    document.getElementById("cerrarModal").onclick = () => {
      modal.classList.add("hidden");
      document.getElementById("formFicha").reset();
      ficha.classList.add("hidden");
      portada.classList.remove("hidden");
    };
  }

  function guardarLocal(rec) {
    let leads = JSON.parse(localStorage.getItem("leads") || "[]");
    leads.unshift({
      ts: new Date().toLocaleString(),
      nombre: rec.nombreCompleto,
      tel: rec.telefono,
      carrier: rec.carrier,
      plaza: rec.plaza,
      icc: rec.icc.slice(-6),
      estatus: rec.estatus
    });
    leads = leads.slice(0, 12);
    localStorage.setItem("leads", JSON.stringify(leads));
    renderLeads();
  }

  function renderLeads() {
    let leads = JSON.parse(localStorage.getItem("leads") || "[]");
    const ul = document.getElementById("listaLeads");
    ul.innerHTML = "";
    leads.forEach(l => {
      const li = document.createElement("li");
      let color = "text-blue-600";
      if (l.estatus.includes("Confirmado")) color = "text-green-600";
      if (l.estatus.includes("Rechazado")) color = "text-red-600";
      li.innerHTML = `<span class="${color}">●</span> ${l.ts} — ${l.nombre} (${l.tel}) [${l.carrier}/${l.plaza}] ICC:${l.icc}`;
      ul.appendChild(li);
    });
  }

  renderLeads();
  </script>
</body>
</html>
