<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MADA OCR ‚Äì Recolector Inteligente</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <style>
    :root{--bg:#0b1220;--card:#111827;--muted:#94a3b8;--accent:#3b82f6;--good:#10b981;--bad:#ef4444}
    *{box-sizing:border-box;font-family:Poppins,system-ui,Segoe UI,Roboto}
    body{margin:0;background:var(--bg);color:#e5e7eb}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:18px;padding:20px}
    h1{font-size:22px;margin:0 0 12px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .grow{flex:1 1 320px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #273142;background:#0f172a;color:#fff}
    button{background:var(--accent);border-color:transparent;font-weight:600;cursor:pointer}
    button.secondary{background:#0f172a;border:1px dashed #334155}
    #drop{border:2px dashed #334155;border-radius:16px;padding:20px;text-align:center;color:#94a3b8}
    #log{font-family:ui-monospace,Consolas,monospace;background:#0b1020;border-radius:12px;padding:12px;white-space:pre-wrap;line-height:1.4;max-height:220px;overflow:auto}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:rgba(16,185,129,.15);color:#34d399}
    .warn{background:rgba(239,68,68,.15);color:#f87171}
    .flex{display:flex;gap:12px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üì∏ MADA OCR ‚Äì Recolector Inteligente</h1>
      <p style="color:#94a3b8">Sube tus capturas de BES. Limpio la imagen, leo el texto (OCR), extraigo <b>Tel√©fono</b> e <b>ICC</b>, y lo env√≠o al sistema con tu nombre.</p>

      <div class="row">
        <div class="grow">
          <label>Promotor / Supervisor</label>
          <input id="promotor" placeholder="Ej. Fernanda" />
        </div>
        <div class="grow">
          <label>Selecciona im√°genes</label>
          <input id="file" type="file" accept="image/*" multiple />
        </div>
      </div>

      <div id="drop" style="margin-top:12px">Arrastra aqu√≠ tus capturas o usa el selector</div>

      <div class="row" style="margin-top:16px">
        <div class="grow">
          <label>Tel√©fono (detectado)</label>
          <input id="telefono" placeholder="10 d√≠gitos" />
        </div>
        <div class="grow">
          <label>ICC / ICCID (detectado)</label>
          <input id="icc" placeholder="Empieza con 89‚Ä¶" />
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <div class="grow flex">
          <button id="btn-ocr">üîç Procesar OCR</button>
          <button id="btn-enviar" class="secondary">üöÄ Enviar al backend</button>
        </div>
      </div>

      <div id="out" style="margin-top:16px" class="row">
        <div class="grow card" style="background:#0e1526">
          <label>Resultado</label>
          <div id="status" class="pill">Listo</div>
          <div id="log" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby8y9CUxIR3MCtAe5kY-69v2OVNFmUb_RNx36Lf3b1THHe9livhxUXK7ORPof7AqWV2/exec';

const fileInput = document.getElementById('file');
const drop = document.getElementById('drop');
const promotorEl = document.getElementById('promotor');
const telEl = document.getElementById('telefono');
const iccEl = document.getElementById('icc');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');

let images = [];

function log(msg){
  logEl.textContent += `${msg}\n`;
  logEl.scrollTop = logEl.scrollHeight;
}

// Drag & drop
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.borderColor='#3b82f6'}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.borderColor='#334155'}));
drop.addEventListener('drop', e=>{
  images = [...e.dataTransfer.files].filter(f=>f.type.startsWith('image/'));
  log(`üì• ${images.length} archivo(s) agregados.`);
});
fileInput.addEventListener('change', e=>{
  images = [...e.target.files];
  log(`üì• ${images.length} archivo(s) agregados.`);
});

// Procesamiento de imagen simple
async function preprocessImage(file){
  const img = await createImageBitmap(file);
  const cnv = document.createElement('canvas');
  cnv.width = img.width; cnv.height = img.height;
  const ctx = cnv.getContext('2d');
  ctx.drawImage(img,0,0);
  const {data,width,height} = ctx.getImageData(0,0,cnv.width,cnv.height);
  const out = new Uint8ClampedArray(data.length);
  const contrast = 1.25;
  for(let i=0;i<data.length;i+=4){
    const r=data[i], g=data[i+1], b=data[i+2];
    let gray = 0.2126*r + 0.7152*g + 0.0722*b;
    gray = ((gray-128)*contrast)+128;
    gray = Math.max(0, Math.min(255, gray));
    const bw = gray>160 ? 255 : 0;
    out[i]=out[i+1]=out[i+2]=bw; out[i+3]=255;
  }
  ctx.putImageData(new ImageData(out,width,height),0,0);
  return cnv;
}

function extractPhone(text){
  const candidates = [...text.replace(/\D+/g,' ').matchAll(/(?<!\d)(\d{10})(?!\d)/g)].map(m=>m[1]);
  return candidates.length? candidates[candidates.length-1] : '';
}

function extractICC(text){
  const digits = text.replace(/[^0-9]/g,'');
  const m = digits.match(/89\d{17,18}/);
  return m? m[0] : '';
}

async function runOCR(){
  if(!images.length){alert('Agrega al menos una imagen.');return}
  statusEl.textContent='Procesando‚Ä¶'; statusEl.className='pill';
  log('üßΩ Preprocesando y ejecutando OCR‚Ä¶');
  let fullText = '';
  for(const f of images){
    const cnv = await preprocessImage(f);
    const dataUrl = cnv.toDataURL('image/png');
    const { data: { text } } = await Tesseract.recognize(dataUrl, 'eng+spa', { logger: m=>{ if(m.status==='recognizing text'){ statusEl.textContent = `OCR ${Math.round(m.progress*100)}%`; } } });
    log(`‚úÖ ${f.name} procesado`);
    fullText += '\n' + text;
  }
  const tel = extractPhone(fullText);
  const icc = extractICC(fullText);
  telEl.value = tel || '';
  iccEl.value = icc || '';
  statusEl.textContent = 'Listo'; statusEl.className='pill ok';
  log('üìÑ Texto combinado:\n' + fullText.slice(0,1200));
  log(`üì± Tel√©fono: ${tel||'‚Äî'} | üí≥ ICC: ${icc||'‚Äî'}`);
}

document.getElementById('btn-ocr').addEventListener('click', ()=>runOCR());

async function enviar(){
  const promotor = promotorEl.value.trim();
  const telefono = (telEl.value||'').replace(/\D/g,'');
  const icc = (iccEl.value||'').replace(/\D/g,'');
  if(!promotor || telefono.length!==10 || !(icc.length===19||icc.length===20)){
    alert('Revisa los datos: promotor, tel√©fono (10 d√≠gitos) e ICC (19‚Äì20).');return;
  }
  const payload = {promotor, telefono, icc};
  statusEl.textContent='Enviando‚Ä¶'; statusEl.className='pill';
  try{
    const res = await fetch(WEBAPP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    statusEl.textContent = json.status==='ok' ? 'Registrado' : 'Aviso';
    statusEl.className = 'pill ' + (json.status==='ok'?'ok':'warn');
    log(`üñ•Ô∏è Servidor: ${json.message}`);
  }catch(e){
    statusEl.textContent='Error'; statusEl.className='pill warn';
    log('‚ùå Error enviando: '+e.message);
  }
}

document.getElementById('btn-enviar').addEventListener('click', enviar);
</script>
</body>
</html>
