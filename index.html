<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MADA - Registro de Portabilidades</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5; /* Indigo */
            --primary-dark: #4338ca;
            --primary-light: #6366f1;
            --secondary: #0ea5e9; /* Sky */
            --accent: #10b981; /* Emerald */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --dark: #0f172a; /* Slate 900 */
            --darker: #000000;
            --light: #f8fafc;
            --gray: #94a3b8;
            --text: #e2e8f0;
            --text-light: #94a3b8;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            padding: 0;
        }

        .app-container {
            max-width: 500px;
            margin: 1rem auto;
            min-height: calc(100vh - 2rem);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            background: var(--dark);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .logo-icon {
            font-size: 2rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .company-name { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; }
        .app-title { font-size: 1.1rem; font-weight: 500; opacity: 0.9; margin-bottom: 15px; }
        .app-subtitle { font-size: 0.9rem; opacity: 0.8; }

        /* Main Content */
        .main-content { flex: 1; padding: 1.5rem 1rem; display: flex; flex-direction: column; gap: 1.5rem; }

        /* Card Styles */
        .card {
            background: var(--darker);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
        }

        .card-title i { color: var(--primary-light); }

        /* Form Styles */
        .form-group { margin-bottom: 1.2rem; }
        .form-label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light); }
        .form-input {
            width: 100%;
            padding: 0.9rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: var(--radius);
            padding: 2rem 1rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1rem;
            background: rgba(79, 70, 229, 0.1);
        }

        .upload-area:hover, .upload-area.dragover { border-color: var(--primary-light); background-color: rgba(79, 70, 229, 0.2); }

        .upload-icon { font-size: 2.5rem; margin-bottom: 1rem; color: var(--secondary); }
        .upload-text { margin-bottom: 0.5rem; font-weight: 500; color: var(--text); }
        .upload-hint { font-size: 0.85rem; color: var(--text-light); }

        /* Manual Input Section */
        .manual-input-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .manual-input-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text); }
        .manual-input-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 768px) { .manual-input-grid { grid-template-columns: 1fr 1fr; } }

        /* Buttons */
        .btn { padding: 1rem 1.5rem; border-radius: var(--radius); border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 1rem; width: 100%; }

        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, var(--success) 100%); color: var(--darker); box-shadow: var(--shadow); }
        .btn-primary:hover { background: linear-gradient(135deg, var(--accent) 0%, #047857 100%); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .btn-secondary { background: var(--primary); color: white; }
        .btn-secondary:hover { background: var(--primary-dark); color: white; transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn:disabled { background-color: var(--gray); color: var(--text-light); cursor: not-allowed; transform: none; box-shadow: none; }
        .button-group { display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem; }
        @media (min-width: 768px) { .button-group { flex-direction: row; } .button-group .btn { width: 50%; } }

        /* Progress */
        .progress-container { margin-top: 1.5rem; display: none; }
        .progress-bar { height: 8px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); width: 0%; transition: width 0.3s ease; border-radius: 4px; }
        .progress-text { font-size: 0.85rem; color: var(--text-light); text-align: center; }

        /* Results */
        .results-container { margin-top: 1.5rem; display: none; }
        .result-card { border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius); padding: 1.2rem; background: rgba(255, 255, 255, 0.05); box-shadow: var(--shadow); }
        .result-title { font-weight: 600; font-size: 0.9rem; color: var(--text); }
        .result-status { padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-success { background-color: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-warning { background-color: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-error { background-color: rgba(239, 68, 68, 0.2); color: var(--error); }
        .result-label { font-weight: 500; font-size: 0.9rem; color: var(--text-light); }
        .result-value { font-weight: 600; font-size: 0.9rem; color: var(--text); text-align: right; }
        .result-field { display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 0.8rem; }

        /* Log Styles */
        .log { background: rgba(255, 255, 255, 0.05); border-radius: var(--radius); padding: 1rem; height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.5; border: 1px solid rgba(255, 255, 255, 0.1); }
        .log-entry { margin-bottom: 0.5rem; padding: 0.5rem; border-radius: 6px; }
        .log-entry.success { background-color: rgba(16, 185, 129, 0.1); color: var(--success); border-left: 3px solid var(--success); }
        .log-entry.error { background-color: rgba(239, 68, 68, 0.1); color: var(--error); border-left: 3px solid var(--error); }
        .log-entry.warning { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); border-left: 3px solid var(--warning); }
        .log-entry.info { background-color: rgba(79, 70, 229, 0.1); color: var(--primary-light); border-left: 3px solid var(--primary-light); }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .log-title { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }

        /* Footer */
        .footer { text-align: center; padding: 1.5rem; color: var(--text-light); font-size: 0.85rem; background: var(--darker); }

        /* Toast Notification */
        .toast { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: var(--radius); background-color: white; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 0.75rem; z-index: 1000; transform: translateX(150%); transition: transform 0.3s ease; max-width: 350px; color: var(--darker); }
        .toast.show { transform: translateX(0); }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--error); }
        .toast-warning { border-left: 4px solid var(--warning); }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üì±</div>
            </div>
            <div class="company-name">SERVICIOS INTEGRALES MADA</div>
            <div class="app-title">REGISTRA TUS PORTABILIDADES</div>
            <div class="app-subtitle">Captura r√°pida v√≠a OCR para n√≥mina sin complicaciones</div>
        </header>

        <main class="main-content">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-user"></i> Informaci√≥n del Promotor</h2>
                
                <div class="form-group">
                    <label class="form-label" for="promotor">Nombre del promotor:</label>
                    <input type="text" id="promotor" class="form-input" placeholder="Ingresa tu nombre completo" />
                    <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">
                        El sistema normalizar√° tu nombre a may√∫sculas y sin acentos autom√°ticamente.
                    </p>
                </div>
                
                <div class="manual-input-section">
                    <h3 class="manual-input-title"><i class="fas fa-keyboard"></i> Datos Manuales</h3>
                    <div class="manual-input-grid">
                        <div class="form-group">
                            <label class="form-label" for="telefonoManual">Tel√©fono (10 d√≠gitos):</label>
                            <input type="text" id="telefonoManual" class="form-input" placeholder="Ej. 5512345678" maxlength="10" />
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="iccManual">ICC (18-20 d√≠gitos):</label>
                            <input type="text" id="iccManual" class="form-input" placeholder="Ej. 8952... (solo n√∫meros)" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-file-upload"></i> Carga de Captura</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon"><i class="fas fa-camera"></i></div>
                    <div class="upload-text">
                        <p>Arrastra o toca para seleccionar una imagen</p>
                    </div>
                    <p class="upload-hint">Formatos: JPG, PNG. Intenta una imagen n√≠tida para mejor OCR.</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;" />
                </div>
            </div>

            <div class="card">
                <h2 class="card-title"><i class="fas fa-cogs"></i> Procesamiento</h2>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="btnOcr">
                        <i class="fas fa-search-plus"></i> Procesar OCR
                    </button>
                    <button class="btn btn-primary" id="btnEnviar">
                        <i class="fas fa-share-square"></i> Enviar Datos
                    </button>
                </div>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Esperando imagen...</div>
                </div>
            </div>

            <div class="card" id="resultsCard">
                <h2 class="card-title"><i class="fas fa-chart-bar"></i> Resultados de Extracci√≥n</h2>
                
                <div class="results-container" id="resultsContainer">
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-title">Datos Extra√≠dos / Manuales</div>
                            <div class="result-status status-error" id="resultStatus">Sin datos</div>
                        </div>
                        <div class="result-content">
                            <div class="result-field">
                                <span class="result-label">Tel√©fono:</span>
                                <span class="result-value" id="resultTelefono">‚Äî</span>
                            </div>
                            <div class="result-field">
                                <span class="result-label">ICCID:</span>
                                <span class="result-value" id="resultIcc">‚Äî</span>
                            </div>
                            <div class="result-field">
                                <span class="result-label">CURP:</span>
                                <span class="result-value" id="resultCurp">‚Äî</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="log-header">
                    <h2 class="log-title"><i class="fas fa-file-alt"></i> Registro de Actividad</h2>
                    <button class="btn btn-secondary btn-small" id="btnClearLog">
                        <i class="fas fa-trash-alt"></i> Limpiar
                    </button>
                </div>
                <div class="log-container">
                    <div class="log" id="log"></div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>SERVICIOS INTEGRALES MADA &copy; 2023 | Desarrollado con ‚ù§Ô∏è</p>
        </footer>
    </div>

    <div class="toast" id="toast">
        <div class="toast-icon" id="toastIcon"></div>
        <div class="toast-message" id="toastMessage"></div>
    </div>

    <script>
        // üöÄ URL DEL BACKEND (ACTUALIZADA POR TU AGENTE)
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzDyJ-RjfBT14NmlUT9RHndhJMqApNJJvwF4Gx54PT3XMxCbYprGR6oTEr4J9W_wARH/exec';
        
        let telefonoOCR = '', iccOCR = '', curpOCR = '';
        let imagenSeleccionada = null;

        const elementos = {
            promotor: document.getElementById("promotor"),
            telefonoManual: document.getElementById("telefonoManual"),
            iccManual: document.getElementById("iccManual"),
            fileInput: document.getElementById("fileInput"),
            uploadArea: document.getElementById("uploadArea"),
            btnOcr: document.getElementById("btnOcr"),
            btnEnviar: document.getElementById("btnEnviar"),
            progressContainer: document.getElementById("progressContainer"),
            progressFill: document.getElementById("progressFill"),
            progressText: document.getElementById("progressText"),
            resultsCard: document.getElementById("resultsCard"),
            resultTelefono: document.getElementById("resultTelefono"),
            resultIcc: document.getElementById("resultIcc"),
            resultCurp: document.getElementById("resultCurp"),
            resultStatus: document.getElementById("resultStatus"),
            log: document.getElementById("log"),
            btnClearLog: document.getElementById("btnClearLog"),
            toast: document.getElementById("toast"),
            toastIcon: document.getElementById("toastIcon"),
            toastMessage: document.getElementById("toastMessage")
        };

        document.addEventListener('DOMContentLoaded', function() {
            configurarEventListeners();
            elementos.resultsCard.style.display = 'none';
            actualizarResultados(); // Muestra el estado inicial "Sin datos"
            agregarLog("‚úÖ Sistema MADA inicializado. Listo para procesar portabilidades.", "info");
        });

        function configurarEventListeners() {
            // Carga de archivos
            elementos.uploadArea.addEventListener('click', () => elementos.fileInput.click());
            elementos.uploadArea.addEventListener('drop', (e) => { e.preventDefault(); manejarArchivo(e.dataTransfer.files[0]); });
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                elementos.uploadArea.addEventListener(eventName, e => e.preventDefault());
            });
            elementos.uploadArea.addEventListener('dragover', () => elementos.uploadArea.classList.add('dragover'));
            elementos.uploadArea.addEventListener('dragleave', () => elementos.uploadArea.classList.remove('dragover'));
            elementos.fileInput.addEventListener('change', (e) => manejarArchivo(e.target.files[0]));

            // Input manual: Limpieza y actualizaci√≥n
            elementos.telefonoManual.addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '').substring(0, 10);
                actualizarResultados();
            });
            elementos.iccManual.addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '');
                actualizarResultados();
            });

            // Botones
            elementos.btnOcr.addEventListener('click', procesarOCR);
            elementos.btnEnviar.addEventListener('click', enviarBackend);
            elementos.btnClearLog.addEventListener('click', limpiarLog);
        }

        // Normalizar texto (quitar acentos y convertir a may√∫sculas)
        function normalizarTexto(texto) {
            if (!texto) return '';
            return texto
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toUpperCase()
                .trim();
        }

        function manejarArchivo(file) {
            if (!file || !file.type.startsWith('image/')) {
                mostrarToast("El archivo seleccionado no es una imagen v√°lida", "error");
                agregarLog("‚ùå El archivo seleccionado no es una imagen v√°lida.", "error");
                return;
            }
            
            imagenSeleccionada = file;
            elementos.uploadArea.querySelector('.upload-text p').textContent = `Imagen: ${file.name}`;
            elementos.uploadArea.querySelector('.upload-hint').textContent = "Toca para cambiar de imagen | Listo para OCR";
            elementos.resultsCard.style.display = 'none';
            
            mostrarToast(`Imagen "${file.name}" cargada`, "success");
            agregarLog(`‚úÖ Imagen "${file.name}" cargada.`, "success");
        }

        async function procesarOCR() {
            if (!imagenSeleccionada) {
                mostrarToast("No hay imagen para procesar", "error");
                return;
            }
            
            // Bloquear interfaz
            elementos.btnOcr.disabled = true;
            elementos.btnEnviar.disabled = true;
            elementos.progressContainer.style.display = 'block';
            telefonoOCR = ''; iccOCR = ''; curpOCR = '';
            actualizarResultados();
            
            agregarLog("üîç Iniciando procesamiento OCR...", "info");
            
            try {
                // 1. Preprocesar imagen
                elementos.progressFill.style.width = '20%';
                elementos.progressText.textContent = "Preprocesando imagen (contraste y binarizaci√≥n)...";
                const canvas = await preprocessImage(imagenSeleccionada);
                const dataUrl = canvas.toDataURL('image/png');
                
                // 2. Realizar OCR
                elementos.progressFill.style.width = '50%';
                elementos.progressText.textContent = "Ejecutando Tesseract (puede tardar unos segundos)...";
                
                const result = await Tesseract.recognize(dataUrl, 'spa+eng', {
                    // Limitar caracteres para mejorar precisi√≥n en n√∫meros y c√≥digos
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-',
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            elementos.progressFill.style.width = `${50 + m.progress * 30}%`;
                        }
                    }
                });

                // 3. Procesar resultado
                elementos.progressFill.style.width = '80%';
                elementos.progressText.textContent = "Extrayendo y validando datos...";
                
                const text = result.data.text.replace(/\s+/g, ' ');
                
                extractData(text); // Actualiza telefonoOCR, iccOCR, curpOCR
                
                // Si el OCR extrae datos, actualizar los campos manuales (para edici√≥n)
                if (telefonoOCR) elementos.telefonoManual.value = telefonoOCR;
                if (iccOCR) elementos.iccManual.value = iccOCR;
                
                // 4. Finalizar
                elementos.progressFill.style.width = '100%';
                elementos.progressText.textContent = "Procesamiento completado";
                
                actualizarResultados();
                elementos.resultsCard.style.display = 'block';
                
                mostrarToast("OCR completado", "success");
                agregarLog(`‚úÖ OCR finalizado. Datos extra√≠dos.`, "success");
                agregarLog(`üìÑ Texto reconocido: ${text.substring(0, 80)}...`, "info");
                
            } catch (error) {
                console.error("Error en OCR:", error);
                mostrarToast("Error grave en OCR", "error");
                agregarLog(`‚ùå Error en el motor OCR: ${error.message}`, "error");
            } finally {
                // Desbloquear interfaz
                elementos.btnOcr.disabled = false;
                elementos.btnEnviar.disabled = false;
                setTimeout(() => elementos.progressContainer.style.display = 'none', 1500);
            }
        }

        // Funci√≥n de preprocesamiento (mantengo tu l√≥gica simple pero efectiva)
        async function preprocessImage(file) {
            const img = await createImageBitmap(file);
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;

            // Binarizaci√≥n simple adaptativa
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                const val = avg > 160 ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = val;
            }
            ctx.putImageData(imgData, 0, 0);
            return canvas;
        }

        // Detecci√≥n robusta de patrones
        function extractData(text) {
            // 1. Tel√©fono: 10 d√≠gitos aislados
            const matchTelefono = text.match(/\b\d{10}\b/g);
            telefonoOCR = matchTelefono ? matchTelefono[0] : '';

            // 2. ICC: 18-20 d√≠gitos que inician con '89' (patr√≥n SIM/ICCID)
            const matchIcc = text.match(/89\d{16,18}/g);
            iccOCR = matchIcc ? matchIcc[0] : '';

            // 3. CURP: Patr√≥n alfanum√©rico estricto (4 letras + 6 d√≠gitos + 8 alfanum√©ricos)
            const matchCurp = text.match(/[A-Z]{4}[0-9]{6}[A-Z0-9]{8}/i);
            curpOCR = matchCurp ? normalizarTexto(matchCurp[0]) : '';
        }

        // Actualizar resultados en la interfaz
        function actualizarResultados() {
            const telefonoFinal = elementos.telefonoManual.value;
            const iccFinal = elementos.iccManual.value;
            
            elementos.resultTelefono.textContent = telefonoFinal || '‚Äî';
            elementos.resultIcc.textContent = iccFinal || '‚Äî';
            elementos.resultCurp.textContent = curpOCR || '‚Äî';
            
            // Determinar estado de validaci√≥n
            const esTelefonoValido = telefonoFinal.length === 10;
            const esIccValido = iccFinal.length >= 18 && iccFinal.length <= 20;

            if (esTelefonoValido && esIccValido) {
                elementos.resultStatus.className = "result-status status-success";
                elementos.resultStatus.textContent = "LISTO PARA ENV√çO";
            } else if (esTelefonoValido || esIccValido) {
                elementos.resultStatus.className = "result-status status-warning";
                elementos.resultStatus.textContent = "DATOS PARCIALES";
            } else {
                elementos.resultStatus.className = "result-status status-error";
                elementos.resultStatus.textContent = "SIN DATOS";
            }
        }

        // Enviar datos al backend (Apps Script)
        async function enviarBackend() {
            const promotor = elementos.promotor.value.trim();
            const telefonoFinal = elementos.telefonoManual.value;
            const iccFinal = elementos.iccManual.value;
            
            // Validaciones
            if (!promotor) { mostrarToast("Ingresa el nombre del promotor", "error"); elementos.promotor.focus(); return; }
            if (telefonoFinal.length !== 10) { mostrarToast("El tel√©fono debe tener 10 d√≠gitos", "error"); return; }
            if (iccFinal.length < 18 || iccFinal.length > 20) { mostrarToast("El ICC debe tener entre 18 y 20 d√≠gitos", "error"); return; }
            
            const payload = { 
                action: "guardarRegistro", 
                promotor, 
                telefono: telefonoFinal, 
                icc: iccFinal 
            };
            
            elementos.progressContainer.style.display = 'block';
            elementos.progressFill.style.width = '30%';
            elementos.progressText.textContent = "Conectando con el servidor...";
            agregarLog("üöÄ Enviando datos de registro...", "info");
            
            try {
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Usamos text/plain para evitar problemas de CORS en algunos navegadores con Apps Script
                    body: JSON.stringify(payload)
                });
                
                // Apps Script devuelve un JSON. Lo parseamos.
                const text = await response.text();
                const result = JSON.parse(text); 

                elementos.progressFill.style.width = '100%';
                
                if (result.status === 'success') {
                    mostrarToast(result.message, "success");
                    agregarLog(result.message, "success");
                    limpiarFormulario();
                } else if (result.status === 'warning') {
                    mostrarToast(result.message, "warning");
                    agregarLog(result.message, "warning");
                } else {
                    throw new Error(result.message || "Error desconocido del servidor.");
                }
            } catch (err) {
                console.error("Error de env√≠o:", err);
                mostrarToast("Error al enviar los datos", "error");
                agregarLog(`‚ùå Error al enviar: ${err.message}. Verifica la URL del Apps Script.`, "error");
            } finally {
                setTimeout(() => elementos.progressContainer.style.display = 'none', 1500);
            }
        }

        // Limpiar formulario y variables
        function limpiarFormulario() {
            elementos.promotor.value = '';
            elementos.telefonoManual.value = '';
            elementos.iccManual.value = '';
            elementos.fileInput.value = '';
            elementos.uploadArea.querySelector('.upload-text p').textContent = 'Arrastra o toca para seleccionar una imagen';
            elementos.uploadArea.querySelector('.upload-hint').textContent = 'Formatos: JPG, PNG. Intenta una imagen n√≠tida para mejor OCR.';
            elementos.resultsCard.style.display = 'none';
            telefonoOCR = ''; iccOCR = ''; curpOCR = '';
            imagenSeleccionada = null;
            actualizarResultados();
        }

        // Agregar entrada al log
        function agregarLog(mensaje, tipo = "info") {
            const timestamp = new Date().toLocaleTimeString('es-MX');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${tipo}`;
            logEntry.textContent = `[${timestamp}] ${mensaje}`;
            elementos.log.appendChild(logEntry);
            elementos.log.scrollTop = elementos.log.scrollHeight;
        }

        // Limpiar log
        function limpiarLog() {
            elementos.log.innerHTML = '';
            agregarLog("Registro de actividad limpiado.", "info");
        }

        // Mostrar notificaci√≥n toast
        function mostrarToast(mensaje, tipo = "success") {
            elementos.toast.className = `toast toast-${tipo}`;
            elementos.toastMessage.textContent = mensaje;
            elementos.toastIcon.innerHTML = 
                tipo === "success" ? `<i class="fas fa-check-circle"></i>` : 
                tipo === "error" ? `<i class="fas fa-times-circle"></i>` : 
                tipo === "warning" ? `<i class="fas fa-exclamation-triangle"></i>` : `<i class="fas fa-info-circle"></i>`;
            
            elementos.toast.classList.add("show");
            
            setTimeout(() => { elementos.toast.classList.remove("show"); }, 3000);
        }
    </script>
</body>
</html>
