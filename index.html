<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MADA — Perfilación · Captura</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b;
      --brand:#0a2f6b; --brand-2:#003b8f; --accent:#00aeef; --soft:#f1f5f9;
    }
    body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .card{background:#fff;border:1px solid rgb(15 23 42/.08);box-shadow:0 2px 10px rgb(2 6 23/.04)}
    .pill{border-radius:999px}
    .backdrop{ position:fixed; inset:0; background:rgb(2 6 23 /.55); display:none; align-items:flex-start; justify-content:center; padding:24px; z-index:50 }
    .glass{ background:rgb(255 255 255 /.85); backdrop-filter:blur(10px) }
    .divider{height:1px;background:rgb(15 23 42/.08)}
    .brand-grad{background:linear-gradient(135deg,var(--brand),var(--brand-2))}
    .btn-option.selected{ background:var(--brand); color:#fff; border-color:transparent }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="brand-grad text-white">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-white/10 grid place-items-center font-black">M</div>
        <div>
          <h1 class="text-xl font-semibold tracking-tight">MADA · Portabilidad</h1>
          <p class="text-xs text-white/80">Perfilación, encuesta y ficha de captura</p>
        </div>
      </div>
      <div class="text-xs">
        <span class="px-2 py-1 pill bg-white/10">UI Corporativa</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Columna izquierda -->
      <section class="lg:col-span-2 space-y-6">
        <!-- Paso 1: compañía y plaza -->
        <div class="card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">1) Datos iniciales</h2>
            <span class="text-xs text-[var(--muted)]">Requerido</span>
          </div>
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Compañía actual</label>
              <select id="carrier" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none">
                <option value="">Selecciona...</option>
                <option>Telcel</option><option>Movistar</option><option>AT&T</option>
                <option>Unefon</option><option>Bait</option><option>OXXO Cel</option>
                <option>Virgin</option><option>Rincel</option>
              </select>
              <p id="telcelNote" class="hidden mt-2 text-sm text-[var(--brand)] bg-[var(--soft)] border rounded-xl px-3 py-2">Ya es Telcel. Deriva a upsell/recargas.</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Plaza</label>
              <select id="plaza" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none">
                <option value="">Selecciona plaza...</option>
                <option>MONTERREY</option><option>MANTE</option><option>REYNOSA</option><option>MATAMOROS</option>
                <option>SALTILLO</option><option>CHIHUAHUA</option><option>DELICIAS</option><option>CUAHUTEMOC</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Paso 2: ENCUESTA -->
        <div class="card rounded-2xl p-6" id="surveyBlock">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">2) Diagnóstico rápido</h2>
            <span class="text-xs text-[var(--muted)]" id="surveyHint">Selecciona la compañía para continuar</span>
          </div>

          <div id="questionsContainer" class="space-y-3"></div>

          <div class="grid md:grid-cols-2 gap-4 mt-3">
            <div class="p-4 rounded-xl bg-slate-50 border text-sm">
              <div class="flex items-center justify-between mb-2">
                <span class="font-semibold">Severidad</span>
                <span id="scoreBox" class="text-base font-bold">0.00</span>
              </div>
              <div id="pitchBox" class="opacity-80"></div>
            </div>
            <div id="planBox" class="p-4 rounded-xl bg-[var(--soft)] border text-sm hidden">
              <div class="flex items-center justify-between mb-2">
                <span class="font-semibold text-[var(--brand)]">Recomendación</span>
                <span class="inline-flex items-center gap-1 text-[var(--brand)] text-xs"><span class="size-2 rounded-full bg-[var(--accent)]"></span> Portabilidad Plus 12 meses</span>
              </div>
              <div id="planCard"></div>
            </div>
          </div>

          <div class="flex flex-wrap gap-2 items-center mt-4">
            <span class="font-semibold">Acciones:</span>
            <button id="btnAccept" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm hover:bg-emerald-700">Aceptó cambio</button>
            <button id="btnReject" class="px-3 py-2 rounded-xl bg-rose-600 text-white text-sm hover:bg-rose-700">No aceptó</button>
            <button id="btnGoCapture" class="ml-auto px-3 py-2 rounded-xl border text-sm hover:bg-slate-50">Ir a ficha</button>
          </div>
        </div>

        <!-- Paso 3: FICHA DE CAPTURA -->
        <div class="card rounded-2xl p-6" id="captureBlock">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">3) Ficha de captura</h2>
            <span class="text-xs text-[var(--muted)]">Solo datos necesarios de portabilidad</span>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1">Nombre completo (como en INE)</label>
              <input id="capNombreCompleto" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none" placeholder="Ej. CECILIA CAMPOS BARRERA"/>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Teléfono (10 dígitos)</label>
              <input id="capTelefono" inputmode="numeric" maxlength="10" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none"/>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Estatus del trámite (solo para control interno)</label>
              <select id="capEstatus" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none">
                <option>Portabilidad iniciada</option>
                <option>Capturado</option>
                <option>En revisión</option>
                <option>Confirmado</option>
                <option>Rechazado</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Fecha de nacimiento</label>
              <input id="capFechaNacimiento" type="date" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none"/>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Estado de nacimiento</label>
              <select id="capEstadoNacimiento" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none">
                <option value="">Selecciona estado…</option>
                <option>Aguascalientes</option><option>Baja California</option><option>Baja California Sur</option>
                <option>Campeche</option><option>Coahuila</option><option>Colima</option><option>Chiapas</option>
                <option>Chihuahua</option><option>Ciudad de México</option><option>Durango</option><option>Guanajuato</option>
                <option>Guerrero</option><option>Hidalgo</option><option>Jalisco</option><option>México</option>
                <option>Michoacán</option><option>Morelos</option><option>Nayarit</option><option>Nuevo León</option>
                <option>Oaxaca</option><option>Puebla</option><option>Querétaro</option><option>Quintana Roo</option>
                <option>San Luis Potosí</option><option>Sinaloa</option><option>Sonora</option><option>Tabasco</option>
                <option>Tamaulipas</option><option>Tlaxcala</option><option>Veracruz</option><option>Yucatán</option><option>Zacatecas</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1">CURP (opcional)</label>
              <input id="capCurp" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none" placeholder="Ej. CABC710619MGTMRL07"/>
            </div>

            <div class="md:col-span-2 flex gap-2 items-end">
              <div class="flex-1">
                <label class="block text-sm font-medium mb-1">ICC (SIM, 20 dígitos)</label>
                <input id="capICC" maxlength="20" inputmode="numeric" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none"/>
              </div>
              <button id="btnScanICC" type="button" class="h-[42px] px-3 rounded-xl border hover:bg-slate-50">Escanear</button>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">NIP (4 dígitos)</label>
              <input id="capNip" maxlength="4" inputmode="numeric" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none"/>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Nombre del promotor</label>
              <input id="capPromotor" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent outline-none"/>
            </div>
          </div>

          <div class="divider my-5"></div>

          <div class="flex justify-between items-center gap-3">
            <div class="text-xs text-[var(--muted)]">Se enviará a la hoja de la <b>plaza</b> seleccionada.</div>
            <div class="flex gap-2">
              <button id="btnCancelCapture" class="px-4 py-2 rounded-xl border text-sm hover:bg-slate-50">Cancelar</button>
              <button id="btnSaveCapture" class="px-4 py-2 rounded-xl text-sm text-white" style="background:var(--brand)">Crear ficha</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Columna derecha -->
      <aside class="space-y-6">
        <div class="rounded-2xl overflow-hidden card">
          <div class="px-4 py-2 text-white brand-grad text-sm font-semibold">Leads capturados (local)</div>
          <div id="leadsLog" class="bg-white p-4 space-y-3 max-h-[30rem] overflow-auto">
            <div class="text-sm text-[var(--muted)]">Aún no hay registros.</div>
          </div>
        </div>

        <div class="rounded-2xl overflow-hidden card">
          <div class="px-4 py-2 text-white brand-grad text-sm font-semibold">Pistas de conversación</div>
          <div class="p-4 text-sm leading-6">
            <p class="text-[var(--muted)]">Confirma con el cliente:</p>
            <ul class="list-disc list-inside mt-1 space-y-1">
              <li>Mismo número en ~24 h</li>
              <li>Activación con NIP e ICC</li>
              <li>Mejor cobertura y estabilidad</li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Modal Ticket (ficha para screenshot) -->
  <div id="okModal" class="backdrop">
    <div class="glass rounded-2xl w-[680px] max-w-full shadow-2xl">
      <div class="brand-grad text-white rounded-t-2xl px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 rounded-lg bg-white/10 grid place-items-center font-black">M</div>
          <div>
            <div class="text-sm uppercase tracking-widest opacity-80">Confirmación</div>
            <h3 class="text-lg font-semibold">Ficha creada con éxito</h3>
          </div>
        </div>
        <span class="text-xs px-2 py-1 pill bg-white/10">Portabilidad</span>
      </div>

      <div class="bg-white p-6">
        <div class="grid sm:grid-cols-2 gap-4 text-[15px]">
          <div>
            <div class="text-xs text-[var(--muted)]">Teléfono • NIP</div>
            <div id="okTelNip" class="font-mono text-lg"></div>
          </div>
          <div>
            <div class="text-xs text-[var(--muted)]">ICC</div>
            <div id="okICC" class="font-mono"></div>
          </div>
          <div>
            <div class="text-xs text-[var(--muted)]">Nombre</div>
            <div id="okNombre" class="font-semibold"></div>
          </div>
          <div>
            <div class="text-xs text-[var(--muted)]">Plaza • Carrier</div>
            <div id="okPlazaCarrier"></div>
          </div>
          <div class="sm:col-span-2">
            <div class="text-xs text-[var(--muted)]">Nacimiento</div>
            <div id="okNacimiento"></div>
          </div>
          <div class="sm:col-span-2">
            <div class="text-xs text-[var(--muted)]">Promotor</div>
            <div id="okPromotor"></div>
          </div>
        </div>

        <div class="mt-5 text-center">
          <button id="okClose" class="px-5 py-2 rounded-xl text-white" style="background:var(--brand)">Listo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scanner modal -->
  <div id="scanModal" class="backdrop">
    <div class="glass rounded-2xl shadow-xl w-full max-w-md p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Escanear código de barras (ICC)</h3>
        <button id="btnCloseScan" class="text-sm px-2 py-1 rounded-lg border bg-white/70">Cerrar</button>
      </div>
      <div id="scanSupport" class="text-sm text-slate-600 mb-2"></div>
      <video id="scanVideo" class="w-full rounded-xl bg-black aspect-video" playsinline></video>
      <div class="text-xs text-slate-600 mt-2">Apunta al código del SIM. Al detectar, se llenará el campo ICC.</div>
    </div>
  </div>

  <script>
    /* ========= Config ========= */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbznCd5Fs1amwdyHolpwze5yOzsw7OrTI_06DtZXkK0wqBEAdpJFijr_bgtiAjVTK6fwjA/exec';
    const el = id => document.getElementById(id);

    /* ========= Encuesta (por compañía) ========= */
    const carriers = {
      Telcel:{disabled:true, note:"Cliente Telcel actual", weaknesses:["Cliente actual - upsell/recargas"]},
      Movistar:{
        weaknesses:["Descuentos 2 meses, luego sube","Cobertura fuera de ciudad limitada","Lentitud en horas pico"],
        questions:[
          {id:"descuento", text:"¿Los descuentos solo te duran 2 meses?", options:["Sí","A veces","No"], weight:1.5},
          {id:"cobertura", text:"¿Pierdes señal al viajar o en zonas rurales?", options:["Sí, seguido","A veces","No"], weight:2},
          {id:"velocidad", text:"¿Se pone lento en horas pico?", options:["Sí, siempre","A veces","No"], weight:1.5}
        ],
        pitch:s=> s>=4?"Con Movistar terminas pagando más y con menos cobertura. Telcel te da precio estable, 5G y cobertura real.":"Si te falla la señal o sube el precio, Telcel mantiene estabilidad y mejor red."
      },
      "AT&T":{
        weaknesses:["Acumulación confusa","Cobertura irregular","Precio alto"],
        questions:[
          {id:"acumulacion", text:"¿Te confunden condiciones para acumular megas?", options:["Sí","Algo","No"], weight:1.5},
          {id:"viajes", text:"¿Se te cae la señal al viajar?", options:["Sí, seguido","A veces","No"], weight:2},
          {id:"costo", text:"¿Pagas más de $200 al mes?", options:["Sí","No sé","No"], weight:1.5}
        ],
        pitch:s=> s>=3.5?"AT&T complica y la cobertura se cae. Telcel es claro y con red más amplia.":"Si batallas en carretera o interiores, Telcel te cubre mejor."
      }
    };

    /* ========= Elementos ========= */
    const carrier = el('carrier'); const plaza = el('plaza'); const telcelNote = el('telcelNote');

    // Encuesta
    const questionsContainer = el('questionsContainer');
    const scoreBox = el('scoreBox'); const pitchBox = el('pitchBox');
    const planBox = el('planBox'); const planCard = el('planCard');
    const btnAccept = el('btnAccept'); const btnReject = el('btnReject'); const btnGoCapture = el('btnGoCapture');
    const surveyHint = el('surveyHint');

    // Captura
    const captureBlock = el('captureBlock');
    const capNombreCompleto = el('capNombreCompleto');
    const capTelefono = el('capTelefono');
    const capFechaNacimiento = el('capFechaNacimiento');
    const capEstadoNacimiento = el('capEstadoNacimiento');
    const capCurp = el('capCurp'); const capICC = el('capICC'); const capNip = el('capNip');
    const capPromotor = el('capPromotor'); const capEstatus = el('capEstatus');
    const btnSaveCapture = el('btnSaveCapture'); const btnCancelCapture = el('btnCancelCapture');

    // Leads UI
    const leadsLog = el('leadsLog');

    // Modal ficha
    const okModal = el('okModal'); const okClose = el('okClose');
    const okTelNip = el('okTelNip'); const okICC = el('okICC'); const okNombre = el('okNombre');
    const okPlazaCarrier = el('okPlazaCarrier'); const okNacimiento = el('okNacimiento'); const okPromotor = el('okPromotor');

    // Scanner
    const scanModal = el('scanModal'); const scanVideo = el('scanVideo');
    const btnScanICC = el('btnScanICC'); const btnCloseScan = el('btnCloseScan'); const scanSupport = el('scanSupport');
    let scanStream=null, scanning=false, detector=null;

    // Estado
    let answers = {}; let currentCarrier=null; let currentScore=0; let leads=[];

    document.addEventListener('DOMContentLoaded', () => {
      carrier.addEventListener('change', handleCarrierChange);
      capTelefono.addEventListener('input', ()=> capTelefono.value = capTelefono.value.replace(/\D/g,'').slice(0,10));
      capICC.addEventListener('input',      ()=> capICC.value      = capICC.value.replace(/\D/g,'').slice(0,20));
      capNip.addEventListener('input',      ()=> capNip.value      = capNip.value.replace(/\D/g,'').slice(0,4));

      btnAccept.addEventListener('click', () => { captureBlock.scrollIntoView({behavior:'smooth', block:'start'}); capNombreCompleto.focus(); });
      btnReject.addEventListener('click', () => alert('¡Gracias! Si cambias de opinión, aquí seguimos.'));
      btnGoCapture.addEventListener('click', () => { captureBlock.scrollIntoView({behavior:'smooth', block:'start'}); });

      btnSaveCapture.addEventListener('click', saveCapture);
      btnCancelCapture.addEventListener('click', resetForm);

      okClose.addEventListener('click', ()=>{ okModal.style.display='none'; resetForm(); });

      // Scanner
      btnScanICC.addEventListener('click', openScanModal);
      btnCloseScan.addEventListener('click', closeScanModal);
      scanSupport.textContent = ('BarcodeDetector' in window)
        ? 'Soportado: intentaremos Code128/EAN.'
        : 'Sin soporte nativo. Si no detecta, ingresa el ICC manualmente.';

      loadSavedLeads();
      // Oculta ficha al inicio; encuesta muestra mensaje hasta que elijan compañía
      if(!carrier.value){ questionsContainer.innerHTML=''; surveyHint.textContent='Selecciona la compañía para continuar'; }
    });

    /* ====== Encuesta ====== */
    function handleCarrierChange(){
      currentCarrier = carrier.value; answers = {}; currentScore=0;
      telcelNote.classList.toggle('hidden', carrier.value!=='Telcel');
      renderQuestions();
      updateScore();
    }
    function renderQuestions(){
      questionsContainer.innerHTML='';
      const qs = carriers[currentCarrier]?.questions || [];
      if(qs.length===0){ surveyHint.textContent = currentCarrier? 'Sin preguntas para esta compañía.': 'Selecciona la compañía para continuar'; return; }
      surveyHint.textContent = 'Responde 3–4 clics';
      qs.forEach(q=>{
        const div = document.createElement('div');
        div.className='p-3 rounded-xl border';
        div.innerHTML = `
          <div class="font-medium mb-2">${q.text}</div>
          <div class="flex flex-wrap gap-2">
            ${q.options.map((opt)=>`<button class="btn-option px-3 py-1.5 rounded-lg border text-sm" data-id="${q.id}" data-value="${opt}">${opt}</button>`).join('')}
          </div>`;
        const buttons = div.querySelectorAll('.btn-option');
        buttons.forEach(btn=> btn.addEventListener('click', ()=>{
          buttons.forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected'); answers[q.id]=btn.dataset.value; updateScore();
        }));
        questionsContainer.appendChild(div);
      });
    }
    function updateScore(){
      currentScore=0;
      const qs = carriers[currentCarrier]?.questions || [];
      qs.forEach(q=>{ if(answers[q.id]){ const idx=q.options.indexOf(answers[q.id]); currentScore += (q.options.length-1-idx)*q.weight; }});      
      scoreBox.textContent = currentScore.toFixed(2);
      pitchBox.textContent = carriers[currentCarrier]?.pitch ? carriers[currentCarrier].pitch(currentScore) : '';
      const plan = currentScore>=3 ? 'ASL150':'ASL100';
      if(currentCarrier){ planBox.classList.remove('hidden'); planCard.innerHTML = renderPlanCard(plan); } else { planBox.classList.add('hidden'); planCard.innerHTML=''; }
    }
    function renderPlanCard(code){
      const is150 = code==='ASL150';
      const title = is150? 'Amigo Sin Límite 150' : 'Amigo Sin Límite 100';
      const price = is150? '$150 / 30 días' : '$100 / 30 días';
      const pts = ['Minutos y SMS ilimitados','Redes incluidas','Mismo número (~24h)','Beneficios 12 meses al portar'];
      return `<div class="rounded-xl border bg-white p-3">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-slate-500">Plan sugerido</div>
            <div class="text-base font-semibold text-[var(--brand)]">${title}</div>
          </div>
          <div class="text-sm font-bold text-[var(--brand)]">${price}</div>
        </div>
        <ul class="mt-2 text-xs space-y-1">${pts.map(p=>`<li class="flex items-start gap-2"><span class="mt-1 size-1.5 rounded-full bg-[var(--accent)]"></span><span>${p}</span></li>`).join('')}</ul>
      </div>`;
    }

    /* ====== Leads laterales (local) ====== */
    function renderLeads(){
      leadsLog.innerHTML='';
      if(leads.length===0){ leadsLog.innerHTML='<div class="text-sm text-slate-500">Aún no hay registros.</div>'; return; }
      [...leads].reverse().slice(0,12).forEach(l=>{
        const div=document.createElement('div'); div.className='p-3 rounded-xl border text-sm bg-white';
        div.innerHTML=`<div class="flex justify-between">
            <div class="font-medium">${l.nombre||'—'}</div>
            <div class="text-xs text-slate-500">${l.timestamp}</div></div>
            <div class="mt-1">${l.telefono||'—'} • ${l.carrier||'—'} • ${l.plaza||'—'}</div>
            <div class="flex justify-between items-center mt-2">
              <span class="px-2 py-1 pill text-xs ${
                l.estatus==='Rechazado' ? 'bg-rose-100 text-rose-700' :
                l.estatus==='Confirmado' ? 'bg-emerald-100 text-emerald-700' :
                'bg-blue-100 text-blue-800'
              }">${l.estatus||'Estatus'}</span>
              <span class="text-xs">ICC: ${l.icc?String(l.icc).slice(-6):'—'}</span>
            </div>`;
        leadsLog.appendChild(div);
      });
    }
    function saveLocalLead(l){ leads.push(l); localStorage.setItem('leads', JSON.stringify(leads)); renderLeads(); }
    function loadSavedLeads(){ const s=localStorage.getItem('leads'); if(s){ leads=JSON.parse(s); renderLeads(); } }

    /* ====== Guardar ficha ====== */
    async function saveCapture(){
      // Validaciones mínimas
      if(!carrier.value){ alert('Selecciona la compañía'); carrier.focus(); return; }
      if(!plaza.value){ alert('Selecciona la plaza'); plaza.focus(); return; }
      if(!capNombreCompleto.value.trim()){ alert('Ingresa el nombre completo'); capNombreCompleto.focus(); return; }
      if(!/^\d{10}$/.test(capTelefono.value)){ alert('Teléfono de 10 dígitos'); capTelefono.focus(); return; }
      if(!/^\d{20}$/.test(capICC.value)){ alert('ICC debe tener 20 dígitos'); capICC.focus(); return; }
      if(!/^\d{4}$/.test(capNip.value)){ alert('NIP de 4 dígitos'); capNip.focus(); return; }
      if(!capFechaNacimiento.value){ alert('Selecciona la fecha de nacimiento'); capFechaNacimiento.focus(); return; }
      if(!capEstadoNacimiento.value){ alert('Selecciona el estado de nacimiento'); capEstadoNacimiento.focus(); return; }

      const record = {
        type:'capture',
        timestamp:new Date().toLocaleString(),
        plaza:plaza.value,
        carrier:carrier.value,
        nombreCompleto:capNombreCompleto.value.trim(),
        telefono:capTelefono.value.trim(),
        fechaNacimiento:capFechaNacimiento.value,
        estadoNacimiento:capEstadoNacimiento.value,
        curp:capCurp.value.trim(),
        icc:capICC.value.trim(),
        nip:capNip.value.trim(),
        promotor:capPromotor.value.trim(),
        estatus:capEstatus.value // -> solo para Sheets y panel lateral, NO en la ficha
      };

      // Local
      saveLocalLead({
        id:Date.now(), timestamp:record.timestamp, nombre:record.nombreCompleto, telefono:record.telefono,
        carrier:record.carrier, plaza:record.plaza, icc:record.icc, estatus:record.estatus
      });

      // A Sheets
      pushToSheets(record);

      // Ficha (sin estatus)
      okTelNip.textContent = `${record.telefono}  ·  ${record.nip}`;
      okICC.textContent = record.icc;
      okNombre.textContent = record.nombreCompleto;
      okPlazaCarrier.textContent = `${record.plaza}  ·  ${record.carrier}`;
      okNacimiento.textContent = `${record.fechaNacimiento}  ·  ${record.estadoNacimiento}`;
      okPromotor.textContent = record.promotor || '—';
      okModal.style.display='flex';
    }

    async function pushToSheets(payload){
      try{
        await fetch(SHEETS_WEBAPP_URL, {
          method:'POST',
          mode:'no-cors',
          headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
          body:'payload='+encodeURIComponent(JSON.stringify(payload))
        });
      }catch(e){ console.error('Falló envío a Sheets', e); }
    }

    function resetForm(){
      carrier.value=''; plaza.value='';
      questionsContainer.innerHTML=''; answers={}; currentScore=0; scoreBox.textContent='0.00'; pitchBox.textContent=''; planCard.innerHTML=''; planBox.classList.add('hidden'); surveyHint.textContent='Selecciona la compañía para continuar';
      capNombreCompleto.value=''; capTelefono.value=''; capFechaNacimiento.value='';
      capEstadoNacimiento.value=''; capCurp.value=''; capICC.value=''; capNip.value='';
      capPromotor.value=''; capEstatus.value='Portabilidad iniciada';
      telcelNote.classList.add('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    /* ====== Scanner ICC ====== */
    async function openScanModal(){
      scanModal.style.display='flex';
      try{
        if('BarcodeDetector' in window){
          detector = new BarcodeDetector({formats:['code_128','ean_13','ean_8','upc_a','upc_e','code_39']});
        } else { detector=null; }
        scanStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        scanVideo.srcObject = scanStream; await scanVideo.play(); scanning=true; requestAnimationFrame(scanLoop);
      }catch(e){ alert('No se pudo acceder a la cámara. Otorga permisos o ingresa el ICC manualmente.'); closeScanModal(); }
    }
    async function scanLoop(){
      if(!scanning) return;
      try{
        if(detector && scanVideo.readyState === HTMLMediaElement.HAVE_ENOUGH_DATA){
          const codes = await detector.detect(scanVideo);
          if(codes && codes.length){
            const value = (codes[0].rawValue || '').replace(/\D/g,'');
            if(value){ capICC.value = value.slice(0,20); closeScanModal(); return; }
          }
        }
      }catch(_){}
      requestAnimationFrame(scanLoop);
    }
    function closeScanModal(){
      scanning=false; if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
      scanVideo.pause(); scanVideo.srcObject=null; scanModal.style.display='none';
    }
  </script>
</body>
</html>
