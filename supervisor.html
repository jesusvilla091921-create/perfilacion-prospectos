<!DOCTYPE html>
<html lang="es" class="h-full bg-white">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MADA · Supervisor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#dc2626">
  <style>
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    .glass{backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px)}
    .btn-disabled{opacity:.6;pointer-events:none}
  </style>
</head>
<body class="h-full text-red-900 bg-white">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-red-800 to-red-600 text-white">
      <div class="max-w-7xl mx-auto px-4 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-white flex items-center justify-center font-bold text-red-700 border border-red-200" aria-label="Logo MADA">M</div>
          <div>
            <h1 class="text-xl font-semibold tracking-wide">MADA · Supervisor</h1>
            <p class="text-white/80 text-sm">Asignaciones · Métricas · Nómina</p>
          </div>
        </div>
        <div class="flex items-center gap-2 text-xs text-white/80">
          <a href="./index.html" class="underline hover:text-white">Promotor</a>
          <span>·</span>
          <span id="netStatus">•</span>
        </div>
      </div>
    </header>

    <main class="flex-1">
      <div class="max-w-7xl mx-auto px-4 py-6 lg:py-10 grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Col 1-3: contenido principal -->
        <section class="lg:col-span-3 space-y-6">
          <!-- KPIs -->
          <div class="rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold">Indicadores</h3>
                <p class="text-white/80 text-sm">Hoy / Semana / Mes</p>
              </div>
              <div class="flex items-center gap-2">
                <input id="kpiDate" type="date" class="rounded-lg text-red-900 px-2 py-1 border border-red-200 bg-white"/>
                <button id="btnRefreshKPI" class="rounded-lg bg-white/10 px-3 py-1.5 text-sm hover:bg-white/20">Actualizar</button>
              </div>
            </div>
            <div class="p-5 grid grid-cols-2 md:grid-cols-4 gap-4" id="kpiCards">
              <!-- Cards render -->
            </div>
          </div>

          <!-- Asignar ICCs -->
          <div class="rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold">Asignar ICCs</h3>
                <p class="text-white/80 text-sm">Escanea o pega una lista. Se validan con Luhn.</p>
              </div>
              <div class="text-xs">Asignación incremental</div>
            </div>
            <div class="p-5 space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <div>
                  <label class="text-sm font-medium">Promotor</label>
                  <input id="asgPromotor" class="mt-1 w-full rounded-xl border border-red-200 px-3 py-2" placeholder="Nombre del promotor"/>
                </div>
                <div>
                  <label class="text-sm font-medium">Plaza</label>
                  <select id="asgPlaza" class="mt-1 w-full rounded-xl border border-red-200 px-3 py-2">
                    <option value="">Selecciona</option>
                    <option>MONTERREY</option><option>MANTE</option><option>REYNOSA</option><option>MATAMOROS</option><option>SALTILLO</option><option>CHIHUAHUA</option><option>DELICIAS</option><option>CUAHUTEMOC</option><option>TAMPICO</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm font-medium">Tipo</label>
                  <select id="asgTipo" class="mt-1 w-full rounded-xl border border-red-200 px-3 py-2">
                    <option value="portabilidad">Portabilidad</option>
                    <option value="chip_azul">Chip azul</option>
                    <option value="chip_blanco">Chip blanco</option>
                  </select>
                </div>
                <div class="flex items-end gap-2">
                  <button id="btnScanAdd" class="w-full rounded-xl bg-white border border-red-200 py-2.5 px-4 text-sm hover:bg-red-50">Escanear ICC</button>
                </div>
              </div>

              <div>
                <label class="text-sm font-medium">ICC(s)</label>
                <textarea id="asgICCList" class="mt-1 w-full rounded-xl border border-red-200 px-3 py-2 mono" rows="4" placeholder="Pega uno por línea, con o sin espacios"></textarea>
                <div class="text-xs text-red-700 mt-1">Acepta 19–20 dígitos. Se ignorarán líneas inválidas.</div>
              </div>

              <div id="asgPreview" class="hidden rounded-xl border border-red-200 p-3 bg-red-50/40 text-sm"></div>

              <div class="flex items-center gap-2">
                <button id="btnAsignar" class="rounded-xl bg-red-700 text-white py-2.5 px-4 hover:bg-red-800">Asignar ICCs</button>
                <button id="btnLimpiarAsg" class="rounded-xl bg-white border border-red-200 py-2.5 px-4 hover:bg-red-50">Limpiar</button>
              </div>
            </div>
          </div>

          <!-- Localizar ICC -->
          <div class="rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold">Localizar ICC</h3>
                <p class="text-white/80 text-sm">Estatus, asignación, número y recarga.</p>
              </div>
              <button id="btnScanFind" class="rounded-lg bg-white/10 px-3 py-1.5 text-sm hover:bg-white/20">Escanear</button>
            </div>
            <div class="p-5 space-y-3">
              <div class="flex gap-2">
                <input id="lookupICC" class="flex-1 rounded-xl border border-red-200 px-3 py-2 mono" placeholder="Ingresa ICC"/>
                <button id="btnLookup" class="rounded-xl bg-red-700 text-white py-2.5 px-4 hover:bg-red-800">Buscar</button>
              </div>
              <div id="lookupHint" class="text-xs text-red-700 hidden">ICC inválido (Luhn). Puedes buscarlo de todos modos.</div>
              <div id="lookupResult" class="rounded-xl border border-red-200 p-4 hidden"></div>
            </div>
          </div>

          <!-- Nómina (por promociones) -->
          <div class="rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold">Cálculo de nómina</h3>
                <p class="text-white/80 text-sm">Regla: 1–5 = $10 c/u · 6–10 = $15 c/u · ≥12 = $20 c/u (todas).</p>
              </div>
              <div class="flex items-center gap-2">
                <input id="nominaDesde" type="date" class="rounded-lg text-red-900 px-2 py-1 border border-red-200 bg-white"/>
                <input id="nominaHasta" type="date" class="rounded-lg text-red-900 px-2 py-1 border border-red-200 bg-white"/>
                <button id="btnNominaFetch" class="rounded-lg bg-white/10 px-3 py-1.5 text-sm hover:bg-white/20">Obtener</button>
              </div>
            </div>
            <div class="p-5 space-y-4">
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm" id="tblNomina">
                  <thead>
                    <tr class="text-left text-red-700 border-b border-red-100">
                      <th class="py-2 pr-4">Promotor</th>
                      <th class="py-2 pr-4">Plaza</th>
                      <th class="py-2 pr-4">Promociones</th>
                      <th class="py-2 pr-4">Tarifa</th>
                      <th class="py-2 pr-4">Total</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyNomina"></tbody>
                  <tfoot>
                    <tr class="border-t border-red-100 font-medium">
                      <td class="py-2" colspan="4">Total general</td>
                      <td class="py-2" id="nominaGranTotal">$0</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              <div class="flex items-center gap-2">
                <button id="btnNominaExport" class="rounded-xl bg-white border border-red-200 py-2.5 px-4 hover:bg-red-50">Exportar CSV</button>
              </div>
            </div>
          </div>

          <!-- Activaciones recientes -->
          <div class="rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold">Activaciones recientes</h3>
                <p class="text-white/80 text-sm">Últimas 50 (promotor, número, monto).</p>
              </div>
              <button id="btnReloadActivaciones" class="rounded-lg bg-white/10 px-3 py-1.5 text-sm hover:bg-white/20">Actualizar</button>
            </div>
            <div class="p-5">
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                  <thead>
                    <tr class="text-left text-red-700 border-b border-red-100">
                      <th class="py-2 pr-4">Fecha</th>
                      <th class="py-2 pr-4">Promotor</th>
                      <th class="py-2 pr-4">Plaza</th>
                      <th class="py-2 pr-4">Tipo</th>
                      <th class="py-2 pr-4">Número</th>
                      <th class="py-2 pr-4">ICC (••••••)</th>
                      <th class="py-2 pr-4">Recarga</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyActivaciones"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Col 4: utilidades -->
        <aside class="lg:col-span-1 space-y-6">
          <div class="rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white">
              <h3 class="text-lg font-semibold">Utilidades</h3>
              <p class="text-white/80 text-sm">Exportar, respaldos rápidos</p>
            </div>
            <div class="p-5 flex flex-col gap-2">
              <button id="btnExportActivaciones" class="rounded-xl bg-white border border-red-200 py-2.5 px-4 text-sm hover:bg-red-50">Exportar activaciones CSV</button>
              <button id="btnExportAsignaciones" class="rounded-xl bg-white border border-red-200 py-2.5 px-4 text-sm hover:bg-red-50">Exportar asignaciones CSV</button>
            </div>
          </div>

          <div class="rounded-2xl bg-white shadow-sm border border-red-100">
            <div class="p-5 rounded-t-2xl bg-gradient-to-r from-red-800 to-red-600 text-white">
              <h3 class="text-lg font-semibold">Notas</h3>
              <p class="text-white/80 text-sm">Cosas por hacer</p>
            </div>
            <div class="p-5">
              <textarea id="notaSupervisor" class="w-full rounded-xl border border-red-200 px-3 py-2" rows="8" placeholder="Escribe aquí. Se guarda local."></textarea>
              <div class="text-xs text-red-700 mt-1">Auto-guardado local</div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Modal Scanner -->
  <div id="scanOverlay" class="hidden fixed inset-0 bg-red-900/50 glass flex items-center justify-center p-4 z-50">
    <div class="w-full max-w-md rounded-2xl overflow-hidden shadow-xl bg-white">
      <div class="p-4 bg-gradient-to-r from-red-800 to-red-600 text-white flex items-center justify-between">
        <h3 class="font-semibold">Escanear ICC</h3>
        <button id="btnCloseScan" class="text-sm underline">Cerrar</button>
      </div>
      <div class="p-4 space-y-3">
        <div id="scanSupport" class="text-sm text-red-700"></div>
        <video id="scanVideo" class="w-full rounded-xl bg-black aspect-[3/4]" autoplay muted playsinline></video>
        <div class="text-sm text-red-700/80">Apunta al código de barras (Code128/EAN). Si no aparece, escribe el ICC manualmente.</div>
      </div>
      <div class="p-4 bg-red-50 flex justify-end">
        <button id="btnStopScan" class="rounded-xl bg-white border border-red-200 py-2 px-4 text-sm hover:bg-red-100">Detener</button>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // ⚙️ CONFIGURACIÓN EDITABLE
    // ==============================
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyBqdxN9On-PqkuJ86eQDu22EMCfg2qgwtr8LgYh53yyvz1xMPTCj1zT84q02Yn4eM/exec';
    const VALID_PLAZAS = ['MONTERREY','MANTE','REYNOSA','MATAMOROS','SALTILLO','CHIHUAHUA','DELICIAS','CUAHUTEMOC','TAMPICO'];

    // ==============================
    // 🔧 Utilidades
    // ==============================
    const $ = (id)=> document.getElementById(id);
    const onlyDigits = (s)=> (s||'').replace(/\D+/g,'');
    const last6 = (s)=> String(s||'').slice(-6).padStart(6,'•');
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

    // Luhn (ICCID 19–20 dígitos)
    function luhnCheck(num){
      const s = onlyDigits(num);
      if (s.length < 19) return false;
      let sum=0, dbl=false;
      for (let i=s.length-1; i>=0; i--){
        let d = parseInt(s[i],10);
        if (dbl){ d*=2; if(d>9) d-=9; }
        sum += d; dbl = !dbl;
      }
      return sum % 10 === 0;
    }

    // Net status
    const netStatus=$('netStatus');
    function updateNet(){ netStatus.textContent = navigator.onLine? 'En línea' : 'Sin conexión'; netStatus.className = 'text-xs ' + (navigator.onLine? 'text-green-100' : 'text-yellow-200'); }
    window.addEventListener('online', updateNet); window.addEventListener('offline', updateNet); updateNet();

    // Fetch util a GAS (con reintentos)
    async function sendToSheets(record, {retries=2, timeoutMs=8000}={}){
      const body='payload='+encodeURIComponent(JSON.stringify(record));
      for (let attempt=0; attempt<=retries; attempt++){
        const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
        try{
          const res = await fetch(SHEETS_WEBAPP_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body, signal: ctrl.signal });
          clearTimeout(t);
          if (!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json().catch(()=>({}));
          return data;
        } catch(err){
          clearTimeout(t);
          if (attempt===retries) throw err;
          await sleep(600*(attempt+1));
        }
      }
    }

    // ==============================
    // 📈 KPIs
    // ==============================
    const kpiCards = $('kpiCards');
    $('btnRefreshKPI').addEventListener('click', loadKPIs);
    function renderKPIItem(title, value, sub){
      const card = document.createElement('div');
      card.className = 'rounded-xl border border-red-200 p-4';
      const t=document.createElement('div'); t.className='text-sm text-red-700'; t.textContent=title;
      const v=document.createElement('div'); v.className='text-3xl font-semibold mt-1'; v.textContent=value;
      const s=document.createElement('div'); s.className='text-xs text-red-700 mt-1'; s.textContent=sub||'';
      card.appendChild(t); card.appendChild(v); card.appendChild(s); return card;
    }
    async function loadKPIs(){
      kpiCards.innerHTML='';
      const date = $('kpiDate').value || new Date().toISOString().slice(0,10);
      try{
        const data = await sendToSheets({type:'metrics', date});
        // Se esperan llaves: today_promos, week_promos, month_promos, conv_rate, avg_topup
        const m = data || {};
        kpiCards.appendChild(renderKPIItem('Promos hoy', String(m.today_promos ?? 0)));
        kpiCards.appendChild(renderKPIItem('Promos semana', String(m.week_promos ?? 0)));
        kpiCards.appendChild(renderKPIItem('Promos mes', String(m.month_promos ?? 0)));
        kpiCards.appendChild(renderKPIItem('Tasa conversión', (m.conv_rate!=null? (m.conv_rate*100).toFixed(1)+'%':'—')));
      } catch(e){
        kpiCards.appendChild(renderKPIItem('Promos hoy','—','Sin conexión/Backend'));
        kpiCards.appendChild(renderKPIItem('Promos semana','—'));
        kpiCards.appendChild(renderKPIItem('Promos mes','—'));
        kpiCards.appendChild(renderKPIItem('Tasa conversión','—'));
      }
    }

    // ==============================
    // 📦 Asignar ICCs
    // ==============================
    const asgPromotor=$('asgPromotor');
    const asgPlaza=$('asgPlaza');
    const asgTipo=$('asgTipo');
    const asgICCList=$('asgICCList');
    const asgPreview=$('asgPreview');
    $('btnLimpiarAsg').addEventListener('click', ()=>{ asgICCList.value=''; asgPreview.classList.add('hidden'); asgPreview.textContent=''; });

    function parseICCList(raw){
      const lines = String(raw||'').split(/\n|,|;|\s+/).map(x=>onlyDigits(x)).filter(Boolean);
      const uniq = Array.from(new Set(lines));
      const valids = []; const invalids = [];
      uniq.forEach(v=> (luhnCheck(v) ? valids : invalids).push(v) );
      return {valids, invalids};
    }
    asgICCList.addEventListener('input', ()=>{
      const {valids, invalids} = parseICCList(asgICCList.value);
      if (!valids.length && !invalids.length){ asgPreview.classList.add('hidden'); return; }
      asgPreview.classList.remove('hidden');
      asgPreview.innerHTML = `<div><b>${valids.length}</b> válidos · <b>${invalids.length}</b> descartados</div>`;
    });

    $('btnAsignar').addEventListener('click', async ()=>{
      const promotor = asgPromotor.value.trim();
      const plaza = asgPlaza.value;
      if (!promotor) return alert('Escribe el promotor');
      if (!VALID_PLAZAS.includes(plaza)) return alert('Selecciona una plaza válida');
      const {valids} = parseICCList(asgICCList.value);
      if (!valids.length) return alert('Agrega al menos un ICC válido');
      try{
        await sendToSheets({ type:'assign_iccs', timestamp:new Date().toISOString(), promotor, plaza, asg_tipo: asgTipo.value, iccs: valids });
        alert('Asignación enviada');
        asgICCList.value=''; asgPreview.classList.add('hidden'); asgPreview.textContent='';
      } catch(e){ alert('No se pudo enviar la asignación'); }
    });

    // Scanner (reusa para agregar o buscar)
    let mediaStream=null; let barcodeDetector=null; let scanLoopActive=false; const scanOverlay=$('scanOverlay'); const scanVideo=$('scanVideo'); const scanSupport=$('scanSupport');
    function showScanModal(){ scanOverlay.classList.remove('hidden'); }
    function closeScanModal(){ scanOverlay.classList.add('hidden'); stopCamera(); scanLoopActive=false; }
    async function startCamera(){
      try{ mediaStream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } }); scanVideo.srcObject=mediaStream; await scanVideo.play(); }
      catch{ scanSupport.textContent='No se pudo acceder a la cámara.'; }
    }
    function stopCamera(){ if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; } scanVideo.pause(); scanVideo.srcObject=null; }
    async function startScanLoop(onDetect){
      scanLoopActive=true; while (scanLoopActive && barcodeDetector && scanVideo.readyState>=2){
        try{
          const barcodes=await barcodeDetector.detect(scanVideo);
          if (barcodes && barcodes.length){ const raw=barcodes[0].rawValue||''; const digits=onlyDigits(raw); if (digits.length>=19){ onDetect(digits.slice(0,19)); closeScanModal(); break; } }
        } catch{}
        await sleep(200);
      }
    }
    $('btnScanAdd').addEventListener('click', async ()=>{
      showScanModal();
      if ('BarcodeDetector' in window){ try{ barcodeDetector=new BarcodeDetector({ formats:['code_128','ean_13','ean_8','upc_a','upc_e','code_39'] }); scanSupport.textContent='Escaneando...'; } catch{ barcodeDetector=null; scanSupport.textContent='Error con BarcodeDetector'; } }
      else { scanSupport.textContent='Sin soporte nativo'; }
      await startCamera();
      if (barcodeDetector) startScanLoop((icc)=>{ asgICCList.value = (asgICCList.value+'\n'+icc).trim(); asgICCList.dispatchEvent(new Event('input')); });
    });
    $('btnScanFind').addEventListener('click', async ()=>{
      showScanModal();
      if ('BarcodeDetector' in window){ try{ barcodeDetector=new BarcodeDetector({ formats:['code_128','ean_13','ean_8','upc_a','upc_e','code_39'] }); scanSupport.textContent='Escaneando...'; } catch{ barcodeDetector=null; scanSupport.textContent='Error con BarcodeDetector'; } }
      else { scanSupport.textContent='Sin soporte nativo'; }
      await startCamera();
      if (barcodeDetector) startScanLoop((icc)=>{ $('lookupICC').value=icc; closeScanModal(); });
    });
    $('btnCloseScan').addEventListener('click', closeScanModal);
    $('btnStopScan').addEventListener('click', closeScanModal);

    // ==============================
    // 🔎 Localizar ICC
    // ==============================
    const lookupICC=$('lookupICC'); const lookupResult=$('lookupResult'); const lookupHint=$('lookupHint');
    $('btnLookup').addEventListener('click', doLookup);
    lookupICC.addEventListener('input', ()=>{ const ok=luhnCheck(lookupICC.value); lookupHint.classList.toggle('hidden', ok); });

    async function doLookup(){
      const icc = onlyDigits(lookupICC.value).slice(0,20);
      if (!icc) return alert('Ingresa un ICC');
      // Se puede buscar aunque falle Luhn
      try{
        const r = await sendToSheets({ type:'lookup_icc', icc });
        // Esperamos estructura: {found: bool, status: 'virgen'|'asignado'|'usado', promotor, plaza, numero, recarga, fecha_asignacion, fecha_uso}
        renderLookup(r || {});
      } catch(e){ renderLookup({ error:true }); }
    }
    function renderLookup(obj){
      lookupResult.classList.remove('hidden');
      if (obj.error){ lookupResult.innerHTML = '<div class="text-sm text-red-700">Sin conexión o error de backend</div>'; return; }
      if (!obj.found){ lookupResult.innerHTML = '<div class="text-sm">No encontrado. Probablemente <b>virgen</b>.</div>'; return; }
      const statusBadge = (s)=>{
        const map={ virgen:'bg-gray-100 text-gray-800', asignado:'bg-amber-100 text-amber-800', usado:'bg-green-100 text-green-800' };
        return `<span class="text-xs px-2 py-0.5 rounded-full ${map[s]||'bg-red-100 text-red-800'}">${s||'—'}</span>`;
      };
      lookupResult.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          <div><span class="text-red-700">Estatus</span> · ${statusBadge(obj.status)}</div>
          <div><span class="text-red-700">Promotor</span> · ${obj.promotor||'—'}</div>
          <div><span class="text-red-700">Plaza</span> · ${obj.plaza||'—'}</div>
          <div><span class="text-red-700">Número</span> · ${obj.numero||'—'}</div>
          <div><span class="text-red-700">ICC</span> · <span class="mono">${obj.icc||'—'}</span></div>
          <div><span class="text-red-700">Recarga</span> · ${obj.recarga!=null? ('$'+obj.recarga):'—'}</div>
          <div><span class="text-red-700">Asignación</span> · ${obj.fecha_asignacion||'—'}</div>
          <div><span class="text-red-700">Uso</span> · ${obj.fecha_uso||'—'}</div>
        </div>`;
    }

    // ==============================
    // 💵 Nómina
    // ==============================
    const tbodyNomina=$('tbodyNomina'); const nominaGranTotal=$('nominaGranTotal');
    $('btnNominaFetch').addEventListener('click', loadNomina);

    function tarifaPorCantidad(n){ if(n>=12) return 20; if(n<=5) return 10; if(n<=10) return 15; return 15; /* n==11 */ }

    function renderNominaRows(rows){
      tbodyNomina.innerHTML='';
      let sum=0;
      (rows||[]).forEach(r=>{
        const tarifa = tarifaPorCantidad(r.promos||0);
        const total = (r.promos||0)*tarifa;
        sum+=total;
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-4">${r.promotor||'—'}</td>
          <td class="py-2 pr-4">${r.plaza||'—'}</td>
          <td class="py-2 pr-4">${r.promos||0}</td>
          <td class="py-2 pr-4">$${tarifa}</td>
          <td class="py-2 pr-4">$${total}</td>`;
        tbodyNomina.appendChild(tr);
      });
      nominaGranTotal.textContent = '$'+sum;
    }

    async function loadNomina(){
      const desde=$('nominaDesde').value; const hasta=$('nominaHasta').value;
      try{
        const data = await sendToSheets({ type:'nomina_promos', desde, hasta });
        // Esperado: [{promotor, plaza, promos}]
        renderNominaRows(data && Array.isArray(data.rows)? data.rows : []);
      } catch{ renderNominaRows([]); }
    }

    // Export helpers
    function toCSV(rows, header){
      const head = header.join(',');
      const lines = (rows||[]).map(o=> header.map(k=>`"${String(o[k]??'').replace(/"/g,'""')}"`).join(','));
      return [head].concat(lines).join('\n');
    }

    $('btnNominaExport').addEventListener('click', ()=>{
      // Construir desde la tabla actual
      const rows=[]; [...tbodyNomina.children].forEach(tr=>{
        const tds=[...tr.children].map(td=>td.textContent);
        rows.push({promotor:tds[0], plaza:tds[1], promos:tds[2], tarifa:tds[3], total:tds[4]});
      });
      const csv = toCSV(rows, ['promotor','plaza','promos','tarifa','total']);
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='nomina_mada.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // ==============================
    // 🗂️ Activaciones recientes
    // ==============================
    const tbodyActivaciones=$('tbodyActivaciones');
    $('btnReloadActivaciones').addEventListener('click', loadActivaciones);

    function renderActivaciones(rows){
      tbodyActivaciones.innerHTML='';
      (rows||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-4">${r.fecha||'—'}</td>
          <td class="py-2 pr-4">${r.promotor||'—'}</td>
          <td class="py-2 pr-4">${r.plaza||'—'}</td>
          <td class="py-2 pr-4">${r.tipo||'—'}</td>
          <td class="py-2 pr-4 mono">${r.numero||'—'}</td>
          <td class="py-2 pr-4 mono">${last6(r.icc)||'—'}</td>
          <td class="py-2 pr-4">${r.monto!=null? ('$'+r.monto):'—'}</td>`;
        tbodyActivaciones.appendChild(tr);
      });
    }

    async function loadActivaciones(){
      try{
        const data = await sendToSheets({ type:'activaciones_recientes', limit:50 });
        renderActivaciones(data && Array.isArray(data.rows) ? data.rows : []);
      } catch{ renderActivaciones([]); }
    }

    // Exports (pedidos en utilidades)
    $('btnExportActivaciones').addEventListener('click', async ()=>{
      try{
        const data = await sendToSheets({ type:'export_activaciones' });
        const rows = data && Array.isArray(data.rows) ? data.rows : [];
        const csv = toCSV(rows, Object.keys(rows[0]||{fecha:'',promotor:'',plaza:'',tipo:'',numero:'',icc:'',monto:''}));
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='activaciones_mada.csv'; a.click(); URL.revokeObjectURL(url);
      } catch{ alert('No se pudo exportar'); }
    });
    $('btnExportAsignaciones').addEventListener('click', async ()=>{
      try{
        const data = await sendToSheets({ type:'export_asignaciones' });
        const rows = data && Array.isArray(data.rows) ? data.rows : [];
        const csv = toCSV(rows, Object.keys(rows[0]||{fecha:'',promotor:'',plaza:'',tipo:'',icc:''}));
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='asignaciones_mada.csv'; a.click(); URL.revokeObjectURL(url);
      } catch{ alert('No se pudo exportar'); }
    });

    // Notas (local)
    const NOTES_KEY='mada_supervisor_notas';
    const notaSupervisor=$('notaSupervisor');
    notaSupervisor.value = localStorage.getItem(NOTES_KEY)||'';
    notaSupervisor.addEventListener('input', ()=> localStorage.setItem(NOTES_KEY, notaSupervisor.value));

    // Cargas iniciales
    loadKPIs();
    loadActivaciones();
  </script>
</body>
</html>
