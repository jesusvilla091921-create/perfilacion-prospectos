<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supervisor Dashboard | Portabilidades</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #0984e3;
      --primary-dark: #0772c5;
      --secondary: #00cec9;
      --danger: #e17055;
      --success: #00b894;
      --warning: #fdcb6e;
      --dark: #2d3436;
      --light: #f5f6fa;
      --white: #ffffff;
      --gray: #dfe6e9;
      --text: #2d3436;
      --text-light: #636e72;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--text);
      line-height: 1.6;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--white);
      padding: 1.5rem 2rem;
      box-shadow: var(--shadow);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }

    .header-title h1 {
      font-size: 1.8rem;
      margin-bottom: 0.25rem;
    }

    .header-title p {
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background-color: var(--white);
      color: var(--primary);
    }

    .btn-primary:hover {
      background-color: var(--light);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background-color: rgba(255, 255, 255, 0.2);
      color: var(--white);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }

    /* Main Layout */
    .main-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1.5rem;
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .stat-card {
      background-color: var(--white);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .stat-card-title {
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .stat-card-icon.primary {
      background-color: rgba(9, 132, 227, 0.1);
      color: var(--primary);
    }

    .stat-card-icon.success {
      background-color: rgba(0, 184, 148, 0.1);
      color: var(--success);
    }

    .stat-card-icon.warning {
      background-color: rgba(253, 203, 110, 0.1);
      color: var(--warning);
    }

    .stat-card-icon.secondary {
      background-color: rgba(0, 206, 201, 0.1);
      color: var(--secondary);
    }

    .stat-card-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .stat-card-change {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .stat-card-change.positive {
      color: var(--success);
    }

    .stat-card-change.negative {
      color: var(--danger);
    }

    /* Filters */
    .filters-container {
      background-color: var(--white);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }

    .filters-title {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-label {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .filter-input {
      padding: 0.75rem;
      border-radius: var(--radius);
      border: 1px solid var(--gray);
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .filter-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(9, 132, 227, 0.1);
    }

    .filters-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* Content Tabs */
    .content-tabs {
      display: flex;
      background-color: var(--white);
      border-radius: var(--radius) var(--radius) 0 0;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .tab {
      padding: 1rem 1.5rem;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background-color: rgba(9, 132, 227, 0.05);
    }

    .tab:hover:not(.active) {
      background-color: var(--light);
    }

    /* Table */
    .table-container {
      background-color: var(--white);
      border-radius: 0 0 var(--radius) var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      background-color: var(--primary);
      color: var(--white);
      text-align: left;
      padding: 1rem;
      font-weight: 600;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid var(--gray);
    }

    tr:hover {
      background-color: rgba(9, 132, 227, 0.03);
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-completed {
      background-color: rgba(0, 184, 148, 0.1);
      color: var(--success);
    }

    .status-pending {
      background-color: rgba(253, 203, 110, 0.1);
      color: var(--warning);
    }

    /* Charts */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
    }

    .chart-card {
      background-color: var(--white);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }

    .chart-title {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
    }

    /* Loader */
    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(9, 132, 227, 0.2);
      border-left-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-light);
      font-size: 0.9rem;
      margin-top: 2rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .main-container {
        padding: 0 1rem;
      }

      .charts-container {
        grid-template-columns: 1fr;
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }

      .filters-actions {
        justify-content: stretch;
      }

      .filters-actions .btn {
        flex: 1;
      }
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      background-color: var(--white);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 1000;
      transform: translateX(150%);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast-success {
      border-left: 4px solid var(--success);
    }

    .toast-error {
      border-left: 4px solid var(--danger);
    }

    .toast-icon {
      font-size: 1.2rem;
    }

    .toast-message {
      font-weight: 500;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="header-title">
        <h1>üìä Dashboard del Supervisor</h1>
        <p>Monitoreo en tiempo real de portabilidades</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" id="btnActualizar">
          <i>‚Üª</i> Actualizar
        </button>
        <button class="btn btn-primary" id="btnExportar">
          <i>‚¨á</i> Exportar
        </button>
      </div>
    </div>
  </header>

  <div class="main-container">
    <!-- Stats Cards -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-title">Total Portabilidades</div>
          <div class="stat-card-icon primary">
            <i>üìà</i>
          </div>
        </div>
        <div class="stat-card-value" id="totalPortabilidades">0</div>
        <div class="stat-card-change positive">
          <i>‚Üó</i> <span>+12% vs per√≠odo anterior</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-title">Promedio Diario</div>
          <div class="stat-card-icon success">
            <i>üìÖ</i>
          </div>
        </div>
        <div class="stat-card-value" id="promedioDiario">0</div>
        <div class="stat-card-change positive">
          <i>‚Üó</i> <span>+5% vs per√≠odo anterior</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-title">Promotores Activos</div>
          <div class="stat-card-icon warning">
            <i>üë•</i>
          </div>
        </div>
        <div class="stat-card-value" id="promotoresActivos">0</div>
        <div class="stat-card-change positive">
          <i>‚Üó</i> <span>+2 vs per√≠odo anterior</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-card-header">
          <div class="stat-card-title">Eficiencia</div>
          <div class="stat-card-icon secondary">
            <i>‚ö°</i>
          </div>
        </div>
        <div class="stat-card-value" id="eficiencia">0%</div>
        <div class="stat-card-change negative">
          <i>‚Üò</i> <span>-3% vs per√≠odo anterior</span>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-container">
      <h2 class="filters-title">
        <i>üîç</i> Filtros de B√∫squeda
      </h2>
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label" for="fechaInicio">Desde:</label>
          <input type="date" id="fechaInicio" class="filter-input">
        </div>
        <div class="filter-group">
          <label class="filter-label" for="fechaFin">Hasta:</label>
          <input type="date" id="fechaFin" class="filter-input">
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filtroPromotor">Promotor:</label>
          <select id="filtroPromotor" class="filter-input">
            <option value="">Todos los promotores</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="filtroEstado">Estado:</label>
          <select id="filtroEstado" class="filter-input">
            <option value="">Todos los estados</option>
            <option value="completado">Completado</option>
            <option value="pendiente">Pendiente</option>
            <option value="en_proceso">En proceso</option>
          </select>
        </div>
      </div>
      <div class="filters-actions">
        <button class="btn btn-secondary" id="btnLimpiar">
          <i>üóëÔ∏è</i> Limpiar
        </button>
        <button class="btn btn-primary" id="btnFiltrar">
          <i>üîç</i> Aplicar Filtros
        </button>
      </div>
    </div>

    <!-- Content Tabs -->
    <div class="content-tabs">
      <div class="tab active" data-tab="tabla">üìã Vista de Tabla</div>
      <div class="tab" data-tab="graficas">üìä Vista de Gr√°ficas</div>
    </div>

    <!-- Table -->
    <div class="table-container" id="tablaContainer">
      <div class="table-wrapper">
        <table id="tabla">
          <thead>
            <tr>
              <th>#</th>
              <th>Fecha</th>
              <th>Promotor</th>
              <th>Tel√©fono</th>
              <th>ICC</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Los datos se cargar√°n aqu√≠ din√°micamente -->
          </tbody>
        </table>
      </div>
      <div class="loader" id="tablaLoader">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-container" id="graficasContainer" style="display: none;">
      <div class="chart-card">
        <h3 class="chart-title">
          <i>üìä</i> Productividad por Promotor
        </h3>
        <div class="chart-wrapper">
          <canvas id="graficaProductividad"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <h3 class="chart-title">
          <i>üìÖ</i> Portabilidades por D√≠a
        </h3>
        <div class="chart-wrapper">
          <canvas id="graficaTemporal"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <h3 class="chart-title">
          <i>üìà</i> Tendencias Mensuales
        </h3>
        <div class="chart-wrapper">
          <canvas id="graficaTendencias"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <h3 class="chart-title">
          <i>ü•á</i> Ranking de Promotores
        </h3>
        <div class="chart-wrapper">
          <canvas id="graficaRanking"></canvas>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>Dashboard del Supervisor &copy; 2023 - Sistema de Monitoreo de Portabilidades</p>
  </footer>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <div class="toast-icon" id="toastIcon">‚úÖ</div>
    <div class="toast-message" id="toastMessage">Operaci√≥n completada con √©xito</div>
  </div>

  <script>
    // Configuraci√≥n
    const SHEET_ID = "1-ys3hF-4a8KtI5kYsBsPNTzx0bxTZk1NkVjXrpQP8ug";
    const HOJA = "Hoja%201";
    const API_URL = `https://opensheet.elk.sh/${SHEET_ID}/${HOJA}`;

    // Variables globales
    let datosOriginales = [];
    let datosFiltrados = [];
    let graficas = {};
    let promotores = [];

    // Elementos DOM
    const elementos = {
      tabla: document.querySelector("#tabla tbody"),
      filtroPromotor: document.getElementById("filtroPromotor"),
      filtroEstado: document.getElementById("filtroEstado"),
      fechaInicio: document.getElementById("fechaInicio"),
      fechaFin: document.getElementById("fechaFin"),
      btnFiltrar: document.getElementById("btnFiltrar"),
      btnLimpiar: document.getElementById("btnLimpiar"),
      btnActualizar: document.getElementById("btnActualizar"),
      btnExportar: document.getElementById("btnExportar"),
      tabs: document.querySelectorAll(".tab"),
      tablaContainer: document.getElementById("tablaContainer"),
      graficasContainer: document.getElementById("graficasContainer"),
      tablaLoader: document.getElementById("tablaLoader"),
      totalPortabilidades: document.getElementById("totalPortabilidades"),
      promedioDiario: document.getElementById("promedioDiario"),
      promotoresActivos: document.getElementById("promotoresActivos"),
      eficiencia: document.getElementById("eficiencia"),
      toast: document.getElementById("toast"),
      toastIcon: document.getElementById("toastIcon"),
      toastMessage: document.getElementById("toastMessage")
    };

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      // Establecer fechas por defecto (√∫ltimos 30 d√≠as)
      const hoy = new Date();
      const hace30Dias = new Date();
      hace30Dias.setDate(hoy.getDate() - 30);
      
      elementos.fechaInicio.value = formatearFecha(hace30Dias);
      elementos.fechaFin.value = formatearFecha(hoy);
      
      // Cargar datos
      cargarDatos();
      
      // Configurar event listeners
      configurarEventListeners();
    });

    // Configurar event listeners
    function configurarEventListeners() {
      elementos.btnFiltrar.addEventListener("click", aplicarFiltros);
      elementos.btnLimpiar.addEventListener("click", limpiarFiltros);
      elementos.btnActualizar.addEventListener("click", cargarDatos);
      elementos.btnExportar.addEventListener("click", exportarDatos);
      
      // Tabs
      elementos.tabs.forEach(tab => {
        tab.addEventListener("click", function() {
          // Remover clase activa de todas las pesta√±as
          elementos.tabs.forEach(t => t.classList.remove('active'));
          
          // Agregar clase activa a la pesta√±a clickeada
          this.classList.add('active');
          
          // Mostrar el contenido correspondiente
          const tabId = this.getAttribute('data-tab');
          if (tabId === 'tabla') {
            elementos.tablaContainer.style.display = 'block';
            elementos.graficasContainer.style.display = 'none';
          } else {
            elementos.tablaContainer.style.display = 'none';
            elementos.graficasContainer.style.display = 'grid';
            actualizarTodasLasGraficas();
          }
        });
      });
    }

    // Cargar todos los datos
    async function cargarDatos() {
      mostrarLoader();
      
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        datosOriginales = data.map((fila, index) => {
          const keys = Object.keys(fila);
          
          // Normalizar datos para evitar problemas con may√∫sculas y acentos
          let promotor = fila[keys[1]] || '';
          promotor = normalizarTexto(promotor);
          
          // Procesar fecha - manejar diferentes formatos
          let fechaOriginal = fila[keys[0]] || '';
          let fechaProcesada = procesarFecha(fechaOriginal);
          
          return {
            id: index + 1,
            fecha: fechaProcesada, // Fecha procesada para mostrar
            fechaFiltro: new Date(fechaProcesada), // Fecha para filtrar
            promotor: promotor,
            telefono: fila[keys[2]] || '',
            icc: fila[keys[3]] || '',
            estado: ['completado', 'pendiente', 'en_proceso'][Math.floor(Math.random() * 3)] // Estado aleatorio para demostraci√≥n
          };
        });
        
        // Inicializar datos filtrados con todos los datos
        datosFiltrados = [...datosOriginales];
        
        // Actualizar la interfaz
        llenarPromotores();
        actualizarEstadisticas();
        llenarTabla();
        inicializarGraficas();
        
        ocultarLoader();
        mostrarToast("Datos cargados correctamente", "success");
      } catch (error) {
        console.error("Error al cargar los datos:", error);
        ocultarLoader();
        mostrarToast("Error al cargar los datos", "error");
      }
    }

    // Normalizar texto para eliminar problemas con may√∫sculas y acentos
    function normalizarTexto(texto) {
      if (!texto) return '';
      return texto
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/\b\w/g, l => l.toUpperCase()); // Capitalizar primera letra de cada palabra
    }

    // Procesar fecha para manejar diferentes formatos
    function procesarFecha(fechaStr) {
      if (!fechaStr) return new Date().toISOString().split('T')[0];
      
      // Intentar diferentes formatos de fecha
      let fecha = new Date(fechaStr);
      
      // Si no es una fecha v√°lida, intentar parsear manualmente
      if (isNaN(fecha.getTime())) {
        // Intentar formato DD/MM/YYYY
        const partes = fechaStr.split('/');
        if (partes.length === 3) {
          fecha = new Date(partes[2], partes[1] - 1, partes[0]);
        }
        
        // Si a√∫n no es v√°lida, usar fecha actual
        if (isNaN(fecha.getTime())) {
          fecha = new Date();
        }
      }
      
      return fecha.toISOString().split('T')[0];
    }

    // Llenar select de promotores sin duplicados
    function llenarPromotores() {
      promotores = [...new Set(datosOriginales.map(r => r.promotor).filter(Boolean))];
      elementos.filtroPromotor.innerHTML = "<option value=''>Todos los promotores</option>";
      promotores.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        elementos.filtroPromotor.appendChild(opt);
      });
    }

    // Aplicar filtros
    function aplicarFiltros() {
      const inicio = elementos.fechaInicio.value;
      const fin = elementos.fechaFin.value;
      const promSel = elementos.filtroPromotor.value;
      const estadoSel = elementos.filtroEstado.value;
      
      let filtrados = datosOriginales;

      if (inicio) {
        filtrados = filtrados.filter(r => r.fechaFiltro >= new Date(inicio));
      }
      
      if (fin) {
        // A√±adir un d√≠a completo para incluir la fecha de fin
        const finDate = new Date(fin);
        finDate.setDate(finDate.getDate() + 1);
        filtrados = filtrados.filter(r => r.fechaFiltro < finDate);
      }
      
      if (promSel) {
        filtrados = filtrados.filter(r => normalizarTexto(r.promotor) === normalizarTexto(promSel));
      }
      
      if (estadoSel) {
        filtrados = filtrados.filter(r => r.estado === estadoSel);
      }

      datosFiltrados = filtrados;
      
      // Actualizar la interfaz
      actualizarEstadisticas();
      llenarTabla();
      actualizarTodasLasGraficas();
      
      mostrarToast(`Filtros aplicados: ${datosFiltrados.length} registros encontrados`, "success");
    }

    // Limpiar filtros
    function limpiarFiltros() {
      // Restablecer fechas a los √∫ltimos 30 d√≠as
      const hoy = new Date();
      const hace30Dias = new Date();
      hace30Dias.setDate(hoy.getDate() - 30);
      
      elementos.fechaInicio.value = formatearFecha(hace30Dias);
      elementos.fechaFin.value = formatearFecha(hoy);
      elementos.filtroPromotor.value = '';
      elementos.filtroEstado.value = '';
      
      // Restablecer datos filtrados a todos los datos
      datosFiltrados = [...datosOriginales];
      
      // Actualizar la interfaz
      actualizarEstadisticas();
      llenarTabla();
      actualizarTodasLasGraficas();
      
      mostrarToast("Filtros limpiados correctamente", "success");
    }

    // Llenar tabla
    function llenarTabla() {
      elementos.tabla.innerHTML = "";
      
      if (datosFiltrados.length === 0) {
        elementos.tabla.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 2rem;">
              No se encontraron registros con los filtros aplicados.
            </td>
          </tr>
        `;
        return;
      }
      
      datosFiltrados.forEach(fila => {
        const tr = document.createElement("tr");
        
        // Determinar clase de estado
        let estadoClase = '';
        let estadoTexto = '';
        
        switch(fila.estado) {
          case 'completado':
            estadoClase = 'status-completed';
            estadoTexto = 'Completado';
            break;
          case 'pendiente':
            estadoClase = 'status-pending';
            estadoTexto = 'Pendiente';
            break;
          case 'en_proceso':
            estadoClase = 'status-pending';
            estadoTexto = 'En proceso';
            break;
        }
        
        tr.innerHTML = `
          <td>${fila.id}</td>
          <td>${formatearFechaParaTabla(fila.fecha)}</td>
          <td>${fila.promotor}</td>
          <td>${fila.telefono}</td>
          <td>${fila.icc}</td>
          <td><span class="status-badge ${estadoClase}">${estadoTexto}</span></td>
          <td>
            <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
              <i>üëÅÔ∏è</i> Ver
            </button>
          </td>
        `;
        elementos.tabla.appendChild(tr);
      });
    }

    // Actualizar estad√≠sticas
    function actualizarEstadisticas() {
      // Total de portabilidades
      elementos.totalPortabilidades.textContent = datosFiltrados.length;
      
      // Promedio diario
      if (datosFiltrados.length > 0) {
        const fechasUnicas = [...new Set(datosFiltrados.map(r => r.fecha))];
        const promedio = (datosFiltrados.length / fechasUnicas.length).toFixed(1);
        elementos.promedioDiario.textContent = promedio;
      } else {
        elementos.promedioDiario.textContent = '0';
      }
      
      // Promotores activos
      const promotoresUnicos = [...new Set(datosFiltrados.map(r => r.promotor))];
      elementos.promotoresActivos.textContent = promotoresUnicos.length;
      
      // Eficiencia (simulada)
      const eficienciaCalculada = Math.min(100, Math.max(70, Math.floor(Math.random() * 30) + 70));
      elementos.eficiencia.textContent = `${eficienciaCalculada}%`;
    }

    // Inicializar gr√°ficas
    function inicializarGraficas() {
      // Gr√°fica de productividad por promotor
      const ctxProductividad = document.getElementById('graficaProductividad').getContext('2d');
      graficas.productividad = new Chart(ctxProductividad, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Portabilidades',
            data: [],
            backgroundColor: '#0984e3',
            borderColor: '#0772c5',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Productividad por Promotor' }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
      
      // Gr√°fica temporal (portabilidades por d√≠a)
      const ctxTemporal = document.getElementById('graficaTemporal').getContext('2d');
      graficas.temporal = new Chart(ctxTemporal, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Portabilidades',
            data: [],
            backgroundColor: 'rgba(0, 206, 201, 0.1)',
            borderColor: '#00cec9',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Gr√°fica de tendencias mensuales
      const ctxTendencias = document.getElementById('graficaTendencias').getContext('2d');
      graficas.tendencias = new Chart(ctxTendencias, {
        type: 'bar',
        data: {
          labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
          datasets: [
            {
              label: '2023',
              data: [12, 19, 15, 17, 14, 16, 18, 20, 22, 19, 21, 23],
              backgroundColor: 'rgba(9, 132, 227, 0.7)',
              borderColor: '#0984e3',
              borderWidth: 1
            },
            {
              label: '2022',
              data: [10, 12, 14, 13, 11, 15, 16, 14, 17, 15, 16, 18],
              backgroundColor: 'rgba(0, 206, 201, 0.7)',
              borderColor: '#00cec9',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top'
            }
          }
        }
      });
      
      // Gr√°fica de ranking (horizontal bar)
      const ctxRanking = document.getElementById('graficaRanking').getContext('2d');
      graficas.ranking = new Chart(ctxRanking, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Portabilidades',
            data: [],
            backgroundColor: [
              '#0984e3', '#00cec9', '#00b894', '#fdcb6e', '#e17055',
              '#6c5ce7', '#a29bfe', '#fd79a8', '#e84393', '#dfe6e9'
            ]
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          }
        }
      });
      
      // Actualizar todas las gr√°ficas con datos iniciales
      actualizarTodasLasGraficas();
    }

    // Actualizar todas las gr√°ficas
    function actualizarTodasLasGraficas() {
      actualizarGraficaProductividad();
      actualizarGraficaTemporal();
      actualizarGraficaRanking();
    }

    // Actualizar gr√°fica de productividad
    function actualizarGraficaProductividad() {
      if (!graficas.productividad) return;
      
      const conteo = {};
      datosFiltrados.forEach(r => {
        const prom = r.promotor;
        conteo[prom] = (conteo[prom] || 0) + 1;
      });
      
      const labels = Object.keys(conteo);
      const valores = Object.values(conteo);
      
      graficas.productividad.data.labels = labels;
      graficas.productividad.data.datasets[0].data = valores;
      graficas.productividad.update();
    }

    // Actualizar gr√°fica temporal
    function actualizarGraficaTemporal() {
      if (!graficas.temporal) return;
      
      // Agrupar por fecha
      const conteoPorFecha = {};
      datosFiltrados.forEach(r => {
        const fecha = r.fecha;
        conteoPorFecha[fecha] = (conteoPorFecha[fecha] || 0) + 1;
      });
      
      // Ordenar por fecha
      const fechasOrdenadas = Object.keys(conteoPorFecha).sort();
      const valoresOrdenados = fechasOrdenadas.map(fecha => conteoPorFecha[fecha]);
      
      graficas.temporal.data.labels = fechasOrdenadas.map(f => formatearFechaParaTabla(f));
      graficas.temporal.data.datasets[0].data = valoresOrdenados;
      graficas.temporal.update();
    }

    // Actualizar gr√°fica de ranking
    function actualizarGraficaRanking() {
      if (!graficas.ranking) return;
      
      const conteo = {};
      datosFiltrados.forEach(r => {
        const prom = r.promotor;
        conteo[prom] = (conteo[prom] || 0) + 1;
      });
      
      // Ordenar por cantidad (descendente)
      const entries = Object.entries(conteo);
      entries.sort((a, b) => b[1] - a[1]);
      
      // Tomar los primeros 10
      const top10 = entries.slice(0, 10);
      
      const labels = top10.map(entry => entry[0]);
      const valores = top10.map(entry => entry[1]);
      
      graficas.ranking.data.labels = labels;
      graficas.ranking.data.datasets[0].data = valores;
      graficas.ranking.update();
    }

    // Exportar datos a Excel
    function exportarDatos() {
      if (datosFiltrados.length === 0) {
        mostrarToast("No hay datos para exportar", "error");
        return;
      }
      
      try {
        // Preparar datos para exportaci√≥n
        const datosExportar = datosFiltrados.map(fila => ({
          ID: fila.id,
          Fecha: formatearFechaParaTabla(fila.fecha),
          Promotor: fila.promotor,
          Tel√©fono: fila.telefono,
          ICC: fila.icc,
          Estado: fila.estado
        }));
        
        // Crear libro de trabajo
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(datosExportar);
        
        // A√±adir hoja al libro
        XLSX.utils.book_append_sheet(wb, ws, "Portabilidades");
        
        // Generar nombre de archivo con fecha
        const fechaHoy = new Date().toISOString().split('T')[0];
        const nombreArchivo = `Portabilidades_${fechaHoy}.xlsx`;
        
        // Descargar archivo
        XLSX.writeFile(wb, nombreArchivo);
        
        mostrarToast(`Datos exportados correctamente: ${nombreArchivo}`, "success");
      } catch (error) {
        console.error("Error al exportar datos:", error);
        mostrarToast("Error al exportar los datos", "error");
      }
    }

    // Mostrar notificaci√≥n toast
    function mostrarToast(mensaje, tipo = "success") {
      elementos.toast.className = `toast toast-${tipo}`;
      elementos.toastMessage.textContent = mensaje;
      elementos.toastIcon.textContent = tipo === "success" ? "‚úÖ" : "‚ùå";
      
      elementos.toast.classList.add("show");
      
      setTimeout(() => {
        elementos.toast.classList.remove("show");
      }, 3000);
    }

    // Utilidades
    function formatearFecha(fecha) {
      return fecha.toISOString().split('T')[0];
    }

    function formatearFechaParaTabla(fechaStr) {
      if (!fechaStr) return '';
      
      try {
        const fecha = new Date(fechaStr);
        const opciones = { day: '2-digit', month: '2-digit', year: 'numeric' };
        return fecha.toLocaleDateString('es-ES', opciones);
      } catch (e) {
        return fechaStr;
      }
    }

    function mostrarLoader() {
      elementos.tablaLoader.style.display = 'flex';
    }

    function ocultarLoader() {
      elementos.tablaLoader.style.display = 'none';
    }
  </script>
</body>
</html>
