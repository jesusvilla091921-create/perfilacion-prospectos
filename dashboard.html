<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MADA OCR â€“ Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0b1220;--card:#111827;--muted:#94a3b8;--accent:#3b82f6}
    *{box-sizing:border-box;font-family:Poppins,system-ui,Segoe UI,Roboto}
    body{margin:0;background:var(--bg);color:#e5e7eb}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:18px;padding:18px}
    h1{font-size:22px;margin:0 0 12px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .grow{flex:1 1 260px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #273142;background:#0f172a;color:#fff}
    button{background:var(--accent);border-color:transparent;font-weight:600;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px 10px;border-bottom:1px solid #1f2937;font-size:13px}
    th{color:#94a3b8;text-align:left}
    .kpi{display:flex;gap:16px}
    .kpi>div{flex:1 1 0;background:#0e1526;border-radius:16px;padding:14px;border:1px solid #1f2937}
    .num{font-size:22px;font-weight:700}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ðŸ“Š Dashboard â€“ Centro de Control</h1>
    <div class="row">
      <div class="grow"><label>Rango inicial</label><input type="date" id="start"></div>
      <div class="grow"><label>Rango final</label><input type="date" id="end"></div>
      <div class="grow"><label>Promotor</label><select id="promotor"><option value="">Todos</option></select></div>
      <div class="grow"><label>Estado</label><select id="estado"><option value="">Todos</option><option>LISTO</option><option>PENDIENTE</option></select></div>
      <div class="grow"><label>&nbsp;</label><button id="refresh">Actualizar</button></div>
    </div>

    <div class="kpi" style="margin-top:14px">
      <div><div>Total portabilidades</div><div id="k_total" class="num">0</div></div>
      <div><div>Promedio diario</div><div id="k_avg" class="num">0</div></div>
      <div><div>Eficiencia (%)</div><div id="k_eff" class="num">0</div></div>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="grow card" style="background:#0e1526"><canvas id="chartBars"></canvas></div>
      <div class="grow card" style="background:#0e1526"><canvas id="chartPie"></canvas></div>
    </div>

    <div class="card" style="margin-top:14px;background:#0e1526">
      <table id="tbl">
        <thead><tr><th>Fecha</th><th>Promotor</th><th>TelÃ©fono</th><th>ICC</th><th>Estado</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby8y9CUxIR3MCtAe5kY-69v2OVNFmUb_RNx36Lf3b1THHe9livhxUXK7ORPof7AqWV2/exec?action=list';
let raw = [];

async function fetchData(){
  try {
    const res = await fetch(WEBAPP_URL);
    const json = await res.json();
    raw = json.rows || [];
    hydrateFilters(raw);
    render();
  } catch (e) {
    alert("Error al cargar datos: " + e.message);
  }
}

function hydrateFilters(rows){
  const sel = document.getElementById('promotor');
  const set = new Set(rows.map(r=>r.Promotor).filter(Boolean));
  sel.innerHTML = '<option value=\"\">Todos</option>' + [...set].sort().map(p=>`<option>${p}</option>`).join('');
}

function applyFilters(){
  const s = document.getElementById('start').value;
  const e = document.getElementById('end').value;
  const p = document.getElementById('promotor').value;
  const est = document.getElementById('estado').value;
  return raw.filter(r=>{
    const d = r.Fecha.slice(0,10);
    if(s && d < s) return false;
    if(e && d > e) return false;
    if(p && r.Promotor!==p) return false;
    if(est && r.Estado!==est) return false;
    return true;
  });
}

function render(){
  const rows = applyFilters();
  const total = rows.length;
  const byDate = {};
  let listo = 0;
  rows.forEach(r=>{
    const d=r.Fecha.slice(0,10);
    byDate[d]=(byDate[d]||0)+1;
    if(r.Estado==='LISTO') listo++;
  });
  const days = Object.keys(byDate).length || 1;
  const avg = (total/days).toFixed(1);
  const eff = total? Math.round((listo/total)*100) : 0;
  document.getElementById('k_total').textContent = total;
  document.getElementById('k_avg').textContent = avg;
  document.getElementById('k_eff').textContent = eff;

  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = rows.map(r=>`<tr><td>${r.Fecha}</td><td>${r.Promotor}</td><td>${r.Telefono}</td><td>${r.ICC}</td><td>${r.Estado}</td></tr>`).join('');

  drawBars(Object.keys(byDate), Object.values(byDate));
  drawPie(listo, total-listo);
}

let bars, pie;
function drawBars(labels, data){
  const ctx = document.getElementById('chartBars');
  if(bars) bars.destroy();
  bars = new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[{label:'TrÃ¡mites por dÃ­a',data,backgroundColor:'#3b82f6'}]},
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
}
function drawPie(listo,pend){
  const ctx = document.getElementById('chartPie');
  if(pie) pie.destroy();
  pie = new Chart(ctx,{
    type:'pie',
    data:{labels:['LISTO','PENDIENTE'],datasets:[{data:[listo,pend],backgroundColor:['#10b981','#ef4444']}]},
    options:{responsive:true}
  });
}

document.getElementById('refresh').addEventListener('click', render);
fetchData();
</script>
</body>
</html>
